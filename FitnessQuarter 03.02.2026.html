<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fitness –ö–≤–∞—Ä—Ç–∞–ª</title>
    
    <!-- Telegram Web App -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        cyan: { 50: '#ecfeff', 100: '#cffafe', 200: '#a5f3fc', 300: '#67e8f9', 400: '#22d3ee', 500: '#06b6d4', 600: '#0891b2', 700: '#0e7490', 800: '#155e75', 900: '#164e63' },
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        display: ['Space Grotesk', 'sans-serif'],
                    },
                    animation: {
                        'shine': 'shine 1.5s infinite',
                        'float': 'float 3s ease-in-out infinite',
                        'fade-in': 'fadeIn 0.5s ease-out',
                        'slide-up': 'slideUp 0.5s ease-out',
                    },
                    keyframes: {
                        shine: { '0%': { transform: 'translateX(-100%)' }, '100%': { transform: 'translateX(100%)' } },
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } },
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
                    }
                }
            }
        }
    </script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">

    <!-- React & ReactDOM & Babel & Lucide -->
    <script type="importmap">
        {
            "imports": {
                "react": "https://esm.sh/react@18.2.0",
                "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
                "lucide-react": "https://esm.sh/lucide-react@0.263.1"
            }
        }
    </script>
    
    <!-- Babel Standalone -->
    <script src="https://unpkg.com/@babel/standalone@7.26.9/babel.min.js"></script>
    
    <!-- Babel Config: Disable CJS transformation to fix 'require is not defined' -->
    <script>
        window.Babel = {
            presets: [
                ['env', { modules: false }],
                'react'
            ]
        };
    </script>

    <style>
        body { 
            background-color: #f8fafc; 
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none; /* Prevent pull-to-refresh on mobile */
        }
        .bg-stripe-danger {
            background-image: repeating-linear-gradient(45deg, rgba(244, 63, 94, 0.05), rgba(244, 63, 94, 0.05) 10px, transparent 10px, transparent 20px);
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- Main App Script -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Trophy, Diamond, Zap, Camera, CheckCircle, Activity, User, Settings, Plus, X, 
            Hexagon, Flame, Send, Bell, AlertTriangle, Skull, Dumbbell, Timer, Ruler, 
            BarChart3, Users, Calendar, Award, ChevronRight, Siren, FileWarning, UploadCloud, 
            RefreshCw, Sun, Moon, Heart, Star, ChevronDown, ChevronUp, Shield, Download, Edit3, Save, Trash2 
        } from 'lucide-react';

        // --- COMPONENTS ---

        const GlassCard = ({ children, className = "", onClick }) => (
            <div onClick={onClick} className={`relative bg-white/60 backdrop-blur-xl border border-white/60 shadow-[0_8px_30px_rgb(0,0,0,0.04)] rounded-2xl overflow-hidden ${onClick ? 'cursor-pointer active:scale-95 transition-transform' : ''} ${className}`}>
                <div className="absolute -top-1/2 -left-1/2 w-[200%] h-[200%] bg-gradient-to-br from-transparent via-white/40 to-transparent opacity-0 hover:opacity-100 transition-opacity duration-700 pointer-events-none transform rotate-12"></div>
                {children}
            </div>
        );

        const NeonButton = ({ children, onClick, variant = 'primary', disabled = false, className = "" }) => {
            const baseStyle = "w-full py-4 font-display font-bold tracking-wider uppercase transition-all active:scale-95 flex items-center justify-center gap-2 relative overflow-hidden group rounded-xl";
            const variants = {
                primary: "bg-cyan-500 text-white shadow-[0_4px_20px_rgba(6,182,212,0.3)] hover:shadow-[0_4px_25px_rgba(6,182,212,0.4)] hover:-translate-y-0.5 border border-cyan-400/20",
                danger: "bg-rose-500 text-white shadow-[0_4px_20px_rgba(244,63,94,0.3)] hover:shadow-[0_4px_25px_rgba(244,63,94,0.4)] hover:-translate-y-0.5 border border-rose-400/20",
                success: "bg-emerald-500 text-white shadow-[0_4px_20px_rgba(16,185,129,0.3)] hover:shadow-[0_4px_25px_rgba(16,185,129,0.4)] hover:-translate-y-0.5 border border-emerald-400/20",
                gold: "bg-amber-500 text-white shadow-[0_4px_20px_rgba(245,158,11,0.3)] hover:shadow-[0_4px_25px_rgba(245,158,11,0.4)] hover:-translate-y-0.5 border border-amber-400/20",
                secondary: "bg-slate-100 text-slate-600 border border-slate-200 hover:bg-slate-200",
                disabled: "bg-slate-200 text-slate-400 cursor-not-allowed shadow-none"
            };
            return (
                <button onClick={onClick} disabled={disabled} className={`${baseStyle} ${disabled ? variants.disabled : variants[variant]} ${className}`}>
                    <div className="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent -translate-x-full group-hover:animate-shine"></div>
                    {children}
                </button>
            );
        };

        const ToggleSwitch = ({ checked, onChange }) => (
            <button onClick={() => onChange(!checked)} className={`w-12 h-6 rounded-full p-1 transition-colors duration-300 relative ${checked ? 'bg-cyan-500' : 'bg-slate-300'}`}>
                <div className={`w-4 h-4 rounded-full bg-white shadow-sm transition-transform duration-300 ${checked ? 'translate-x-6' : 'translate-x-0'}`} />
            </button>
        );

        const Avatar = ({ name, className = "" }) => {
            const initials = name ? name.slice(0, 2).toUpperCase() : "FQ";
            const gradients = ["from-pink-400 to-rose-500", "from-cyan-400 to-blue-500", "from-emerald-400 to-green-500", "from-violet-400 to-purple-500", "from-amber-400 to-orange-500"];
            const colorIndex = name ? name.length % gradients.length : 0;
            return (
                <div className={`rounded-full bg-gradient-to-br ${gradients[colorIndex]} flex items-center justify-center text-white font-bold font-display shadow-sm ${className}`}>
                    {initials}
                </div>
            );
        };

        // --- MAIN APP ---

        function App() {
            // Telegram Integration
            useEffect(() => {
                if (window.Telegram && window.Telegram.WebApp) {
                    window.Telegram.WebApp.ready();
                    window.Telegram.WebApp.expand();
                    
                    // Auto-fill name from Telegram
                    const tgUser = window.Telegram.WebApp.initDataUnsafe?.user;
                    if (tgUser) {
                        setUser(u => ({ ...u, name: tgUser.first_name }));
                    }
                }
            }, []);

            // --- State ---
            const [step, setStep] = useState('welcome');
            const [user, setUser] = useState({
                name: '–ì–æ—Å—Ç—å',
                disciplines: [],
                goal: 0,
                diamonds: 3,
                streak: 3,
                todayActivity: [],
                history: [
                    { date: new Date().toISOString(), sport: '–ë–µ–≥', type: 'cardio', value: 5, unit: '–∫–º' },
                    { date: new Date(Date.now() - 86400000).toISOString(), sport: '–ó–∞–ª', type: 'gym', value: '–í–µ—Ä—Ö', unit: null },
                    { date: new Date(Date.now() - 172800000).toISOString(), sport: '–û—Ç–∂–∏–º–∞–Ω–∏—è', type: 'reps', value: 100, unit: '–ø–æ–≤—Ç' },
                ],
                status: 'active',
                notifications: true,
                isAdmin: true // Default admin for demo
            });

            const [checkInModalOpen, setCheckInModalOpen] = useState(false);
            const [checkInStage, setCheckInStage] = useState('select');
            const [selectedSportForCheckIn, setSelectedSportForCheckIn] = useState(null);
            const [checkInValue, setCheckInValue] = useState("");
            const [editingProfile, setEditingProfile] = useState(false);
            const [adminPanelOpen, setAdminPanelOpen] = useState(false);
            const [selectedUser, setSelectedUser] = useState(null);

            const [leaderboard, setLeaderboard] = useState([
                { id: 1, name: '–ê–ª–µ–∫—Å–∞–Ω–¥—Ä', diamonds: 3, streak: 12, goal: 100, status: 'active', disciplines: ['–ë–µ–≥', '–í–æ—Ä–∫–∞—É—Ç'], history: [], badges: ['streak', 'runner'] },
                { id: 2, name: '–ï–ª–µ–Ω–∞', diamonds: 5, streak: 45, goal: 60, status: 'active', disciplines: ['–ó–∞–ª', '–ü–ª–∞–≤–∞–Ω–∏–µ'], history: [], badges: ['gym', 'reps', 'early'] },
                { id: 3, name: '–ú–∞–∫—Å', diamonds: 0, streak: 8, goal: 30, status: 'frozen', disciplines: ['–ë–æ–∫—Å'], history: [], badges: [] },
                { id: 4, name: '–ò–≥–æ—Ä—å', diamonds: 2, streak: 89, goal: 100, status: 'active', disciplines: ['–í–µ–ª–æ', '–û—Ç–∂–∏–º–∞–Ω–∏—è'], history: [], badges: ['runner', 'reps', 'social', 'streak'] },
            ]);

            const [popularSports, setPopularSports] = useState(['–ë–µ–≥', '–ó–∞–ª', '–û—Ç–∂–∏–º–∞–Ω–∏—è', '–ü–ª–∞–≤–∞–Ω–∏–µ', '–í–æ—Ä–∫–∞—É—Ç', '–í–µ–ª–æ', '–ü—Ä–∏—Å–µ–¥–∞–Ω–∏—è', '–•–æ–¥—å–±–∞']);

            // --- Helpers ---
            const toggleDiscipline = (sport) => {
                if (user.disciplines.includes(sport)) {
                    setUser({ ...user, disciplines: user.disciplines.filter(d => d !== sport) });
                } else {
                    if (user.disciplines.length < 5) {
                        setUser({ ...user, disciplines: [...user.disciplines, sport] });
                    }
                }
            };

            const handleGoalSelect = (days) => {
                setUser({ ...user, goal: days });
                setStep('dashboard');
            };

            const isCheckedIn = user.todayActivity.length > 0;

            const getSportType = (sport) => {
                const s = sport.toLowerCase();
                if (['–±–µ–≥', '—Ö–æ–¥—å–±–∞', '–ø–ª–∞–≤–∞–Ω–∏–µ', '–≤–µ–ª–æ', '–ª—ã–∂–∏'].some(x => s.includes(x))) return 'cardio';
                if (['–∑–∞–ª', '–∫–∞—á–∞–ª–∫–∞', 'gym'].some(x => s.includes(x))) return 'gym';
                if (['–≤–æ—Ä–∫–∞—É—Ç', '–æ—Ç–∂–∏–º–∞–Ω–∏—è', '–ø—Ä–∏—Å–µ–¥–∞–Ω–∏—è', '–ø—Ä–µ—Å—Å', '–ø–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è'].some(x => s.includes(x))) return 'reps';
                return 'other';
            };

            const getStatsSummary = (history = []) => {
                let totalKm = 0;
                let totalReps = 0;
                let gymSessions = { '–í–µ—Ä—Ö': 0, '–ù–∏–∑': 0, '–í—Å—ë —Ç–µ–ª–æ': 0, '–ì–æ–ª–æ–≤–∞': 0 };
                history.forEach(entry => {
                    if (entry.type === 'cardio' && entry.value) totalKm += parseFloat(entry.value);
                    if (entry.type === 'reps' && entry.value) totalReps += parseInt(entry.value);
                    if (entry.type === 'gym' && entry.value && gymSessions[entry.value] !== undefined) {
                        gymSessions[entry.value]++;
                    }
                });
                const totalGym = Object.values(gymSessions).reduce((a, b) => a + b, 0);
                return { totalKm, totalReps, gymSessions, totalGym };
            };

            const getUserTitle = (goal) => {
                if (goal >= 100) return '–ö–∏–±–æ—Ä–≥';
                if (goal >= 60) return '–ê—Ç–ª–µ—Ç';
                return '–ù–æ–≤–∏—á–æ–∫';
            };

            // --- Handlers ---
            const initCheckIn = (sport) => {
                setSelectedSportForCheckIn(sport);
                const type = getSportType(sport);
                if (type === 'other') {
                    completeCheckIn(sport, null, null);
                } else {
                    setCheckInStage('details');
                    setCheckInValue("");
                }
            };

            const completeCheckIn = (sport, value, unit) => {
                const type = getSportType(sport);
                setUser(prev => {
                    const isFirstCheckIn = prev.todayActivity.length === 0;
                    const newHistoryItem = { date: new Date().toISOString(), sport, type, value, unit };
                    return {
                        ...prev,
                        streak: isFirstCheckIn ? prev.streak + 1 : prev.streak,
                        diamonds: isFirstCheckIn ? prev.diamonds : prev.diamonds,
                        todayActivity: [...prev.todayActivity, sport],
                        history: [newHistoryItem, ...prev.history]
                    };
                });
                setCheckInModalOpen(false);
                setCheckInStage('select');
                setSelectedSportForCheckIn(null);
                setCheckInValue("");
            };

            const handleAdminUpdateUser = (updatedUser) => {
                setLeaderboard(prev => prev.map(u => u.id === updatedUser.id ? updatedUser : u));
            };

            const handleExportData = () => {
                const headers = ["ID", "Name", "Diamonds", "Streak", "Goal", "Status", "Badges"];
                const rows = leaderboard.map(u => [u.id, u.name, u.diamonds, u.streak, u.goal, u.status, u.badges?.join(',')].join(","));
                const csvContent = "data:text/csv;charset=utf-8," + [headers.join(","), ...rows].join("\n");
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "fitness_quarter_data.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            // --- Sub-Components ---

            const AdminPanel = () => {
                const [editUser, setEditUser] = useState(null);
                const handleSave = () => { handleAdminUpdateUser(editUser); setEditUser(null); };

                if (editUser) {
                    return (
                        <div className="absolute inset-0 z-50 bg-[#f8fafc] p-6 animate-fade-in overflow-y-auto">
                            <div className="flex items-center gap-3 mb-8">
                                <button onClick={() => setEditUser(null)} className="p-2 bg-white rounded-full border border-slate-200"><X size={20} /></button>
                                <h2 className="text-2xl font-bold text-slate-800">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</h2>
                            </div>
                            <div className="space-y-6">
                                <div className="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm space-y-4">
                                    <div><label className="text-xs font-bold text-slate-400 uppercase">–ò–º—è</label><input type="text" value={editUser.name} onChange={(e) => setEditUser({...editUser, name: e.target.value})} className="w-full mt-1 p-3 rounded-xl border border-slate-200 font-bold text-slate-800"/></div>
                                    <div><label className="text-xs font-bold text-slate-400 uppercase">–°—Ç–∞—Ç—É—Å</label><select value={editUser.status} onChange={(e) => setEditUser({...editUser, status: e.target.value})} className="w-full mt-1 p-3 rounded-xl border border-slate-200 font-bold text-slate-800 bg-white"><option value="active">Active</option><option value="frozen">Frozen</option><option value="dead">Dead</option></select></div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="text-xs font-bold text-slate-400 uppercase">–ê–ª–º–∞–∑—ã</label>
                                            <input type="number" value={editUser.diamonds} onChange={(e) => setEditUser({...editUser, diamonds: parseInt(e.target.value)})} className="w-full mt-1 p-3 rounded-xl border border-slate-200 font-bold text-slate-800" />
                                        </div>
                                        <div>
                                            <label className="text-xs font-bold text-slate-400 uppercase">–°—Ç—Ä–∏–∫</label>
                                            <input type="number" value={editUser.streak} onChange={(e) => setEditUser({...editUser, streak: parseInt(e.target.value)})} className="w-full mt-1 p-3 rounded-xl border border-slate-200 font-bold text-slate-800" />
                                        </div>
                                    </div>
                                    <div><label className="text-xs font-bold text-slate-400 uppercase">–¶–µ–ª—å (–¥–Ω–µ–π)</label><select value={editUser.goal} onChange={(e) => setEditUser({...editUser, goal: parseInt(e.target.value)})} className="w-full mt-1 p-3 rounded-xl border border-slate-200 font-bold text-slate-800 bg-white"><option value="30">30</option><option value="60">60</option><option value="100">100</option></select></div>
                                </div>
                                <NeonButton variant="gold" onClick={handleSave}><Save size={18} /> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</NeonButton>
                            </div>
                        </div>
                    )
                }
                return (
                    <div className="absolute inset-0 z-50 bg-slate-50 p-6 animate-fade-in overflow-y-auto">
                        <div className="flex justify-between items-center mb-8 border-b border-amber-200 pb-4">
                            <div className="flex items-center gap-3"><div className="w-10 h-10 rounded-full bg-amber-100 flex items-center justify-center border-2 border-amber-300"><Shield size={20} className="text-amber-600" /></div><div><h2 className="text-xl font-black text-slate-800 uppercase tracking-wider">Master Profile</h2><p className="text-[10px] font-bold text-amber-600 uppercase tracking-widest">Admin Control Panel</p></div></div>
                            <button onClick={() => setAdminPanelOpen(false)} className="p-2 bg-white rounded-full shadow-sm"><X size={20} className="text-slate-400" /></button>
                        </div>
                        <div className="space-y-6">
                            <div className="grid grid-cols-1 gap-3"><button onClick={handleExportData} className="flex items-center justify-center gap-2 p-4 bg-white border border-slate-200 rounded-xl shadow-sm font-bold text-slate-600 hover:bg-slate-50 transition-colors"><Download size={18} /> –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö (CSV)</button></div>
                            <div>
                                <h3 className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-3 pl-1">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏</h3>
                                <div className="space-y-2">{leaderboard.map(u => (<div key={u.id} className="bg-white p-3 rounded-xl border border-slate-200 flex items-center justify-between shadow-sm"><div className="flex items-center gap-3"><div className={`w-2 h-10 rounded-full ${u.status === 'active' ? 'bg-emerald-400' : 'bg-rose-400'}`}></div><div><div className="font-bold text-slate-700">{u.name}</div><div className="flex gap-2 text-[10px] text-slate-400 font-medium"><span>üíé {u.diamonds}</span><span>üî• {u.streak}</span><span className="uppercase">{u.status}</span></div></div></div><button onClick={() => setEditUser(u)} className="p-2 rounded-lg bg-slate-50 hover:bg-amber-50 text-slate-400 hover:text-amber-600 transition-colors"><Edit3 size={18} /></button></div>))}</div>
                            </div>
                        </div>
                    </div>
                );
            };

            // --- VIEWS ---

            const WelcomeScreen = () => (
                <div className="flex flex-col h-full p-8 animate-fade-in relative z-10 pt-20">
                    <div className="flex-grow flex flex-col items-center justify-center text-center space-y-8">
                        <div className="relative w-36 h-36 flex items-center justify-center"><div className="absolute inset-0 bg-cyan-400/20 blur-3xl rounded-full animate-pulse"></div><Hexagon size={120} className="text-cyan-600 stroke-[1.5] animate-float drop-shadow-xl" /><Activity size={48} className="text-cyan-800 absolute" /></div>
                        <div><h1 className="text-5xl font-black text-slate-800 uppercase tracking-tighter leading-tight mb-2">Fitness<br/><span className="text-cyan-500">–ö–≤–∞—Ä—Ç–∞–ª</span></h1><p className="text-slate-500 font-medium tracking-wide uppercase text-xs bg-white/50 inline-block px-4 py-1.5 rounded-full border border-white/40 shadow-sm mt-2">–¢–≤–æ—è —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è —Å–ø–æ—Ä—Ç–∞</p></div>
                    </div>
                    <div className="mt-auto w-full pb-6"><NeonButton onClick={() => setStep('onboarding_disciplines')} className="shadow-xl">–ù–∞—á–∞—Ç—å –ß–µ–ª–ª–µ–Ω–¥–∂</NeonButton><p className="text-center text-slate-400 text-[10px] mt-4 uppercase tracking-widest font-bold">–í–µ—Ä—Å–∏—è 3.3 ‚Ä¢ Badges Leaderboard</p></div>
                </div>
            );

            const OnboardingDisciplines = () => {
                const [isAddingCustom, setIsAddingCustom] = useState(false);
                const [customInput, setCustomInput] = useState("");
                const handleAddCustom = () => { if (customInput.trim()) { setPopularSports(prev => [...prev, customInput.trim()]); toggleDiscipline(customInput.trim()); setCustomInput(""); setIsAddingCustom(false); } }
                return (
                    <div className="p-6 flex flex-col h-full animate-slide-up relative z-10">
                        <h2 className="text-3xl font-display font-bold text-slate-800 mb-2">–¢–≤–æ–π –ê—Ä—Å–µ–Ω–∞–ª</h2><p className="text-slate-500 text-sm mb-8 leading-relaxed">–í—ã–±–µ—Ä–∏ –¥–æ 5 –¥–∏—Å—Ü–∏–ø–ª–∏–Ω.</p>
                        <div className="flex flex-wrap gap-3 mb-4 max-h-[50vh] overflow-y-auto content-start">
                            {popularSports.map(sport => (<button key={sport} onClick={() => toggleDiscipline(sport)} className={`px-5 py-2.5 rounded-xl font-medium text-sm transition-all duration-300 shadow-sm border ${user.disciplines.includes(sport) ? 'bg-cyan-500 text-white border-cyan-500 shadow-cyan-200 shadow-lg scale-105' : 'bg-white text-slate-600 border-slate-100 hover:border-cyan-200 hover:bg-cyan-50'}`}>{sport}</button>))}
                            {!isAddingCustom ? (<button onClick={() => setIsAddingCustom(true)} className="px-5 py-2.5 rounded-xl font-medium text-sm border border-dashed border-slate-300 text-slate-400 hover:border-cyan-400 hover:text-cyan-500 bg-white/50 flex items-center gap-2"><Plus size={16} /> –°–≤–æ—è</button>) : (<div className="flex items-center gap-2 animate-fade-in w-full sm:w-auto"><input type="text" value={customInput} onChange={(e) => setCustomInput(e.target.value)} placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ..." className="px-4 py-2.5 rounded-xl border border-cyan-300 outline-none text-sm w-32 focus:ring-2 focus:ring-cyan-200" autoFocus onKeyDown={(e) => e.key === 'Enter' && handleAddCustom()} /><button onClick={handleAddCustom} className="p-2.5 bg-cyan-500 text-white rounded-xl shadow-lg"><CheckCircle size={16}/></button><button onClick={() => setIsAddingCustom(false)} className="p-2.5 bg-slate-200 text-slate-500 rounded-xl"><X size={16}/></button></div>)}
                        </div>
                        <div className="mt-auto"><div className="flex justify-between items-center mb-4 text-sm font-medium"><span className="text-slate-400">–í—ã–±—Ä–∞–Ω–æ:</span><span className={user.disciplines.length > 0 ? "text-cyan-600" : "text-slate-400"}>{user.disciplines.length} / 5</span></div><NeonButton onClick={() => setStep('onboarding_goal')} disabled={user.disciplines.length === 0} variant={user.disciplines.length > 0 ? 'primary' : 'disabled'}>–î–∞–ª–µ–µ</NeonButton></div>
                    </div>
                );
            };

            const OnboardingGoal = () => (
                <div className="p-6 flex flex-col h-full animate-slide-up relative z-10"><h2 className="text-3xl font-display font-bold text-slate-800 mb-8 text-center">–í—ã–±–µ—Ä–∏ –í—ã—Å–æ—Ç—É</h2><div className="flex flex-col gap-5 flex-grow justify-center">{[30, 60, 100].map((days, idx) => (<GlassCard key={days} onClick={() => handleGoalSelect(days)} className="p-6 flex items-center justify-between group hover:bg-white/80 transition-all border-l-4 border-l-transparent hover:border-l-cyan-500"><div className="flex flex-col"><span className="text-3xl font-display font-bold text-slate-700 group-hover:text-cyan-600 transition-colors">{days} –î–Ω–µ–π</span><span className="text-xs text-slate-400 font-bold uppercase tracking-widest mt-1">{idx === 0 ? '–ù–æ–≤–∏—á–æ–∫' : idx === 1 ? '–ê—Ç–ª–µ—Ç' : '–ö–∏–±–æ—Ä–≥'}</span></div><div className="w-12 h-12 rounded-full bg-slate-50 flex items-center justify-center group-hover:bg-cyan-50 group-hover:text-cyan-500 transition-colors shadow-inner">{idx === 0 ? <Activity size={20} /> : idx === 1 ? <Zap size={20} /> : <Trophy size={20} />}</div></GlassCard>))}</div></div>
            );

            const Dashboard = () => {
                const [dashboardView, setDashboardView] = useState('leaderboard');
                const [showAllBadges, setShowAllBadges] = useState(false);
                const [showConfetti, setShowConfetti] = useState(false);
                
                // Settings local state
                const [isAddingCustom, setIsAddingCustom] = useState(false);
                const [customInput, setCustomInput] = useState("");
                const handleAddCustom = () => { if (customInput.trim()) { setPopularSports(prev => [...prev, customInput.trim()]); toggleDiscipline(customInput.trim()); setCustomInput(""); setIsAddingCustom(false); } }

                const badgeConfig = {
                    'streak': { icon: <Flame size={10} />, color: 'text-orange-500', bg: 'bg-orange-100' },
                    'runner': { icon: <Ruler size={10} />, color: 'text-cyan-500', bg: 'bg-cyan-100' },
                    'gym': { icon: <Dumbbell size={10} />, color: 'text-purple-500', bg: 'bg-purple-100' },
                    'reps': { icon: <Activity size={10} />, color: 'text-emerald-500', bg: 'bg-emerald-100' },
                    'early': { icon: <Sun size={10} />, color: 'text-amber-500', bg: 'bg-amber-100' },
                    'night': { icon: <Moon size={10} />, color: 'text-indigo-500', bg: 'bg-indigo-100' },
                    'weekend': { icon: <Calendar size={10} />, color: 'text-rose-500', bg: 'bg-rose-100' },
                    'social': { icon: <Send size={10} />, color: 'text-blue-500', bg: 'bg-blue-100' },
                    'redemption': { icon: <Skull size={10} />, color: 'text-slate-500', bg: 'bg-slate-200' },
                };

                const badges = [
                    { id: 'streak', icon: <Flame size={16} />, label: '–ù–∞ –æ–≥–Ω–µ', desc: '–°—Ç—Ä–∏–∫ 3+ –¥–Ω–µ–π', color: 'text-orange-500', bg: 'bg-orange-100', condition: user.streak >= 3 },
                    { id: 'runner', icon: <Ruler size={16} />, label: '–ë–µ–≥—É–Ω', desc: '10+ –∫–º –≤—Å–µ–≥–æ', color: 'text-cyan-500', bg: 'bg-cyan-100', condition: getStatsSummary(user.history).totalKm >= 10 },
                    { id: 'gym', icon: <Dumbbell size={16} />, label: '–¢–µ—Ä–º–∏–Ω–∞—Ç–æ—Ä', desc: '5+ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫', color: 'text-purple-500', bg: 'bg-purple-100', condition: getStatsSummary(user.history).totalGym >= 5 },
                    { id: 'reps', icon: <Activity size={16} />, label: '–ú–∞—à–∏–Ω–∞', desc: '500+ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π', color: 'text-emerald-500', bg: 'bg-emerald-100', condition: getStatsSummary(user.history).totalReps >= 500 },
                    { id: 'early', icon: <Sun size={16} />, label: '–ñ–∞–≤–æ—Ä–æ–Ω–æ–∫', desc: '–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –¥–æ 9 —É—Ç—Ä–∞', color: 'text-amber-500', bg: 'bg-amber-100', condition: false },
                    { id: 'night', icon: <Moon size={16} />, label: '–°–æ–≤–∞', desc: '–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –ø–æ—Å–ª–µ 22', color: 'text-indigo-500', bg: 'bg-indigo-100', condition: false },
                    { id: 'weekend', icon: <Calendar size={16} />, label: '–í—ã—Ö–æ–¥–Ω–æ–π', desc: '–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –≤ –°–±/–í—Å', color: 'text-rose-500', bg: 'bg-rose-100', condition: false },
                    { id: 'social', icon: <Send size={16} />, label: '–î—Ä—É–≥', desc: '–û—Ç–ø—Ä–∞–≤–∏–ª 5 –ø–∏–Ω–∫–æ–≤', color: 'text-blue-500', bg: 'bg-blue-100', condition: false },
                    { id: 'redemption', icon: <Skull size={16} />, label: '–í—ã–∂–∏–≤—à–∏–π', desc: '–í–µ—Ä–Ω—É–ª –∞–ª–º–∞–∑', color: 'text-slate-500', bg: 'bg-slate-200', condition: false },
                ];
                const visibleBadges = showAllBadges ? badges : badges.slice(0, 3);
                const userStats = getStatsSummary(user.history);
                const progressPercent = Math.min((user.streak / user.goal) * 100, 100);

                if (checkInModalOpen) {
                    return (
                        <div className="absolute inset-0 z-50 flex items-end sm:items-center justify-center bg-slate-900/20 backdrop-blur-sm animate-fade-in"><div className="w-full max-w-md bg-white rounded-t-3xl p-8 shadow-[0_-10px_40px_rgba(0,0,0,0.1)] pb-10 sm:rounded-3xl">
                            {checkInStage === 'select' ? (
                                <>
                                    <div className="flex justify-between items-center mb-6"><h3 className="text-xl font-bold text-slate-800">–ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ?</h3><button onClick={() => setCheckInModalOpen(false)} className="p-2 bg-slate-100 rounded-full hover:bg-slate-200"><X size={20} className="text-slate-500" /></button></div>
                                    <div className="grid grid-cols-1 gap-3">
                                        {user.disciplines.map(sport => (<button key={sport} onClick={() => initCheckIn(sport)} className="py-4 rounded-xl font-bold transition-all border bg-slate-50 text-slate-700 hover:bg-cyan-50 hover:text-cyan-600 border-slate-100 hover:shadow-md flex justify-between px-6"><span>{sport}</span>{user.todayActivity.includes(sport) && <span className="text-emerald-500">‚úì</span>}</button>))}
                                        <div className="mt-4 text-center"><button onClick={() => { setCheckInModalOpen(false); setEditingProfile(true); }} className="text-xs font-bold text-slate-400 uppercase tracking-wide hover:text-cyan-500">–î–æ–±–∞–≤–∏—Ç—å –¥—Ä—É–≥—É—é –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—É</button></div>
                                    </div>
                                </>
                            ) : (
                                <div className="animate-slide-up">
                                    <div className="flex justify-between items-center mb-6"><button onClick={() => setCheckInStage('select')} className="text-slate-400 text-sm font-bold">‚Üê –ù–∞–∑–∞–¥</button><h3 className="text-xl font-bold text-slate-800">{selectedSportForCheckIn}</h3><div className="w-8"></div></div>
                                    {getSportType(selectedSportForCheckIn) === 'gym' && <div className="grid grid-cols-2 gap-3">{['–í—Å—ë —Ç–µ–ª–æ', '–í–µ—Ä—Ö', '–ù–∏–∑', '–ì–æ–ª–æ–≤–∞'].map(s => <button key={s} onClick={() => completeCheckIn(selectedSportForCheckIn, s, null)} className="py-6 rounded-2xl bg-slate-50 border border-slate-200 hover:bg-cyan-50 hover:border-cyan-200 font-bold text-slate-700 hover:text-cyan-600 shadow-sm">{s === '–ì–æ–ª–æ–≤–∞' ? 'ü§™ –ì–æ–ª–æ–≤–æ–π' : s}</button>)}</div>}
                                    {getSportType(selectedSportForCheckIn) === 'reps' && <div className="grid grid-cols-2 gap-3">{[30, 60, 100, 200].map(r => <button key={r} onClick={() => completeCheckIn(selectedSportForCheckIn, r, '–ø–æ–≤—Ç')} className="py-6 rounded-2xl bg-slate-50 border border-slate-200 hover:bg-cyan-50 hover:border-cyan-200 font-black text-2xl text-slate-700 hover:text-cyan-600 shadow-sm">{r}</button>)}</div>}
                                    {getSportType(selectedSportForCheckIn) === 'cardio' && <div className="space-y-6 flex flex-col items-center"><div className="flex items-center"><input type="number" autoFocus placeholder="0" className="text-center text-6xl font-black text-slate-800 w-32 bg-transparent outline-none border-b-4 border-cyan-200 focus:border-cyan-500" onChange={(e) => setCheckInValue(e.target.value)} /><span className="text-2xl font-bold text-slate-400 ml-2 mt-4">–∫–º</span></div><NeonButton onClick={() => completeCheckIn(selectedSportForCheckIn, checkInValue, '–∫–º')} disabled={!checkInValue} variant={checkInValue ? 'primary' : 'disabled'}>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</NeonButton></div>}
                                </div>
                            )}
                        </div></div>
                    );
                }

                if (editingProfile) {
                    return (
                        <div className="absolute inset-0 z-50 bg-[#f8fafc] p-6 animate-fade-in overflow-y-auto">
                            <div className="flex justify-between items-center mb-8"><h2 className="text-2xl font-bold text-slate-800">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2><button onClick={() => setEditingProfile(false)} className="p-2 bg-white rounded-full shadow-sm"><X className="text-slate-500" /></button></div>
                            <div className="space-y-8">
                                <div className="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm"><div className="flex justify-between items-center"><div className="flex items-center gap-3"><div className="w-10 h-10 rounded-full bg-cyan-50 flex items-center justify-center text-cyan-600"><Bell size={20} /></div><div><div className="font-bold text-slate-700">–ü—É—à-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div><div className="text-xs text-slate-400">–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–µ</div></div></div><ToggleSwitch checked={user.notifications} onChange={(val) => setUser({...user, notifications: val})} /></div></div>
                                <div><label className="text-slate-400 text-xs font-bold uppercase tracking-wider mb-3 block px-1">–î–∏—Å—Ü–∏–ø–ª–∏–Ω—ã (–º–∞–∫—Å 5)</label><div className="flex flex-wrap gap-2">{popularSports.map(s => <button key={s} onClick={() => toggleDiscipline(s)} className={`px-4 py-2 rounded-lg text-xs font-bold border transition-all ${user.disciplines.includes(s) ? 'bg-cyan-500 border-cyan-500 text-white shadow-md' : 'bg-white border-slate-200 text-slate-500'}`}>{s}</button>)}{!isAddingCustom ? <button onClick={() => setIsAddingCustom(true)} className="px-4 py-2 rounded-lg text-xs font-bold border border-dashed border-slate-300 text-slate-400 hover:border-cyan-400 bg-white flex items-center gap-2"><Plus size={14} /> –°–≤–æ—è</button> : <div className="flex items-center gap-2 mt-2 sm:mt-0"><input type="text" value={customInput} onChange={(e) => setCustomInput(e.target.value)} className="px-3 py-2 rounded-lg border border-cyan-300 outline-none text-xs w-32" autoFocus onKeyDown={(e) => e.key === 'Enter' && handleAddCustom()} /><button onClick={handleAddCustom} className="p-2 bg-cyan-500 text-white rounded-lg"><CheckCircle size={14}/></button></div>}</div></div>
                                <div className="pb-10"><label className="text-slate-400 text-xs font-bold uppercase tracking-wider mb-3 block px-1">–¶–µ–ª—å</label><div className="flex gap-2 bg-white p-1.5 rounded-xl border border-slate-200 shadow-sm">{[30, 60, 100].map(d => <button key={d} onClick={() => setUser({...user, goal: d})} className={`flex-1 py-2.5 rounded-lg text-sm font-bold transition-all ${user.goal === d ? 'bg-slate-800 text-white shadow-md' : 'text-slate-400 hover:bg-slate-50'}`}>{d}</button>)}</div></div>
                            </div>
                            <div className="sticky bottom-6"><NeonButton onClick={() => setEditingProfile(false)}>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</NeonButton></div>
                        </div>
                    );
                }

                if (selectedUser) {
                    const uStats = getStatsSummary(selectedUser.history || []);
                    return (
                        <div className="absolute inset-0 z-50 flex items-end sm:items-center justify-center bg-slate-900/30 backdrop-blur-md animate-fade-in p-4 overflow-y-auto"><div className="w-full max-w-sm bg-white rounded-3xl p-6 shadow-2xl border border-white/50">
                            <div className="flex justify-end"><button onClick={() => setSelectedUser(null)} className="p-2 bg-slate-100 rounded-full hover:bg-slate-200 transition-colors"><X size={20} className="text-slate-500" /></button></div>
                            <div className="flex flex-col items-center -mt-4 mb-6"><Avatar name={selectedUser.name} className="w-24 h-24 text-3xl shadow-xl mb-4 border-4 border-white" /><h3 className="text-2xl font-display font-bold text-slate-800">{selectedUser.name}</h3><div className={`px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider mt-2 ${selectedUser.status === 'active' ? 'bg-emerald-100 text-emerald-600' : 'bg-rose-100 text-rose-600'}`}>{selectedUser.status === 'active' ? '–í —Å—Ç—Ä–æ—é' : '–ó–∞–º–æ—Ä–æ–∂–µ–Ω'}</div></div>
                            <div className="grid grid-cols-2 gap-3 mb-6"><div className="bg-slate-50 p-3 rounded-2xl border border-slate-100 flex flex-col items-center justify-center"><div className="text-xs font-bold text-slate-400 uppercase mb-1">–î–∏—Å—Ç–∞–Ω—Ü–∏—è</div><div className="font-display font-black text-xl text-cyan-600 flex items-center gap-1"><Ruler size={16}/> {uStats.totalKm} <span className="text-xs text-slate-400 font-normal">–∫–º</span></div></div><div className="bg-slate-50 p-3 rounded-2xl border border-slate-100 flex flex-col items-center justify-center"><div className="text-xs font-bold text-slate-400 uppercase mb-1">–ü–æ–≤—Ç–æ—Ä–µ–Ω–∏–π</div><div className="font-display font-black text-xl text-purple-600 flex items-center gap-1"><Dumbbell size={16}/> {uStats.totalReps}</div></div></div>
                            <h4 className="text-sm font-bold text-slate-400 uppercase tracking-wider mb-3 pl-1">–î–∏—Å—Ü–∏–ø–ª–∏–Ω—ã</h4><div className="flex flex-wrap gap-2 mb-6">{selectedUser.disciplines?.map(d => <span key={d} className="px-3 py-1.5 bg-white border border-slate-200 rounded-lg text-sm text-slate-600 shadow-sm">{d}</span>)}</div>
                            <NeonButton className="py-3 text-sm"><Zap size={18} className="fill-white" /> –û—Ç–ø—Ä–∞–≤–∏—Ç—å –º–æ—Ç–∏–≤–∞—Ü–∏—é</NeonButton>
                        </div></div>
                    );
                }

                return (
                    <div className="pb-24 relative min-h-screen z-10">
                        <div className="sticky top-0 bg-[#f8fafc]/90 backdrop-blur-md z-20 px-6 py-4 border-b border-slate-200/60">
                            <div className="flex justify-between items-start mb-4">
                                <div className="flex items-center gap-3 cursor-pointer group" onClick={() => user.isAdmin && setAdminPanelOpen(true)}><div className="relative"><Avatar name={user.name} className="w-12 h-12 text-lg shadow-sm border border-slate-100 group-hover:border-amber-400 transition-colors" />{user.isAdmin && <div className="absolute -bottom-1 -right-1 bg-amber-500 text-white rounded-full p-0.5 border-2 border-white"><Shield size={10} /></div>}</div><div><div className="font-display font-bold text-slate-800 text-lg leading-tight group-hover:text-amber-600 transition-colors">{user.name}</div><div className="text-[10px] text-slate-400 font-bold uppercase tracking-wider mt-0.5">–°—Ç–∞—Ç—É—Å: {user.status === 'active' ? '–í —Å—Ç—Ä–æ—é' : '–ó–∞–º–æ—Ä–æ–∂–µ–Ω'}</div></div></div>
                                <div className="flex gap-2"><div onClick={() => setStep('redemption')} className="bg-white border border-slate-200 rounded-full px-4 py-1.5 flex items-center gap-2 cursor-pointer hover:bg-slate-50 transition-colors shadow-sm"><Diamond size={16} className="text-cyan-500 fill-cyan-500" /><span className="font-display font-bold text-slate-700 text-lg">{user.diamonds}</span></div><button onClick={() => setEditingProfile(true)} className="w-10 h-10 flex items-center justify-center rounded-full bg-white border border-slate-200 hover:bg-slate-50 text-slate-400 shadow-sm"><Settings size={18} /></button></div>
                            </div>
                            <div className="flex justify-between text-xs font-bold text-slate-400 mb-2 font-display"><span>{user.streak} days</span><span>{user.goal} days</span></div><div className="w-full bg-slate-200 h-2 rounded-full overflow-hidden relative"><div className="bg-gradient-to-r from-cyan-500 to-blue-500 h-full shadow-[0_2px_10px_rgba(6,182,212,0.4)]" style={{ width: `${progressPercent}%` }}></div></div>
                        </div>
                        {adminPanelOpen && <AdminPanel />}
                        <div className="p-6">
                            {isCheckedIn ? (
                                <GlassCard className="p-6 text-center border-emerald-100 bg-emerald-50/50">
                                    <div className="inline-flex items-center justify-center w-16 h-16 rounded-full bg-emerald-100 mb-4 shadow-inner"><CheckCircle size={32} className="text-emerald-500" /></div><h3 className="text-xl font-bold text-slate-800 mb-1">–î–µ–Ω—å –∑–∞—Å—á–∏—Ç–∞–Ω!</h3><div className="flex flex-wrap justify-center gap-2 mt-3 mb-6">{user.todayActivity.map(act => <span key={act} className="px-3 py-1 bg-white border border-emerald-200 rounded-lg text-xs font-bold text-emerald-600 shadow-sm">{act}</span>)}</div><NeonButton variant="secondary" onClick={() => setCheckInModalOpen(true)} className="py-3 text-sm font-medium"><Plus size={16} /> –î–æ–±–∞–≤–∏—Ç—å –µ—â–µ</NeonButton>
                                </GlassCard>
                            ) : (
                                <button onClick={() => setCheckInModalOpen(true)} disabled={user.diamonds <= 0} className="w-full aspect-square max-h-80 rounded-[2rem] bg-white border border-slate-100 shadow-[0_20px_50px_rgba(6,182,212,0.15)] relative group overflow-hidden active:scale-[0.98] transition-all"><div className="absolute top-0 right-0 w-64 h-64 bg-cyan-100/50 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2 group-hover:bg-cyan-200/50 transition-colors"></div><div className="absolute bottom-0 left-0 w-64 h-64 bg-blue-100/50 rounded-full blur-3xl translate-y-1/2 -translate-x-1/2 group-hover:bg-blue-200/50 transition-colors"></div><div className="relative z-10 flex flex-col items-center justify-center h-full gap-6">{user.diamonds > 0 ? <><div className="w-24 h-24 rounded-full bg-gradient-to-br from-cyan-400 to-blue-500 flex items-center justify-center shadow-[0_10px_30px_rgba(6,182,212,0.4)] group-hover:scale-110 transition-transform duration-500 text-white"><Zap size={48} className="fill-white" /></div><div className="text-center"><span className="block text-3xl font-black text-slate-800 uppercase tracking-widest group-hover:text-cyan-600 transition-colors font-display">–û—Ç–º–µ—Ç–∏—Ç—å</span><span className="text-slate-400 font-medium text-sm mt-1">–ù–∞–∂–º–∏, —á—Ç–æ–±—ã –∑–∞—á–µ—Å—Ç—å –¥–µ–Ω—å</span></div></> : <><div className="w-24 h-24 rounded-full bg-slate-100 flex items-center justify-center border-4 border-slate-50 shadow-inner"><X size={48} className="text-slate-300" /></div><div className="text-center px-6"><span className="block text-2xl font-black text-slate-800 uppercase tracking-widest mb-2 font-display">–ó–∞–º–æ—Ä–æ–∂–µ–Ω</span><p className="text-sm text-slate-400 font-medium leading-relaxed">–£ —Ç–µ–±—è –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å –∞–ª–º–∞–∑—ã.<br/>–ò–¥–∏ –≤ –º–∞–≥–∞–∑–∏–Ω –∏—Å–∫—É–ø–ª–µ–Ω–∏—è.</p></div></>}</div></button>
                            )}
                        </div>
                        <div className="px-6">
                            <div className="flex justify-between items-center mb-4"><h3 className="text-slate-400 uppercase text-xs font-bold tracking-[0.2em] pl-1">{dashboardView === 'leaderboard' ? '–¢–æ–ø –£—á–∞—Å—Ç–Ω–∏–∫–æ–≤' : '–ú–æ–π –ü—Ä–æ–≥—Ä–µ—Å—Å'}</h3><div className="bg-slate-200 p-1 rounded-xl flex gap-1"><button onClick={() => setDashboardView('leaderboard')} className={`p-1.5 rounded-lg transition-all ${dashboardView === 'leaderboard' ? 'bg-white text-slate-700 shadow-sm' : 'text-slate-400 hover:text-slate-600'}`}><Users size={16} /></button><button onClick={() => setDashboardView('progress')} className={`p-1.5 rounded-lg transition-all ${dashboardView === 'progress' ? 'bg-white text-slate-700 shadow-sm' : 'text-slate-400 hover:text-slate-600'}`}><BarChart3 size={16} /></button></div></div>
                            {dashboardView === 'leaderboard' ? (
                                <div className="space-y-3">{leaderboard.map((u, idx) => (
                                    <GlassCard key={u.id} onClick={() => setSelectedUser(u)} className={`p-4 flex items-center justify-between transition-colors cursor-pointer ${u.status === 'frozen' ? 'opacity-60 bg-slate-50' : 'bg-white hover:bg-slate-50'}`}>
                                        <div className="flex items-center gap-4"><div className="relative"><Avatar name={u.name} className="w-10 h-10 text-xs" /><div className="absolute -top-1 -right-1 bg-white rounded-full w-4 h-4 flex items-center justify-center text-[9px] font-bold border border-slate-100 text-slate-500">{idx + 1}</div></div><div><div className="flex items-center gap-2"><div className={`font-bold text-slate-700 ${u.status === 'frozen' ? 'line-through text-slate-400' : ''}`}>{u.name}</div><div className="flex gap-1">{u.badges?.slice(0, 4).map(b => badgeConfig[b] && (<div key={b} className={`w-4 h-4 rounded-full flex items-center justify-center ${badgeConfig[b].bg} ${badgeConfig[b].color}`}>{badgeConfig[b].icon}</div>))}</div></div><div className="flex gap-1 mt-0.5">{Array.from({ length: 3 }).map((_, i) => (<div key={i} className={`w-1.5 h-1.5 rounded-full ${i < u.diamonds ? 'bg-cyan-400' : 'bg-slate-200'}`}></div>))}</div></div></div><button className="w-10 h-10 rounded-full bg-slate-50 hover:bg-cyan-50 hover:text-cyan-500 text-slate-400 flex items-center justify-center transition-colors border border-slate-100"><Zap size={18} /></button>
                                    </GlassCard>
                                ))}</div>
                            ) : (
                                <div className="animate-fade-in space-y-6">
                                    <GlassCard className="p-6 bg-white/70">
                                        <div className="flex items-center justify-between mb-6"><div className="flex items-center gap-3"><Avatar name={user.name} className="w-12 h-12 text-lg shadow-md border-2 border-white" /><div><div className="text-xs text-slate-400 font-bold uppercase tracking-wider">–¢–∏—Ç—É–ª</div><div className="font-display font-black text-xl text-slate-800">{getUserTitle(user.goal)}</div></div></div><div className="text-right"><div className="text-xs text-slate-400 font-bold uppercase tracking-wider">–¶–µ–ª—å</div><div className="font-display font-black text-xl text-cyan-600">{user.goal} –î–Ω–µ–π</div></div></div>
                                        <div className="grid grid-cols-2 gap-3"><div className="bg-slate-50 p-4 rounded-2xl border border-slate-100 text-center"><Ruler size={20} className="mx-auto text-cyan-500 mb-2" /><div className="font-display font-black text-2xl text-slate-700">{userStats.totalKm}</div><div className="text-[10px] text-slate-400 font-bold uppercase tracking-wider">–ö–º –í—Å–µ–≥–æ</div></div><div className="bg-slate-50 p-4 rounded-2xl border border-slate-100 text-center"><Dumbbell size={20} className="mx-auto text-purple-500 mb-2" /><div className="font-display font-black text-2xl text-slate-700">{userStats.totalReps}</div><div className="text-[10px] text-slate-400 font-bold uppercase tracking-wider">–ü–æ–≤—Ç–æ—Ä–µ–Ω–∏–π</div></div></div>
                                    </GlassCard>
                                    <div>
                                        <div className="flex justify-between items-center mb-3 pl-1 pr-1"><h3 className="text-slate-400 uppercase text-xs font-bold tracking-[0.2em]">–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</h3><button onClick={() => setShowAllBadges(!showAllBadges)} className="text-xs font-bold text-cyan-600 hover:text-cyan-700 flex items-center gap-1">{showAllBadges ? '–°–∫—Ä—ã—Ç—å' : '–†–∞—Å–∫—Ä—ã—Ç—å'}{showAllBadges ? <ChevronUp size={12}/> : <ChevronDown size={12}/>}</button></div>
                                        <div className={`grid gap-3 transition-all ${showAllBadges ? 'grid-cols-3' : 'grid-cols-3'}`}>{visibleBadges.map(b => (<div key={b.id} className={`flex flex-col items-center p-3 rounded-2xl border text-center transition-all ${b.condition ? 'bg-white border-slate-100 shadow-sm' : 'bg-slate-50 border-slate-100 opacity-60 grayscale'}`}><div className={`w-8 h-8 rounded-full flex items-center justify-center mb-2 ${b.bg} ${b.color}`}>{b.icon}</div><div className="font-bold text-slate-700 text-[10px] leading-tight mb-1">{b.label}</div></div>))}</div>
                                    </div>
                                    <div><h3 className="text-slate-400 uppercase text-xs font-bold tracking-[0.2em] mb-3 pl-1">–ò—Å—Ç–æ—Ä–∏—è</h3><div className="space-y-3">{user.history.map((item, i) => (<div key={i} className="bg-white p-3 rounded-2xl border border-slate-100 flex items-center justify-between shadow-sm"><div className="flex items-center gap-3"><div className="w-10 h-10 rounded-full bg-slate-50 flex items-center justify-center text-slate-400">{item.type === 'cardio' ? <Ruler size={16}/> : item.type === 'gym' ? <Dumbbell size={16}/> : <Activity size={16}/>}</div><div><div className="font-bold text-slate-700 text-sm">{item.sport}</div><div className="text-[10px] text-slate-400 uppercase tracking-wide">{new Date(item.date).toLocaleDateString('ru-RU', {day: 'numeric', month: 'short'})}</div></div></div><div className="text-right"><div className="font-display font-black text-slate-800">{item.value} <span className="text-xs font-normal text-slate-400">{item.unit || ''}</span></div></div></div>))}</div></div>
                                </div>
                            )}
                        </div>
                    </div>
                );
            };

            const RedemptionShop = () => {
                const [processing, setProcessing] = useState(false);
                const [task, setTask] = useState("–ò—â—É –Ω–∞–∫–∞–∑–∞–Ω–∏–µ...");
                const [isSpinning, setIsSpinning] = useState(false);
                const [hasSpun, setHasSpun] = useState(false);
                const [fileUploaded, setFileUploaded] = useState(false);
                const [rerollCount, setRerollCount] = useState(0); 
                const tasks = ["–°–¥–µ–ª–∞–π —Å–µ–ª—Ñ–∏ —Å –Ω–∞–¥–ø–∏—Å—å—é '–Ø –õ–ï–ù–ò–í–ê–Ø –ü–ê–ù–î–ê' –Ω–∞ –ª–±—É", "–°—Ñ–æ—Ç–∫–∞–π—Å—è –≤ –ø–ª–∞–Ω–∫–µ —Å –∫–æ—Ç–æ–º (–∏–ª–∏ –ø—ã–ª–µ—Å–æ—Å–æ–º) –Ω–∞ —Å–ø–∏–Ω–µ", "–°–¥–µ–ª–∞–π —Ñ–æ—Ç–æ '–õ–∏—Ü–æ –ø–æ—Å–ª–µ 20 –±—ë—Ä–ø–∏'", "–°—Ñ–æ—Ç–∫–∞–π—Å—è —Å —Ç–∞–±–ª–∏—á–∫–æ–π '–û–±–µ—â–∞—é –±–æ–ª—å—à–µ –Ω–µ –ø—Ä–æ–ø—É—Å–∫–∞—Ç—å'", "–°–µ–ª—Ñ–∏ –≤ –ø–æ–∑–µ '–£–º–∏—Ä–∞—é—â–∏–π –ª–µ–±–µ–¥—å' –Ω–∞ –∫–æ–≤—Ä–∏–∫–µ"];
                
                const handleSpin = () => {
                    if (hasSpun && rerollCount >= 1) return;
                    if (hasSpun) setRerollCount(prev => prev + 1);
                    setIsSpinning(true); setHasSpun(false); setFileUploaded(false);
                    let interval = setInterval(() => { setTask(tasks[Math.floor(Math.random() * tasks.length)]); }, 80);
                    setTimeout(() => { clearInterval(interval); setIsSpinning(false); setHasSpun(true); setTask(tasks[Math.floor(Math.random() * tasks.length)]); }, 2000);
                };
                const handleBuyLife = () => { setProcessing(true); setTimeout(() => { setProcessing(false); setUser(prev => ({ ...prev, diamonds: prev.diamonds + 1, status: 'active' })); setStep('dashboard'); }, 4000); };

                if (processing) return <div className="h-full flex flex-col items-center justify-center p-6 text-center space-y-8 relative z-10 bg-white/95"><div className="relative"><div className="w-24 h-24 border-4 border-slate-100 border-t-rose-500 rounded-full animate-spin"></div><div className="absolute inset-0 flex items-center justify-center"><Flame className="text-rose-500 animate-pulse" size={32} /></div></div><div><h3 className="text-2xl font-display font-bold text-slate-800 mb-2">AI –∏—â–µ—Ç —Å–æ–≤–µ—Å—Ç—å... üî•</h3><p className="text-slate-500 text-sm italic">"–ì–µ–Ω–µ—Ä–∏—Ä—É—é —É–Ω–∏–∑–∏—Ç–µ–ª—å–Ω—É—é, –Ω–æ —Å–º–µ—à–Ω—É—é –ø–æ–¥–ø–∏—Å—å..."</p></div></div>;

                return (
                    <div className="h-full flex flex-col relative z-10 bg-[#f8fafc] overflow-y-auto">
                        <div className="sticky top-0 z-20 bg-white/80 backdrop-blur-md px-4 py-4 flex items-center gap-3 border-b border-rose-100"><button onClick={() => setStep('dashboard')} className="w-10 h-10 rounded-full bg-white border border-slate-200 flex items-center justify-center text-slate-600 active:scale-95 transition-transform">‚Üê</button><span className="font-display font-bold text-slate-800 uppercase tracking-wider">–ú–∞–≥–∞–∑–∏–Ω –∏—Å–∫—É–ø–ª–µ–Ω–∏—è</span></div>
                        <div className="p-6 pb-20">
                            <div className="relative rounded-3xl overflow-hidden mb-8 border border-rose-200 shadow-xl shadow-rose-500/10"><div className="absolute inset-0 bg-stripe-danger opacity-50 pointer-events-none"></div><div className="bg-white/90 backdrop-blur-sm p-8 text-center relative z-10"><div className="inline-flex items-center justify-center w-20 h-20 bg-rose-50 rounded-full mb-4 border-4 border-white shadow-lg relative"><Skull className="text-rose-500" size={40} /><div className="absolute -top-2 -right-2 bg-rose-500 text-white text-[10px] font-bold px-2 py-1 rounded-full animate-pulse">–®–¢–†–ê–§</div></div><h2 className="text-3xl font-black text-slate-800 uppercase leading-none mb-2">–í–µ—Ä–Ω—É—Ç—å<br/><span className="text-rose-500">–ê–ª–º–∞–∑</span></h2><p className="text-slate-500 text-sm font-medium">–ü—Ä–æ–ø—É—Å—Ç–∏–ª —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É?<br/>–ö—Ä—É—Ç–∏ —Ä—É–ª–µ—Ç–∫—É –ø–æ–∑–æ—Ä–∞.</p></div></div>
                            <div className="bg-white rounded-2xl p-1 shadow-[0_4px_20px_rgba(0,0,0,0.03)] border border-slate-100 mb-6"><div className="border-2 border-dashed border-slate-200 rounded-xl p-5 bg-slate-50/50"><div className="flex items-center justify-between mb-4"><div className="flex items-center gap-2"><Siren size={16} className="text-rose-500 animate-pulse" /><span className="text-xs font-bold text-slate-400 uppercase tracking-widest">–¢–í–û–ï –ó–ê–î–ê–ù–ò–ï</span></div>{isSpinning && <span className="text-[10px] text-slate-400 animate-pulse">–í—ã–±–∏—Ä–∞–µ–º...</span>}</div><h3 className={`font-display font-bold text-xl text-slate-800 leading-snug mb-4 min-h-[3rem] ${isSpinning ? 'opacity-50 blur-[1px]' : ''}`}>{(!hasSpun && !isSpinning) ? "–ò—Å–ø—ã—Ç–∞–π —É–¥–∞—á—É..." : `"${task}"`}</h3>{!hasSpun && !isSpinning ? (<NeonButton variant="danger" onClick={handleSpin} className="py-2 text-sm shadow-rose-200">–ö—Ä—É—Ç–∏—Ç—å –†—É–ª–µ—Ç–∫—É üé≤</NeonButton>) : (<div className="flex gap-2 animate-fade-in"><span className="px-3 py-1 bg-white border border-slate-200 rounded-lg text-[10px] font-bold text-slate-500 uppercase">–ù–∞–≥—Ä–∞–¥–∞: +1 üíé</span>{hasSpun && !isSpinning && rerollCount < 1 && (<button onClick={handleSpin} className="px-2 py-1 bg-slate-100 rounded-lg hover:bg-slate-200 transition-colors flex items-center gap-1 text-[10px] font-bold text-slate-500"><RefreshCw size={12}/> <span>{1 - rerollCount}</span></button>)}</div>)}</div></div>
                            {hasSpun && (<div className="animate-slide-up"><button onClick={() => setFileUploaded(true)} disabled={isSpinning} className={`w-full border-2 border-dashed rounded-2xl p-8 mb-6 transition-all group relative overflow-hidden active:scale-[0.99] ${fileUploaded ? 'bg-emerald-50 border-emerald-300' : 'bg-white border-slate-300 hover:border-rose-400 hover:bg-rose-50/30'}`}><div className="flex flex-col items-center gap-3 relative z-10"><div className={`w-16 h-16 rounded-full flex items-center justify-center transition-colors ${fileUploaded ? 'bg-emerald-100 text-emerald-500' : 'bg-slate-100 text-slate-400 group-hover:bg-rose-100 group-hover:text-rose-500'}`}>{fileUploaded ? <CheckCircle size={32}/> : <Camera size={32} />}</div><div className="text-center"><span className={`block text-sm font-bold transition-colors ${fileUploaded ? 'text-emerald-700' : 'text-slate-600 group-hover:text-rose-600'}`}>{fileUploaded ? '–§–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ!' : '–ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ'}</span>{!fileUploaded && <span className="text-[10px] text-slate-400 uppercase font-bold mt-1">JPG, PNG</span>}</div></div></button><NeonButton variant={fileUploaded ? "danger" : "disabled"} onClick={handleBuyLife} disabled={!fileUploaded} className={fileUploaded ? "shadow-lg shadow-rose-200" : ""}><div className="flex items-center gap-2"><span>{fileUploaded ? "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –ø—Ä–æ–∂–∞—Ä–∫—É" : "–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏ —Ñ–æ—Ç–æ"}</span>{fileUploaded && <Send size={16} />}</div></NeonButton><p className="text-center text-[10px] text-slate-400 font-bold uppercase tracking-wider mt-6 px-8 leading-relaxed"><FileWarning size={12} className="inline mr-1 mb-0.5"/> –í–Ω–∏–º–∞–Ω–∏–µ: –§–æ—Ç–æ –ø–æ–ø–∞–¥–µ—Ç –≤ –æ–±—â–∏–π —á–∞—Ç. –ù–∞–∑–∞–¥ –¥–æ—Ä–æ–≥–∏ –Ω–µ—Ç.</p></div>)}
                        </div>
                    </div>
                );
            };

            // Router
            return (
                <div className="bg-[#f8fafc] text-slate-600 min-h-screen font-sans max-w-md mx-auto shadow-2xl overflow-hidden relative selection:bg-cyan-200">
                    <div className="fixed inset-0 z-0">
                        <div className="absolute top-0 left-1/4 w-[500px] h-[500px] bg-cyan-200/30 rounded-full blur-[120px] pointer-events-none mix-blend-multiply opacity-70"></div>
                        <div className="absolute bottom-0 right-1/4 w-[400px] h-[400px] bg-purple-200/30 rounded-full blur-[100px] pointer-events-none mix-blend-multiply opacity-70"></div>
                        <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full h-full opacity-[0.03]" style={{backgroundImage: "url('https://grainy-gradients.vercel.app/noise.svg')"}}></div>
                    </div>
                    {step === 'welcome' && <WelcomeScreen />}
                    {step === 'onboarding_disciplines' && <OnboardingDisciplines />}
                    {step === 'onboarding_goal' && <OnboardingGoal />}
                    {step === 'dashboard' && <Dashboard />}
                    {step === 'redemption' && <RedemptionShop />}
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>