<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fitness –ö–≤–∞—Ä—Ç–∞–ª</title>
    
    <!-- Telegram Web App -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        cyan: { 50: '#ecfeff', 100: '#cffafe', 200: '#a5f3fc', 300: '#67e8f9', 400: '#22d3ee', 500: '#06b6d4', 600: '#0891b2', 700: '#0e7490', 800: '#155e75', 900: '#164e63' },
                        slate: { 850: '#1e293b' } 
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        display: ['Space Grotesk', 'sans-serif'],
                    },
                    padding: {
                        'safe-top': '80px', /* –û—Ç—Å—Ç—É–ø –¥–ª—è —á–µ–ª–∫–∏ */
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out forwards',
                        'slide-up': 'slideUp 0.5s ease-out forwards',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
                    }
                }
            }
        }
    </script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">

    <!-- React & Babel -->
    <script type="importmap">
        {
            "imports": {
                "react": "https://esm.sh/react@18.2.0",
                "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
                "lucide-react": "https://esm.sh/lucide-react@0.263.1"
            }
        }
    </script>
    <script src="https://unpkg.com/@babel/standalone@7.26.9/babel.min.js"></script>
    <script>
        window.Babel = { presets: [['env', { modules: false }], 'react'] };
    </script>

    <style>
        body { 
            background-color: #f8fafc; 
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
        }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Trophy, Diamond, Zap, Camera, CheckCircle, Activity, User, Settings, Plus, X, 
            Hexagon, Flame, Send, Bell, AlertTriangle, Skull, Dumbbell, Timer, Ruler, 
            BarChart3, Users, Calendar, Award, ChevronRight, Siren, FileWarning, UploadCloud, 
            RefreshCw, Shield, Download, Edit3, Save, Trash2, LogOut
        } from 'lucide-react';

        // --- CONSTANTS ---
        
        // –î–∞—Ç–∞ —Å—Ç–∞—Ä—Ç–∞ –º–∞—Ä–∞—Ñ–æ–Ω–∞ (–ì–ì–ì–ì-–ú–ú-–î–î)
        const MARATHON_START_DATE = new Date('2023-10-25'); // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Ä–µ–∞–ª—å–Ω—É—é –¥–∞—Ç—É —Å—Ç–∞—Ä—Ç–∞
        const ADMIN_USERNAME = 'solomin_d';
        
        // –í—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ URL –≤–∞—à–µ–≥–æ Google Apps Script Web App
        // –ï—Å–ª–∏ –ø—É—Å—Ç–æ, –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –ø—Ä–æ—Å—Ç–æ –≤—ã–≤–æ–¥–∏—Ç—å—Å—è –≤ –∫–æ–Ω—Å–æ–ª—å
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbydULT-3CWngM-jmKIuVH5f0LvcwDiSqMgEBCbR2FroObYhwKZqG_DeVc4pDa8-WL5A/exec'; 

        // --- COMPONENTS ---

        const Card = ({ children, className = "", onClick }) => (
            <div onClick={onClick} className={`bg-white rounded-2xl p-4 border border-slate-100 shadow-sm ${onClick ? 'cursor-pointer active:scale-95 transition-transform' : ''} ${className}`}>
                {children}
            </div>
        );

        const Button = ({ children, onClick, variant = 'primary', disabled = false, className = "" }) => {
            const variants = {
                primary: "bg-cyan-600 text-white shadow-lg shadow-cyan-200",
                danger: "bg-rose-500 text-white shadow-lg shadow-rose-200",
                secondary: "bg-slate-100 text-slate-600",
                gold: "bg-amber-500 text-white shadow-lg shadow-amber-200",
                disabled: "bg-slate-200 text-slate-400 cursor-not-allowed"
            };
            return (
                <button 
                    onClick={onClick} 
                    disabled={disabled}
                    className={`w-full py-4 rounded-xl font-bold text-sm uppercase tracking-wider transition-all active:scale-95 flex items-center justify-center gap-2 ${disabled ? variants.disabled : variants[variant]} ${className}`}
                >
                    {children}
                </button>
            );
        };

        // --- GOOGLE SHEETS SYNC ---
        const syncWithGoogleSheets = async (userData, actionType = 'UPDATE') => {
            const payload = {
                action: actionType,
                timestamp: new Date().toISOString(),
                telegramId: userData.telegramId,
                username: userData.username,
                firstName: userData.firstName,
                lastName: userData.lastName,
                arsenal: userData.disciplines.join(', '),
                goal: userData.goal,
                diamonds: userData.diamonds,
                streak: userData.streak,
                completedToday: userData.todayActivity.join(', ')
            };

            console.log("üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Google Sheets:", payload);

            if (GOOGLE_SCRIPT_URL) {
                try {
                    await fetch(GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors', // –í–∞–∂–Ω–æ –¥–ª—è Google Scripts
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                } catch (e) {
                    console.error("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:", e);
                }
            }
        };

        // --- MAIN APP ---

        function App() {
            // State
            const [step, setStep] = useState('loading');
            const [user, setUser] = useState({
                firstName: '',
                lastName: '',
                username: '',
                telegramId: null,
                disciplines: [],
                goal: 0,
                diamonds: 3,
                streak: 0,
                todayActivity: [],
                history: [],
                isAdmin: false
            });

            // –î–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
            const [regForm, setRegForm] = useState({ firstName: '', lastName: '' });
            const [customDiscipline, setCustomDiscipline] = useState('');
            const [isAddingCustom, setIsAddingCustom] = useState(false);

            // UI State
            const [checkInModalOpen, setCheckInModalOpen] = useState(false);
            const [adminPanelOpen, setAdminPanelOpen] = useState(false);
            const [popularSports, setPopularSports] = useState(['–ë–µ–≥', '–ó–∞–ª', '–û—Ç–∂–∏–º–∞–Ω–∏—è', '–ü–ª–∞–≤–∞–Ω–∏–µ', '–í–æ—Ä–∫–∞—É—Ç', '–í–µ–ª–æ', '–ü—Ä–∏—Å–µ–¥–∞–Ω–∏—è', '–•–æ–¥—å–±–∞']);

            // Init
            useEffect(() => {
                // Telegram setup
                const tg = window.Telegram?.WebApp;
                if (tg) {
                    tg.ready();
                    tg.expand(); // Fullscreen
                    // Set header color to match body
                    tg.setHeaderColor('#f8fafc');
                    tg.setBackgroundColor('#f8fafc');
                }

                // Check Local Storage
                const savedUser = localStorage.getItem('fitness_quarter_user');
                
                if (savedUser) {
                    const parsed = JSON.parse(savedUser);
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∞–¥–º–∏–Ω—Å–∫–∏–µ –ø—Ä–∞–≤–∞ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –≤—Ö–æ–¥–µ, –≤–¥—Ä—É–≥ —é–∑–µ—Ä–Ω–µ–π–º —Å–º–µ–Ω–∏–ª—Å—è
                    const tgUser = tg?.initDataUnsafe?.user;
                    const isAdmin = (tgUser?.username === ADMIN_USERNAME) || parsed.isAdmin;
                    
                    setUser({ ...parsed, isAdmin });
                    setStep('dashboard');
                } else {
                    // Pre-fill from Telegram if available
                    const tgUser = tg?.initDataUnsafe?.user;
                    if (tgUser) {
                        setRegForm({
                            firstName: tgUser.first_name || '',
                            lastName: tgUser.last_name || ''
                        });
                        setUser(prev => ({
                            ...prev,
                            telegramId: tgUser.id,
                            username: tgUser.username,
                            isAdmin: tgUser.username === ADMIN_USERNAME
                        }));
                    }
                    setStep('welcome');
                }
            }, []);

            // Save to LocalStorage on change
            useEffect(() => {
                if (user.firstName) { // Only save if registered
                    localStorage.setItem('fitness_quarter_user', JSON.stringify(user));
                }
            }, [user]);

            // --- Logic Helpers ---

            const calculateGoalOptions = () => {
                const now = new Date();
                const diffTime = Math.abs(now - MARATHON_START_DATE);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                
                // –ï—Å–ª–∏ –º–∞—Ä–∞—Ñ–æ–Ω –µ—â–µ –Ω–µ –Ω–∞—á–∞–ª—Å—è –∏–ª–∏ —Ç–æ–ª—å–∫–æ –Ω–∞—á–∞–ª—Å—è, diffDays = 0 (–∏–ª–∏ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ)
                // –ï—Å–ª–∏ –º–∞—Ä–∞—Ñ–æ–Ω –∏–¥–µ—Ç 10 –¥–Ω–µ–π, —Ç–æ –¥–ª—è —Ü–µ–ª–∏ 100 –æ—Å—Ç–∞–ª–æ—Å—å 90.
                
                const passed = (now < MARATHON_START_DATE) ? 0 : diffDays;
                
                const goals = [
                    { label: '–ù–æ–≤–∏—á–æ–∫', days: 30 - passed, original: 30 },
                    { label: '–ê—Ç–ª–µ—Ç', days: 60 - passed, original: 60 },
                    { label: '–¢–∏—Ç–∞–Ω', days: 100 - passed, original: 100 }
                ];

                return goals.filter(g => g.days > 0);
            };

            const handleRegistration = () => {
                if (!regForm.firstName) return;
                setUser(prev => ({ ...prev, firstName: regForm.firstName, lastName: regForm.lastName }));
                setStep('arsenal');
            };

            const toggleDiscipline = (sport) => {
                setUser(prev => {
                    const exists = prev.disciplines.includes(sport);
                    if (exists) return { ...prev, disciplines: prev.disciplines.filter(d => d !== sport) };
                    if (prev.disciplines.length >= 5) return prev;
                    return { ...prev, disciplines: [...prev.disciplines, sport] };
                });
            };

            const finalizeRegistration = (goalDays) => {
                const newUser = { ...user, goal: goalDays };
                setUser(newUser);
                // First Sync
                syncWithGoogleSheets(newUser, 'REGISTER');
                setStep('dashboard');
            };

            const handleCheckIn = (sport) => {
                const newUser = {
                    ...user,
                    todayActivity: [...user.todayActivity, sport],
                    streak: user.todayActivity.length === 0 ? user.streak + 1 : user.streak, // Streak only increments on first activity
                    history: [{ date: new Date().toISOString(), sport }, ...user.history]
                };
                setUser(newUser);
                setCheckInModalOpen(false);
                syncWithGoogleSheets(newUser, 'CHECK_IN');
            };

            const handleLogout = () => {
                if(confirm("–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –∏ –≤—ã–π—Ç–∏?")) {
                    localStorage.removeItem('fitness_quarter_user');
                    window.location.reload();
                }
            };

            // --- Views ---

            const WelcomeScreen = () => (
                <div className="min-h-screen pt-safe-top flex flex-col p-6 animate-fade-in">
                    <div className="flex-grow flex flex-col items-center justify-center text-center space-y-6">
                        <div className="w-32 h-32 bg-cyan-50 rounded-full flex items-center justify-center shadow-inner">
                            <Hexagon size={64} className="text-cyan-600 stroke-1" />
                        </div>
                        <div>
                            <h1 className="text-4xl font-display font-bold text-slate-900 mb-2">Fitness –ö–≤–∞—Ä—Ç–∞–ª</h1>
                            <p className="text-slate-500">–¢–≤–æ—è —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è —Å–ø–æ—Ä—Ç–∞</p>
                        </div>
                    </div>
                    <div className="pb-8">
                        <Button onClick={() => setStep('registration')}>–ù–∞—á–∞—Ç—å –ß–µ–ª–ª–µ–Ω–¥–∂</Button>
                    </div>
                </div>
            );

            const RegistrationScreen = () => (
                <div className="min-h-screen pt-safe-top flex flex-col p-6 animate-slide-up">
                    <h2 className="text-2xl font-display font-bold text-slate-900 mb-6">–ü—Ä–µ–¥—Å—Ç–∞–≤—å—Å—è</h2>
                    <div className="space-y-4 flex-grow">
                        <div>
                            <label className="text-xs font-bold text-slate-400 uppercase ml-1">–ò–º—è</label>
                            <input 
                                type="text" 
                                value={regForm.firstName}
                                onChange={e => setRegForm({...regForm, firstName: e.target.value})}
                                className="w-full p-4 rounded-xl bg-white border border-slate-200 font-bold focus:border-cyan-500 outline-none shadow-sm"
                                placeholder="–¢–≤–æ–µ –∏–º—è"
                            />
                        </div>
                        <div>
                            <label className="text-xs font-bold text-slate-400 uppercase ml-1">–§–∞–º–∏–ª–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                            <input 
                                type="text" 
                                value={regForm.lastName}
                                onChange={e => setRegForm({...regForm, lastName: e.target.value})}
                                className="w-full p-4 rounded-xl bg-white border border-slate-200 font-bold focus:border-cyan-500 outline-none shadow-sm"
                                placeholder="–§–∞–º–∏–ª–∏—è"
                            />
                        </div>
                    </div>
                    <div className="pb-8">
                        <Button onClick={handleRegistration} disabled={!regForm.firstName}>–î–∞–ª–µ–µ</Button>
                    </div>
                </div>
            );

            const ArsenalScreen = () => (
                <div className="min-h-screen pt-safe-top flex flex-col p-6 animate-slide-up">
                    <h2 className="text-2xl font-display font-bold text-slate-900 mb-2">–¢–≤–æ–π –ê—Ä—Å–µ–Ω–∞–ª</h2>
                    <p className="text-slate-500 text-sm mb-6">–í—ã–±–µ—Ä–∏ –¥–æ 5 –¥–∏—Å—Ü–∏–ø–ª–∏–Ω.</p>
                    
                    <div className="flex-grow overflow-y-auto pb-4">
                        <div className="flex flex-wrap gap-3">
                            {popularSports.map(sport => (
                                <button 
                                    key={sport} 
                                    onClick={() => toggleDiscipline(sport)}
                                    className={`px-5 py-3 rounded-xl font-bold text-sm border transition-all ${user.disciplines.includes(sport) ? 'bg-cyan-600 text-white border-cyan-600 shadow-md' : 'bg-white text-slate-600 border-slate-200'}`}
                                >
                                    {sport}
                                </button>
                            ))}
                            
                            {!isAddingCustom ? (
                                <button onClick={() => setIsAddingCustom(true)} className="px-5 py-3 rounded-xl font-bold text-sm border border-dashed border-slate-300 text-slate-400 flex items-center gap-2">
                                    <Plus size={16} /> –°–≤–æ—è
                                </button>
                            ) : (
                                <div className="flex items-center gap-2 w-full animate-fade-in">
                                    <input 
                                        autoFocus
                                        type="text" 
                                        value={customDiscipline}
                                        onChange={e => setCustomDiscipline(e.target.value)}
                                        className="flex-grow p-3 rounded-xl border border-cyan-500 outline-none text-sm"
                                        placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ..."
                                        onKeyDown={e => {
                                            if (e.key === 'Enter' && customDiscipline) {
                                                setPopularSports([...popularSports, customDiscipline]);
                                                toggleDiscipline(customDiscipline);
                                                setCustomDiscipline('');
                                                setIsAddingCustom(false);
                                            }
                                        }}
                                    />
                                    <button onClick={() => setIsAddingCustom(false)} className="p-3 bg-slate-200 rounded-xl"><X size={18}/></button>
                                </div>
                            )}
                        </div>
                    </div>

                    <div className="pb-8">
                        <div className="flex justify-between text-xs font-bold uppercase text-slate-400 mb-4">
                            <span>–í—ã–±—Ä–∞–Ω–æ</span>
                            <span className={user.disciplines.length > 0 ? "text-cyan-600" : ""}>{user.disciplines.length} / 5</span>
                        </div>
                        <Button onClick={() => setStep('goal')} disabled={user.disciplines.length === 0}>–î–∞–ª–µ–µ</Button>
                    </div>
                </div>
            );

            const GoalScreen = () => {
                const goals = calculateGoalOptions();
                return (
                    <div className="min-h-screen pt-safe-top flex flex-col p-6 animate-slide-up">
                        <h2 className="text-2xl font-display font-bold text-slate-900 mb-8 text-center">–¢–≤–æ—è –¶–µ–ª—å</h2>
                        <div className="flex flex-col gap-4 flex-grow justify-center">
                            {goals.map((g, idx) => (
                                <Card key={idx} onClick={() => finalizeRegistration(g.days)} className="flex items-center justify-between border-l-4 border-l-cyan-500 hover:shadow-md transition-shadow">
                                    <div>
                                        <div className="text-3xl font-display font-black text-slate-800">{g.days} <span className="text-sm font-sans font-normal text-slate-400">–î–Ω–µ–π</span></div>
                                        <div className="text-xs font-bold text-slate-400 uppercase tracking-widest mt-1">{g.label}</div>
                                    </div>
                                    <ChevronRight className="text-slate-300" />
                                </Card>
                            ))}
                            {goals.length === 0 && (
                                <p className="text-center text-rose-500">–ú–∞—Ä–∞—Ñ–æ–Ω —É–∂–µ –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è, —Ü–µ–ª–µ–π –Ω–µ—Ç!</p>
                            )}
                        </div>
                    </div>
                );
            };

            const AdminPanel = () => {
                if (!user.isAdmin) return null;
                return (
                    <div className="fixed inset-0 z-50 bg-slate-50 overflow-y-auto animate-slide-up">
                        <div className="pt-safe-top px-6 pb-6">
                            <div className="flex justify-between items-center mb-8">
                                <h2 className="text-2xl font-bold text-slate-800 flex items-center gap-2"><Shield className="text-amber-500"/> MASTER PANEL</h2>
                                <button onClick={() => setAdminPanelOpen(false)} className="p-2 bg-white border rounded-full"><X size={20}/></button>
                            </div>
                            
                            <div className="space-y-6">
                                <Card className="bg-amber-50 border-amber-200">
                                    <h3 className="font-bold text-amber-800 mb-2">–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</h3>
                                    <p className="text-xs text-amber-600 mb-4">–°–∫–∞—á–∞—Ç—å –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –≤ CSV</p>
                                    <button className="w-full py-3 bg-white border border-amber-200 rounded-xl font-bold text-amber-600 flex items-center justify-center gap-2">
                                        <Download size={16}/> –°–∫–∞—á–∞—Ç—å CSV
                                    </button>
                                </Card>

                                <div>
                                    <h3 className="text-xs font-bold text-slate-400 uppercase mb-3">–£—á–∞—Å—Ç–Ω–∏–∫–∏ (–î–µ–º–æ)</h3>
                                    {/* –ó–¥–µ—Å—å –≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –±—ã–ª –±—ã —Å–ø–∏—Å–æ–∫ –∏–∑ –ë–î */}
                                    <div className="space-y-2">
                                        <div className="bg-white p-3 rounded-xl border border-slate-100 flex justify-between">
                                            <span className="font-bold text-slate-700">@solomin_d</span>
                                            <span className="text-xs bg-emerald-100 text-emerald-600 px-2 py-1 rounded">Active</span>
                                        </div>
                                        <div className="bg-white p-3 rounded-xl border border-slate-100 flex justify-between">
                                            <span className="font-bold text-slate-700">User 2</span>
                                            <span className="text-xs bg-rose-100 text-rose-600 px-2 py-1 rounded">Frozen</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                )
            }

            const Dashboard = () => {
                const progress = Math.min((user.streak / user.goal) * 100, 100) || 0;
                
                return (
                    <div className="min-h-screen pt-safe-top pb-20 bg-slate-50">
                        {/* Header */}
                        <div className="px-6 mb-6">
                            <div className="flex justify-between items-start mb-4">
                                <div className="flex items-center gap-3" onClick={() => user.isAdmin && setAdminPanelOpen(true)}>
                                    <div className="w-12 h-12 bg-white rounded-full border border-slate-200 flex items-center justify-center font-display font-bold text-slate-700 shadow-sm relative">
                                        {user.firstName[0]}{user.lastName ? user.lastName[0] : ''}
                                        {user.isAdmin && <div className="absolute -bottom-1 -right-1 bg-amber-500 text-white rounded-full p-0.5 border-2 border-white"><Shield size={10}/></div>}
                                    </div>
                                    <div>
                                        <div className="font-bold text-slate-800 text-lg">{user.firstName}</div>
                                        <div className="text-xs text-slate-400 font-bold uppercase">–í —Å—Ç—Ä–æ—é</div>
                                    </div>
                                </div>
                                <div className="flex gap-2">
                                    <div className="bg-white px-3 py-1.5 rounded-lg border border-slate-200 flex items-center gap-2 shadow-sm">
                                        <Diamond size={16} className="text-cyan-500 fill-cyan-500"/>
                                        <span className="font-bold text-slate-700">{user.diamonds}</span>
                                    </div>
                                    <button onClick={handleLogout} className="w-9 h-9 bg-white rounded-lg border border-slate-200 flex items-center justify-center text-slate-400"><LogOut size={16}/></button>
                                </div>
                            </div>
                            
                            {/* Progress */}
                            <div className="flex justify-between text-xs font-bold text-slate-400 mb-2 uppercase">
                                <span>–î–µ–Ω—å {user.streak}</span>
                                <span>–¶–µ–ª—å {user.goal}</span>
                            </div>
                            <div className="w-full bg-slate-200 h-2 rounded-full overflow-hidden">
                                <div className="bg-cyan-500 h-full transition-all duration-1000" style={{width: `${progress}%`}}></div>
                            </div>
                        </div>

                        {/* Action Area */}
                        <div className="px-6 mb-8">
                            {user.todayActivity.length > 0 ? (
                                <Card className="text-center py-8 border-emerald-200 bg-emerald-50/50">
                                    <div className="w-16 h-16 bg-emerald-100 rounded-full flex items-center justify-center mx-auto mb-4 text-emerald-500 shadow-sm"><CheckCircle size={32}/></div>
                                    <h3 className="text-xl font-bold text-slate-800 mb-2">–û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞!</h3>
                                    <div className="flex flex-wrap gap-2 justify-center mb-6">
                                        {user.todayActivity.map(act => <span key={act} className="text-xs font-bold bg-white px-3 py-1 rounded-full border border-emerald-100 text-emerald-600">{act}</span>)}
                                    </div>
                                    <Button variant="secondary" onClick={() => setCheckInModalOpen(true)} className="py-3 text-xs h-auto"><Plus size={14}/> –î–æ–±–∞–≤–∏—Ç—å –µ—â–µ</Button>
                                </Card>
                            ) : (
                                <button 
                                    onClick={() => setCheckInModalOpen(true)}
                                    disabled={user.diamonds <= 0}
                                    className="w-full aspect-video rounded-3xl bg-white border border-slate-200 shadow-xl shadow-slate-200/50 flex flex-col items-center justify-center gap-3 active:scale-95 transition-all group relative overflow-hidden"
                                >
                                    {user.diamonds > 0 ? (
                                        <>
                                            <div className="w-16 h-16 bg-cyan-50 rounded-full flex items-center justify-center text-cyan-500 group-hover:scale-110 transition-transform"><Zap size={32} className="fill-cyan-500"/></div>
                                            <span className="text-2xl font-black text-slate-800 uppercase tracking-widest">–û–¢–ú–ï–¢–ò–¢–¨–°–Ø</span>
                                        </>
                                    ) : (
                                        <>
                                            <div className="w-16 h-16 bg-rose-50 rounded-full flex items-center justify-center text-rose-500"><X size={32}/></div>
                                            <span className="text-xl font-black text-rose-500 uppercase tracking-widest">–ó–ê–ú–û–†–û–ñ–ï–ù</span>
                                            <span className="text-xs text-slate-400">–ù—É–∂–µ–Ω –∞–ª–º–∞–∑</span>
                                        </>
                                    )}
                                </button>
                            )}
                        </div>

                        {/* Modals */}
                        {checkInModalOpen && (
                            <div className="fixed inset-0 z-50 bg-slate-900/40 backdrop-blur-sm flex items-end sm:items-center justify-center animate-fade-in p-4">
                                <div className="bg-white w-full max-w-md rounded-3xl p-6 shadow-2xl animate-slide-up">
                                    <div className="flex justify-between items-center mb-6">
                                        <h3 className="text-lg font-bold text-slate-800">–ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ?</h3>
                                        <button onClick={() => setCheckInModalOpen(false)} className="p-2 bg-slate-100 rounded-full"><X size={20}/></button>
                                    </div>
                                    <div className="space-y-3">
                                        {user.disciplines.map(d => (
                                            <button 
                                                key={d}
                                                onClick={() => handleCheckIn(d)}
                                                className="w-full p-4 rounded-xl border border-slate-100 bg-slate-50 font-bold text-slate-700 hover:bg-cyan-50 hover:border-cyan-200 hover:text-cyan-700 transition-colors text-left flex justify-between"
                                            >
                                                {d}
                                                {user.todayActivity.includes(d) && <CheckCircle size={18} className="text-emerald-500"/>}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}

                        {adminPanelOpen && <AdminPanel />}
                    </div>
                );
            };

            // --- RENDER ---
            if (step === 'loading') return null;
            if (step === 'welcome') return <WelcomeScreen />;
            if (step === 'registration') return <RegistrationScreen />;
            if (step === 'arsenal') return <ArsenalScreen />;
            if (step === 'goal') return <GoalScreen />;
            return <Dashboard />;
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
