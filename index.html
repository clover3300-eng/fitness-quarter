<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Fitness Aurora Final Design</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        aurora: {
                            bg: '#020617',
                            card: 'rgba(30, 41, 59, 0.6)', 
                            border: 'rgba(255, 255, 255, 0.1)',
                            accent: '#22d3ee'
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        display: ['Space Grotesk', 'sans-serif'],
                    },
                    animation: {
                        'aurora': 'aurora 20s ease infinite alternate',
                        'pulse-glow': 'pulseGlow 2s infinite',
                        'fade-in': 'fadeIn 0.5s ease-out forwards',
                        'slide-up': 'slideUp 0.3s ease-out forwards',
                        'expand': 'expand 0.3s ease-out forwards',
                        'float': 'float 6s ease-in-out infinite',
                        'confetti': 'confetti 3s ease-in-out infinite',
                    },
                    keyframes: {
                        aurora: { '0%': { backgroundPosition: '0% 50%' }, '100%': { backgroundPosition: '100% 50%' } },
                        pulseGlow: { '0%, 100%': { boxShadow: '0 0 15px rgba(34, 211, 238, 0.3)' }, '50%': { boxShadow: '0 0 25px rgba(34, 211, 238, 0.6)' } },
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(100%)' }, '100%': { transform: 'translateY(0)' } },
                        expand: { '0%': { height: '0', opacity: '0' }, '100%': { height: 'auto', opacity: '1' } },
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } },
                        confetti: { '0%': { transform: 'translateY(0) rotate(0)' }, '100%': { transform: 'translateY(100vh) rotate(720deg)' } }
                    }
                }
            }
        }
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@babel/standalone@7.26.9/babel.min.js"></script>

    <style>
        /* === RESET & LAYOUT === */
        html, body {
            margin: 0; padding: 0;
            width: 100%; height: 100%;
            background-color: #020617; color: #f1f5f9;
            overflow: hidden; 
            overscroll-behavior: none; 
            -webkit-tap-highlight-color: transparent;
        }

        #root {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
            position: relative;
            z-index: 10;
        }

        /* –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ñ–æ–Ω Aurora */
        .bg-aurora {
            background: linear-gradient(-45deg, #020617, #0f172a, #1e1b4b, #064e3b);
            background-size: 400% 400%;
            position: absolute; inset: 0; z-index: 0;
            animation: aurora 15s ease infinite alternate;
        }

        /* –£–ª—É—á—à–µ–Ω–Ω—ã–π —Ñ–æ–Ω –¥–ª—è –î–∞—à–±–æ—Ä–¥–∞ */
        .bg-aurora-dashboard {
            background: linear-gradient(-45deg, #0f172a, #312e81, #1e1b4b, #111827);
            background-size: 400% 400%;
            position: absolute; inset: 0; z-index: 0;
            animation: aurora 20s ease infinite alternate;
        }
        
        .glass {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }

        /* MAIN CONTENT CONTAINER */
        .content-section {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 1.5rem;
            padding-top: calc(20px + env(safe-area-inset-top)); 
            padding-bottom: 40px;
            width: 100%;
            display: flex;
            flex-direction: column;
            height: 100%;
            scroll-behavior: smooth;
        }
        
        .padding-onboarding {
             padding-top: calc(80px + env(safe-area-inset-top)); 
        }

        /* Fullscreen Modal - Fixed to cover everything */
        .modal-fullscreen {
            position: fixed; 
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 100;
            background-color: #020617; 
            display: flex; 
            flex-direction: column;
            height: 100%;
            width: 100%;
        }
        
        /* Modal content needs proper spacing from top safe area */
        .modal-content-safe {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
            padding-top: calc(20px + env(safe-area-inset-top));
            padding-bottom: 40px;
        }
        
        .text-neon {
            text-shadow: 0 0 10px rgba(34, 211, 238, 0.5);
        }

        .confetti-piece {
            position: absolute;
            width: 10px; height: 10px;
            background: #ffd300;
            top: -10px;
            z-index: 50;
        }

        .accordion-content {
            transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.4s ease-in-out;
            max-height: 0;
            opacity: 0;
            overflow: hidden;
        }
        .accordion-content.open {
            max-height: 200px;
            opacity: 1;
        }
    </style>
</head>
<body>
    <div id="bg-layer" class="bg-aurora"></div>
    <div class="fixed top-[-20%] left-[-20%] w-[80vw] h-[80vw] rounded-full bg-cyan-500/10 blur-[100px] pointer-events-none z-0"></div>
    <div class="fixed bottom-[-20%] right-[-20%] w-[80vw] h-[80vw] rounded-full bg-purple-500/10 blur-[100px] pointer-events-none z-0"></div>
    <div class="fixed top-[20%] right-[-10%] w-[60vw] h-[60vw] rounded-full bg-emerald-500/10 blur-[100px] pointer-events-none z-0"></div>

    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef, useMemo } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        import { 
            Trophy, Diamond, Zap, Camera, CheckCircle, Activity, Settings, Plus, X, 
            Hexagon, Flame, Send, Bell, Skull, Dumbbell, Ruler, Star, Crown,
            BarChart3, Users, Calendar, ChevronDown, Shield, Edit3, Save, Trash2, ArrowLeft, Clock, UserPlus, Sun, Moon, Info,
            Timer, Layers, Gauge, RefreshCw, ChevronUp, AlertTriangle, PartyPopper, Ghost, Lock, Medal
        } from 'https://esm.sh/lucide-react@0.263.1';

        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbydULT-3CWngM-jmKIuVH5f0LvcwDiSqMgEBCbR2FroObYhwKZqG_DeVc4pDa8-WL5A/exec'; 
        const ADMIN_USERNAME = 'solomin_d';
        const DEFAULT_START_DATE = new Date('2026-04-01');
        
        // Sports that don't need parameters
        const SIMPLE_SPORTS = ['–±–æ–∫—Å', '–π–æ–≥–∞', '–∑–∞—Ä—è–¥–∫–∞', '–±–æ—Ä—å–±–∞', '–¥–∂–∏—É-–¥–∂–∏—Ç—Å—É', '—Ñ–∏—Ç–±–æ–∫—Å–∏–Ω–≥', '–ø–∏–ª–∞—Ç–µ—Å', '—Ä–∞—Å—Ç—è–∂–∫–∞', '—Ç–∞–Ω—Ü—ã', '–º–µ–¥–∏—Ç–∞—Ü–∏—è', '–∫–∏–∫–±–æ–∫—Å–∏–Ω–≥', '—Ç–∞–π—Å–∫–∏–π –±–æ–∫—Å', '–≥—Ä–µ–ø–ø–ª–∏–Ω–≥'];

        // --- MOTIVATION PHRASES ---
        const MOTIVATION_PHRASES = [
            "[N], —è –≤–∏–¥–µ–ª –±–∞–±—É—à–µ–∫ –≤ –ø–∞—Ä–∫–µ, –∫–æ—Ç–æ—Ä—ã–µ –¥–µ–ª–∞—é—Ç —ç—Ç–æ –±—ã—Å—Ç—Ä–µ–µ!", 
            "–≠–π [N], –¥–∏–≤–∞–Ω –ø–æ —Ç–µ–±–µ –Ω–µ —Å–∫—É—á–∞–µ—Ç? –ê –æ–Ω —Å–∫—É—á–∞–µ—Ç!",
            "[N], –µ—Å–ª–∏ —Ç—ã —Å–µ–π—á–∞—Å —Å–¥–∞—à—å—Å—è, —è —Ä–∞—Å—Å–∫–∞–∂—É –≤—Å–µ–º —Ç–≤–æ–π —Å–µ–∫—Ä–µ—Ç...", 
            "–í—Å—Ç–∞–≤–∞–π, [N]! –ü–µ–ª—å–º–µ—à–∫–∏ —Å–∞–º–∏ —Å–µ–±—è –Ω–µ —Å–æ–∂–≥—É—Ç!", 
            "[N], —Ç—ã –º–∞—à–∏–Ω–∞ –∏–ª–∏ —Å–∞–º–æ–∫–∞—Ç? –ì–∞–∑—É–π!",
            "–°–ª—É—à–∞–π, [N], —Ç–≤–æ–∏ –º—ã—à—Ü—ã –ø–ª–∞—á—É—Ç –æ—Ç —Å–∫—É–∫–∏. –î–∞–π –∏–º –∂–∞—Ä—É!", 
            "[N], [S] —Å–¥–µ–ª–∞–ª —Å—Ç–∞–≤–∫—É, —á—Ç–æ —Ç—ã —Å–ª–∞–±–∞–∫. –î–æ–∫–∞–∂–∏ –æ–±—Ä–∞—Ç–Ω–æ–µ!", 
            "[N], –ø—Ä–µ–¥—Å—Ç–∞–≤—å, —á—Ç–æ —à—Ç–∞–Ω–≥–∞ ‚Äî —ç—Ç–æ —Ç–≤–æ–∏ –ø—Ä–æ–±–ª–µ–º—ã. –ñ–º–∏ –∏—Ö!", 
            "–ù–µ –±—É–¥—å –æ–≤–æ—â–µ–º, [N], –±—É–¥—å —Ñ—Ä—É–∫—Ç–æ–º! –°–æ—á–Ω—ã–º –∏ –º–æ—â–Ω—ã–º!", 
            "[N], –µ—â–µ –æ–¥–∏–Ω –ø–æ–¥—Ö–æ–¥, –∏ —Ç—ã –∫—Ä–∞—Å–∞–≤—á–∏–∫ (—Ö–æ—Ç—è —Ç—ã –∏ —Ç–∞–∫ –Ω–æ—Ä–º).",
            "–ê–ª—ë, [N]! –†–µ–∂–∏–º –∑–≤–µ—Ä—è –≤—ã–∫–ª—é—á–∏–ª—Å—è? –í–∫–ª—é—á–∞–π –æ–±—Ä–∞—Ç–Ω–æ!",
            "[N], —Ç—ã –ø–æ—Ç–µ–µ—à—å? –ó–Ω–∞—á–∏—Ç –Ω–µ —Ä–∂–∞–≤–µ–µ—à—å!",
            "–î–∞–≤–∞–π [N], –ø–æ–∫–∞–∂–∏ –∏–º –∫—É–∑—å–∫–∏–Ω—É –º–∞—Ç—å!",
            "[N], –±–æ–ª—å ‚Äî —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ —Å–ª–∞–±–æ—Å—Ç—å, –ø–æ–∫–∏–¥–∞—é—â–∞—è —Ç–µ–ª–æ (–∏ –Ω–µ–º–Ω–æ–≥–æ –Ω—ã—Ç—å—è).",
            "–û—Å—Ç–∞–Ω–æ–≤–∏—à—å—Å—è —Å–µ–π—á–∞—Å, [N] ‚Äî —Å—Ç–∞–Ω–µ—à—å —Å—É—Ç—É–ª–æ–π —Å–æ–±–∞–∫–æ–π. –ù–µ –Ω–∞–¥–æ —Ç–∞–∫.",
            "[N], —Ç–≤–æ–π –ø—Ä–µ—Å—Å –≥–¥–µ-—Ç–æ —Ç–∞–º, —è —Ç–æ—á–Ω–æ –∑–Ω–∞—é. –ö–æ–ø–∞–π –≥–ª—É–±–∂–µ!",
            "–í–ø–µ—Ä–µ–¥ [N]! [S] —Å–ª–µ–¥–∏—Ç –∑–∞ —Ç–æ–±–æ–π (–≤ —Ö–æ—Ä–æ—à–µ–º —Å–º—ã—Å–ª–µ).",
            "[N], —Ç—ã –ª–µ–≥–µ–Ω–¥–∞... –≤ –±—É–¥—É—â–µ–º. –ê –ø–æ–∫–∞ —Ä–∞–±–æ—Ç–∞–π!",
            "–•–≤–∞—Ç–∏—Ç –∂–∞–ª–µ—Ç—å —Å–µ–±—è, [N]! –ñ–∞–ª–µ–π —à—Ç–∞–Ω–≥—É!",
            "[N], —Å–¥–µ–ª–∞–π —ç—Ç–æ —Ä–∞–¥–∏ –ª–∞–π–∫–æ–≤ –≤ —Å—Ç–æ—Ä–∏—Å (—à—É—Ç–∫–∞, —Ä–∞–¥–∏ —Å–µ–±—è)!"
        ];

        // --- GLOBAL DATA ---
        const badgesData = [
            { id: 'streak', icon: <Flame size={14} />, color: 'text-orange-400', bg: 'bg-orange-500/20', label: '–ù–∞ –æ–≥–Ω–µ', desc: '–°—Ç—Ä–∏–∫ 3+ –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥' },
            { id: 'runner', icon: <Ruler size={14} />, color: 'text-cyan-400', bg: 'bg-cyan-500/20', label: '–ë–µ–≥—É–Ω', desc: '–ù–∞–±—Ä–∞–Ω–æ 10+ –∫–º' },
            { id: 'gym', icon: <Dumbbell size={14} />, color: 'text-purple-400', bg: 'bg-purple-500/20', label: '–¢–µ—Ä–º–∏–Ω–∞—Ç–æ—Ä', desc: '5+ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –≤ –∑–∞–ª–µ' },
            { id: 'reps', icon: <Activity size={14} />, color: 'text-emerald-400', bg: 'bg-emerald-500/20', label: '–ú–∞—à–∏–Ω–∞', desc: '500+ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π' },
            { id: 'early', icon: <Sun size={14} />, color: 'text-amber-400', bg: 'bg-amber-500/20', label: '–ñ–∞–≤–æ—Ä–æ–Ω–æ–∫', desc: '–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –¥–æ 8:00' },
            { id: 'night', icon: <Moon size={14} />, color: 'text-indigo-400', bg: 'bg-indigo-500/20', label: '–°–æ–≤–∞', desc: '–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –ø–æ—Å–ª–µ 22:00' },
            { id: 'weekend', icon: <Calendar size={14} />, color: 'text-rose-400', bg: 'bg-rose-500/20', label: '–í—ã—Ö–æ–¥–Ω–æ–π', desc: '–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –≤ –°–±/–í—Å' },
            { id: 'social', icon: <Send size={14} />, color: 'text-blue-400', bg: 'bg-blue-500/20', label: '–î—Ä—É–≥', desc: '–ü—Ä–∏–≥–ª–∞—Å–∏–ª –¥—Ä—É–≥–∞' },
            { id: 'redemption', icon: <Skull size={14} />, color: 'text-slate-400', bg: 'bg-slate-500/20', label: '–í—ã–∂–∏–≤—à–∏–π', desc: '–ö—É–ø–∏–ª –∂–∏–∑–Ω—å' },
        ];

        const ACHIEVEMENTS = [
            { id: 1, title: "–ü–µ—Ä–≤—ã–π –®–∞–≥", desc: "1 –¥–µ–Ω—å –≤ —Å—Ç—Ä–æ—é. –ù–∞—á–∞–ª–æ –ø–æ–ª–æ–∂–µ–Ω–æ!", icon: <Star size={20}/>, condition: (u) => u.streak >= 1 },
            { id: 2, title: "–ù–µ–¥–µ–ª—è –í—ã–∂–∏–≤–∞–Ω–∏—è", desc: "7 –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥. –¢—ã –Ω–µ —Å–ª–∏–ª—Å—è!", icon: <Flame size={20}/>, condition: (u) => u.streak >= 7 },
            { id: 3, title: "–ü—Ä–∏–≤—ã—á–∫–∞", desc: "21 –¥–µ–Ω—å. –¢–µ–ø–µ—Ä—å —ç—Ç–æ —á–∞—Å—Ç—å —Ç–µ–±—è.", icon: <Zap size={20}/>, condition: (u) => u.streak >= 21 },
            { id: 4, title: "–≠–∫–≤–∞—Ç–æ—Ä", desc: "50 –¥–Ω–µ–π. –ü–æ–ª–æ–≤–∏–Ω–∞ –ø—É—Ç–∏ –ø—Ä–æ–π–¥–µ–Ω–∞!", icon: <Layers size={20}/>, condition: (u) => u.streak >= 50 },
            { id: 5, title: "–õ–µ–≥–µ–Ω–¥–∞ –ú–∞—Ä–∞—Ñ–æ–Ω–∞", desc: "100 –¥–Ω–µ–π. –¢—ã –ø—Ä–æ—à–µ–ª –∏–≥—Ä—É!", icon: <Crown size={20}/>, condition: (u) => u.streak >= 100 },
            { id: 6, title: "–ë–µ–≥—É–Ω", desc: "–ù–∞–±—Ä–∞–Ω–æ 50 –∫–º —Å—É–º–º–∞—Ä–Ω–æ.", icon: <Ruler size={20}/>, condition: (u, stats) => stats.k >= 50 },
            { id: 7, title: "–¢–µ—Ä–º–∏–Ω–∞—Ç–æ—Ä", desc: "1000 –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π —Å—É–º–º–∞—Ä–Ω–æ.", icon: <Dumbbell size={20}/>, condition: (u, stats) => stats.r >= 1000 },
            { id: 8, title: "–†–∞–Ω–Ω—è—è –ü—Ç–∞—à–∫–∞", desc: "–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ (–ª—é–±–∞—è).", icon: <Sun size={20}/>, condition: (u) => u.history.length > 0 }, 
            { id: 9, title: "–í–æ–∏–Ω –ù–æ—á–∏", desc: "–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ (–ª—é–±–∞—è).", icon: <Moon size={20}/>, condition: (u) => u.history.length > 5 }
        ];

        // --- COMPONENTS ---
        const GlassCard = ({ children, className = "", onClick }) => (
            <div onClick={onClick} className={`relative glass rounded-2xl overflow-hidden ${onClick ? 'cursor-pointer active:scale-95 transition-transform' : ''} ${className}`}>
                <div className="absolute top-0 left-0 w-full h-[1px] bg-gradient-to-r from-transparent via-white/10 to-transparent"></div>
                {children}
            </div>
        );

        const NeonButton = ({ children, onClick, variant = 'primary', disabled = false, className = "", id = "" }) => {
            const v = { 
                primary: "bg-cyan-600/90 text-white shadow-lg shadow-cyan-500/20 border border-cyan-400/30 hover:bg-cyan-500", 
                danger: "bg-rose-600/90 text-white border-rose-400/30", 
                gold: "bg-amber-500/90 text-white border-amber-300/30", 
                secondary: "bg-white/5 text-white border border-white/10 hover:bg-white/10", 
                disabled: "bg-slate-800 text-slate-500 border-slate-700 cursor-not-allowed opacity-50" 
            };
            return (
                <button id={id} onClick={onClick} disabled={disabled} className={`w-full py-4 font-bold tracking-wider uppercase rounded-xl transition-all active:scale-95 flex items-center justify-center gap-2 ${disabled ? v.disabled : v[variant]} ${className}`}>
                    {children}
                </button>
            );
        };

        const Avatar = ({ name, photoUrl, size = "w-10 h-10", isUser = false }) => {
            if (photoUrl) return <img src={photoUrl} alt={name} className={`${size} rounded-full object-cover border-2 ${isUser ? 'border-cyan-400 shadow-[0_0_10px_rgba(34,211,238,0.5)]' : 'border-white/10'} shadow-md`} />;
            const initials = name ? name.slice(0, 2).toUpperCase() : "FQ";
            return (
                <div className={`${size} rounded-full bg-[#020617] flex items-center justify-center text-white font-black border ${isUser ? 'border-cyan-400' : 'border-cyan-500/50'} shadow-[0_0_15px_rgba(6,182,212,0.4)] relative overflow-hidden`}>
                     <div className="absolute inset-0 bg-gradient-to-br from-cyan-500/20 to-purple-500/20"></div>
                     <span className="relative z-10 text-neon">{initials}</span>
                </div>
            );
        };

        const ToggleSwitch = ({ checked, onChange }) => (
            <button onClick={() => onChange(!checked)} className={`w-12 h-6 rounded-full p-1 transition-colors duration-300 relative ${checked ? 'bg-cyan-500' : 'bg-slate-700'}`}>
                <div className={`w-4 h-4 rounded-full bg-white shadow-sm transition-transform duration-300 ${checked ? 'translate-x-6' : 'translate-x-0'}`} />
            </button>
        );

        // --- APP ---
        function App() {
            // STATE
            const [step, setStep] = useState('loading');
            const [user, setUser] = useState({ 
                firstName: '', lastName: '', username: '', telegramId: null, photoUrl: null, 
                disciplines: [], frequency: '', goal: 0, diamonds: 3, streak: 0, 
                todayActivity: [], history: [], status: 'active', notifications: true, notificationTime: '09:00', isAdmin: false, lastCheckInDate: null 
            });
            const [marathonStartDate, setMarathonStartDate] = useState(DEFAULT_START_DATE);
            
            // UI
            const [regForm, setRegForm] = useState({ firstName: '', lastName: '' });
            const [popularSports, setPopularSports] = useState(['–ë–µ–≥', '–ó–∞–ª', '–û—Ç–∂–∏–º–∞–Ω–∏—è', '–ü–ª–∞–≤–∞–Ω–∏–µ', '–í–æ—Ä–∫–∞—É—Ç', '–í–µ–ª–æ', '–ü—Ä–∏—Å–µ–¥–∞–Ω–∏—è', '–ü–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è', '–ü—Ä–µ—Å—Å', '–•–æ–¥—å–±–∞', '–ë–æ–∫—Å', '–ô–æ–≥–∞']);
            const [dashboardView, setDashboardView] = useState('leaderboard'); 
            const [activeModal, setActiveModal] = useState(null); 
            const [expandedUserId, setExpandedUserId] = useState(null);
            const [badgeInfo, setBadgeInfo] = useState(null);
            const [expandedMode, setExpandedMode] = useState(null);
            const [showAllLeaderboard, setShowAllLeaderboard] = useState(false);
            const [isBeastModeConfirmed, setIsBeastModeConfirmed] = useState(false); 
            const [isSavingSettings, setIsSavingSettings] = useState(false); // NEW: –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫

            // Inputs
            const [customInput, setCustomInput] = useState("");
            const [isAddingCustom, setIsAddingCustom] = useState(false);
            const [checkInCustomInput, setCheckInCustomInput] = useState("");
            const [isAddingInCheckIn, setIsAddingInCheckIn] = useState(false);
            const [adminEditSportInput, setAdminEditSportInput] = useState("");

            // Check In
            const [checkInStage, setCheckInStage] = useState('select'); 
            const [selectedSportForCheckIn, setSelectedSportForCheckIn] = useState(null);
            const [checkInValue, setCheckInValue] = useState("");

            // Admin
            const [adminDateInput, setAdminDateInput] = useState('');
            const [editUser, setEditUser] = useState(null);
            const [isAddingUser, setIsAddingUser] = useState(false);
            const [newUserNick, setNewUserNick] = useState("");
            const [isSyncing, setIsSyncing] = useState(false);

            // Ref for scrolling
            const contentRef = useRef(null);

            // Mock Data
            const [leaderboard, setLeaderboard] = useState([
                { id: 101, name: 'Alex', photoUrl: null, diamonds: 3, streak: 12, goal: 100, status: 'active', disciplines: ['–ë–µ–≥', '–í–æ—Ä–∫–∞—É—Ç'], history: [], badges: ['streak', 'runner'] },
                { id: 102, name: 'Elena', photoUrl: null, diamonds: 5, streak: 45, goal: 60, status: 'active', disciplines: ['–ó–∞–ª', '–ü–ª–∞–≤–∞–Ω–∏–µ'], history: [], badges: ['gym'] },
                { id: 103, name: 'Max', photoUrl: null, diamonds: 2, streak: 5, goal: 60, status: 'active', disciplines: ['–ó–∞–ª'], history: [], badges: [] },
                { id: 104, name: 'Dima', photoUrl: null, diamonds: 3, streak: 1, goal: 30, status: 'active', disciplines: ['–ë–µ–≥'], history: [], badges: [] },
            ]);

            // --- MOVED useMemo HERE ---
            // Build Sorted Leaderboard including Current User
            const finalLeaderboard = useMemo(() => {
                const currentUserEntry = { 
                    id: 999, // user ID
                    name: `${user.firstName} (–í—ã)`,
                    photoUrl: user.photoUrl,
                    diamonds: user.diamonds,
                    streak: user.streak,
                    goal: user.goal,
                    isUser: true,
                    badges: [] // simplistic badges for now
                };
                
                const all = [...leaderboard, currentUserEntry];
                return all.sort((a, b) => b.streak - a.streak);
            }, [leaderboard, user]);

            useEffect(() => {
                const tg = window.Telegram?.WebApp;
                if (tg) { 
                    tg.ready(); 
                    
                    // FIX: Safer fullscreen request check
                    try {
                        if (typeof tg.requestFullscreen === 'function') {
                            tg.requestFullscreen();
                        }
                    } catch (e) {
                        console.log("Fullscreen not supported");
                    }

                    tg.expand(); 
                    tg.setHeaderColor('#020617'); 
                    tg.setBackgroundColor('#020617'); 
                    
                    try {
                        if (typeof tg.enableClosingConfirmation === 'function') {
                            tg.enableClosingConfirmation();
                        }
                    } catch(e) {}
                    
                    const tgUser = tg.initDataUnsafe?.user;
                    if (tgUser) {
                        const newUserData = {
                            username: tgUser.username,
                            photoUrl: tgUser.photo_url,
                            isAdmin: tgUser.username === ADMIN_USERNAME,
                            telegramId: tgUser.id, // Ensure telegramId is set
                        };
                        setUser(prev => ({ ...prev, ...newUserData }));
                        
                        if (tgUser.first_name && !regForm.firstName) {
                            setRegForm(prev => ({ ...prev, firstName: tgUser.first_name, lastName: tgUser.last_name || '' }));
                        }
                    }
                }

                const saved = localStorage.getItem('fitness_aurora_user');
                if(saved) { 
                    let parsedUser = JSON.parse(saved);
                    if (window.Telegram?.WebApp?.initDataUnsafe?.user) {
                        const tgu = window.Telegram.WebApp.initDataUnsafe.user;
                        parsedUser.photoUrl = tgu.photo_url;
                        parsedUser.isAdmin = tgu.username === ADMIN_USERNAME;
                        parsedUser.telegramId = tgu.id;
                    }

                    // --- NEW LOGIC: RESET BUTTON IF NEW DAY ---
                    const localTodayStr = new Date().toDateString(); 
                    if (parsedUser.lastCheckInDate !== localTodayStr) {
                        parsedUser.todayActivity = []; 
                    }
                    // ------------------------------------------

                    parsedUser = checkDiamondsOnLoad(parsedUser);
                    setUser(parsedUser); 
                    setStep('dashboard'); 
                } else { setStep('welcome'); }
                
                fetchConfigDate();
            }, []);

            // BACKGROUND CHANGER & MODAL SCROLL LOCK
            useEffect(() => {
                const bg = document.getElementById('bg-layer');
                if (bg) {
                    if (step === 'dashboard') {
                        bg.className = 'bg-aurora-dashboard';
                    } else {
                        bg.className = 'bg-aurora';
                    }
                }
            }, [step]);

            // Save user state
            useEffect(() => { if(user.firstName) localStorage.setItem('fitness_aurora_user', JSON.stringify(user)); }, [user]);

            // Logic: Diamonds & Streak
            const checkDiamondsOnLoad = (usr) => {
                if (!usr.lastCheckInDate) return usr;
                const last = new Date(usr.lastCheckInDate);
                const today = new Date();
                last.setHours(0,0,0,0); today.setHours(0,0,0,0);
                const diffDays = Math.ceil(Math.abs(today - last) / (1000 * 60 * 60 * 24));
                if (diffDays === 0) return usr; 
                let allowedGap = 1; 
                if (usr.frequency === '3 —Ä–∞–∑–∞ –≤ –Ω–µ–¥–µ–ª—é' || usr.frequency === '5/2') allowedGap = 2; 
                else if (usr.frequency === '–ú–ò–ö–°' || usr.frequency === '–ù–∞ –ª–∞–π—Ç–µ') allowedGap = 3; 
                if (diffDays > allowedGap + 1) { 
                    const newDiamonds = Math.max(0, usr.diamonds - 1);
                    return { ...usr, diamonds: newDiamonds };
                }
                return usr;
            };

            const fetchConfigDate = async () => {}; 

            const getAdjustedGoals = () => {
                const daysPassed = Math.max(0, Math.ceil((new Date() - marathonStartDate) / (86400000)));
                return [ 
                    { o: 30, r: Math.max(0, 30-daysPassed), l: '–ù–æ–≤–∏—á–æ–∫', i: <Star size={20} className="text-emerald-400"/> }, 
                    { o: 60, r: Math.max(0, 60-daysPassed), l: '–ê—Ç–ª–µ—Ç', i: <Dumbbell size={20} className="text-cyan-400"/> }, 
                    { o: 100, r: Math.max(0, 100-daysPassed), l: '–ì–∏–≥–∞–Ω—Ç', i: <Crown size={20} className="text-amber-400"/> } 
                ];
            };
            
            const getUserRankTitle = (g) => { if (g >= 100) return '–ì–∏–≥–∞–Ω—Ç'; if (g >= 60) return '–ê—Ç–ª–µ—Ç'; return '–ù–æ–≤–∏—á–æ–∫'; };
            const getUserRankIcon = (g) => { if (g >= 100) return <Crown size={32} className="text-amber-400"/>; if (g >= 60) return <Dumbbell size={32} className="text-cyan-400"/>; return <Star size={32} className="text-emerald-400"/>; };
            const getStats = (hist) => { let k=0,r=0; hist.forEach(h=>{if(h.unit==='–∫–º')k+=+h.value;if(h.unit==='–ø–æ–≤—Ç')r+=+h.value;}); return {k,r}; };
            const toggleDiscipline = (s) => setUser(p => ({ ...p, disciplines: p.disciplines.includes(s) ? p.disciplines.filter(d => d !== s) : [...p.disciplines, s] }));
            
            const getUnitForSport = (sport) => { 
                const distanceSports = ['–ë–µ–≥', '–ü–ª–∞–≤–∞–Ω–∏–µ', '–í–µ–ª–æ', '–í–µ–ª–æ—Å–∏–ø–µ–¥', '–•–æ–¥—å–±–∞', '–õ—ã–∂–∏']; 
                return distanceSports.some(ds => sport.includes(ds)) ? '–∫–º' : '–ø–æ–≤—Ç'; 
            };
            
            const isGymWorkout = (sport) => {
                const gymWords = ['–ó–∞–ª', '–°–ø–æ—Ä—Ç–∑–∞–ª', '–ö–∞—á–∞–ª–∫–∞', '–§–∏—Ç–Ω–µ—Å'];
                return gymWords.some(w => sport.includes(w));
            };

            // DYNAMIC ACHIEVEMENTS
            const generateAchievements = (disciplines) => {
                const isRun = disciplines.some(d => ['–ë–µ–≥', '–•–æ–¥—å–±–∞', '–õ—ã–∂–∏'].includes(d));
                const isGym = disciplines.some(d => ['–ó–∞–ª', '–°–ø–æ—Ä—Ç–∑–∞–ª', '–í–æ—Ä–∫–∞—É—Ç', '–û—Ç–∂–∏–º–∞–Ω–∏—è', '–¢—É—Ä–Ω–∏–∫'].includes(d));
                const isSwim = disciplines.includes('–ü–ª–∞–≤–∞–Ω–∏–µ');

                const base = [
                    { id: 2, title: "–ù–µ–¥–µ–ª—è –í—ã–∂–∏–≤–∞–Ω–∏—è", desc: "7 –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥. –¢—ã –Ω–µ —Å–ª–∏–ª—Å—è!", icon: <Flame size={20}/>, condition: (u) => u.streak >= 7 },
                    { id: 3, title: "–ü—Ä–∏–≤—ã—á–∫–∞", desc: "21 –¥–µ–Ω—å. –¢–µ–ø–µ—Ä—å —ç—Ç–æ —á–∞—Å—Ç—å —Ç–µ–±—è.", icon: <Zap size={20}/>, condition: (u) => u.streak >= 21 },
                    { id: 4, title: "–≠–∫–≤–∞—Ç–æ—Ä", desc: "50 –¥–Ω–µ–π. –ü–æ–ª–æ–≤–∏–Ω–∞ –ø—É—Ç–∏ –ø—Ä–æ–π–¥–µ–Ω–∞!", icon: <Layers size={20}/>, condition: (u) => u.streak >= 50 },
                    { id: 5, title: "–õ–µ–≥–µ–Ω–¥–∞ –ú–∞—Ä–∞—Ñ–æ–Ω–∞", desc: "100 –¥–Ω–µ–π. –¢—ã –ø—Ä–æ—à–µ–ª –∏–≥—Ä—É!", icon: <Crown size={20}/>, condition: (u) => u.streak >= 100 },
                    { id: 8, title: "–†–∞–Ω–Ω—è—è –ü—Ç–∞—à–∫–∞", desc: "–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ (–ª—é–±–∞—è).", icon: <Sun size={20}/>, condition: (u) => u.history.length > 0 }, 
                    { id: 9, title: "–í–æ–∏–Ω –ù–æ—á–∏", desc: "–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ (–ª—é–±–∞—è).", icon: <Moon size={20}/>, condition: (u) => u.history.length > 5 }
                ];

                if (isRun) base.push({ id: 6, title: "–§–æ—Ä–µ—Å—Ç –ì–∞–º–ø", desc: "–ù–∞–±—Ä–∞–Ω–æ 50 –∫–º —Å—É–º–º–∞—Ä–Ω–æ.", icon: <Ruler size={20}/>, condition: (u, stats) => stats.k >= 50 });
                if (isGym) base.push({ id: 7, title: "–ñ–µ–ª–µ–∑–Ω—ã–π –ß–µ–ª–æ–≤–µ–∫", desc: "1000 –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π —Å—É–º–º–∞—Ä–Ω–æ.", icon: <Dumbbell size={20}/>, condition: (u, stats) => stats.r >= 1000 });
                if (isSwim) base.push({ id: 10, title: "–ê–∫–≤–∞–º–µ–Ω", desc: "–ü—Ä–æ–ø–ª—ã–≤–∏ 10 –∫–º —Å—É–º–º–∞—Ä–Ω–æ", icon: <Activity size={20}/>, condition: (u, stats) => stats.k >= 10 });
                
                // Fill if less than 9
                if (base.length < 9) {
                     base.push({ id: 11, title: "–£–ø–æ—Ä—Å—Ç–≤–æ", desc: "–°–¥–µ–ª–∞–π 10 –æ—Ç–º–µ—Ç–æ–∫", icon: <CheckCircle size={20}/>, condition: (u) => u.history.length >= 10 });
                }
                
                return base.slice(0, 9);
            };

            // UPDATE: CheckInComplete now accepts optional sport and unit
            const handleCheckInComplete = (val, sportOverride = null, unitOverride = null) => {
                const sport = sportOverride || selectedSportForCheckIn;
                const unit = unitOverride || (isGymWorkout(sport) ? '—Ç–∏–ø' : getUnitForSport(sport));
                const now = new Date();
                const todayStr = now.toDateString();
                const dateDisplay = now.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' }); 
                const isNewDay = user.lastCheckInDate !== todayStr;
                let newStreak = isNewDay ? user.streak + 1 : user.streak;
                let newDiamonds = user.diamonds;
                if (isNewDay && newStreak % 7 === 0 && newDiamonds < 3) { newDiamonds++; alert("üíé –ê–ª–º–∞–∑ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∑–∞ —Å—Ç—Ä–∏–∫!"); }
                setUser(prev => ({ ...prev, streak: newStreak, diamonds: newDiamonds, lastCheckInDate: todayStr, todayActivity: [...prev.todayActivity, sport], history: [{date: dateDisplay, fullDate: now.toISOString(), sport, value: val, unit}, ...prev.history] }));
                setActiveModal(null); setCheckInStage('select'); setCheckInValue("");
            };

            // UPDATE: Handle sport select (detect simple sports)
            const handleSportSelection = (sportName) => {
                const isSimple = SIMPLE_SPORTS.some(s => sportName.toLowerCase().includes(s));
                
                if (isSimple) {
                    handleCheckInComplete("–í—ã–ø–æ–ª–Ω–µ–Ω–æ", sportName, "—Ç—Ä–µ–Ω");
                } else {
                    setSelectedSportForCheckIn(sportName);
                    setCheckInStage('value');
                }
            };

            const addCustomSport = (name, checkIn = false) => {
                if(!name.trim()) return;
                setPopularSports(p => [...p, name]); setUser(p => ({...p, disciplines: [...p.disciplines, name]}));
                if(checkIn) { 
                     // Check if custom sport is simple
                     if (SIMPLE_SPORTS.some(s => name.toLowerCase().includes(s))) {
                         handleCheckInComplete("–í—ã–ø–æ–ª–Ω–µ–Ω–æ", name, "—Ç—Ä–µ–Ω");
                     } else {
                         setSelectedSportForCheckIn(name); setCheckInStage('value'); 
                     }
                }
                setIsAddingCustom(false); setIsAddingInCheckIn(false); setCustomInput(""); setCheckInCustomInput("");
            };
            
            const handleAdminUpdateDate = async () => {
                if (!adminDateInput) return; setIsSyncing(true);
                try { await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'UPDATE_DATE', date: adminDateInput }) }); setMarathonStartDate(new Date(adminDateInput)); alert("–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!"); } catch (e) { setMarathonStartDate(new Date(adminDateInput)); alert("–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞ (–ª–æ–∫–∞–ª—å–Ω–æ)!"); } finally { setIsSyncing(false); }
            };
            
            const openAdmin = () => { setActiveModal('admin'); setAdminDateInput(marathonStartDate.toISOString().split('T')[0]); fetchConfigDate(); };
            const handleDeleteAccount = () => { if(confirm("–£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç?")) { localStorage.removeItem('fitness_aurora_user'); window.location.reload(); } };

            const sendMotivation = (targetName) => {
                const sender = user.firstName || "–ê–Ω–æ–Ω–∏–º";
                const phraseTemplate = MOTIVATION_PHRASES[Math.floor(Math.random() * MOTIVATION_PHRASES.length)];
                const msg = phraseTemplate.replace("[N]", targetName).replace("[S]", sender);
                if (window.Telegram?.WebApp?.showPopup) { window.Telegram.WebApp.showPopup({ title: '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ üöÄ', message: `–ü—É—à –¥–ª—è ${targetName}:\n"${msg}"`, buttons: [{id: 'ok', type: 'ok'}] }); } else { alert(`–ü—É—à –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω ${targetName}:\n"${msg}"`); }
            };

            // SCROLL TO TOP
            const handleShowAll = (show) => {
                setShowAllLeaderboard(show);
                if (!show && contentRef.current) {
                    contentRef.current.scrollTo({ top: 0, behavior: 'smooth' });
                }
            };

            // --- –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –°–û–•–†–ê–ù–ï–ù–ò–Ø –ù–ê–°–¢–†–û–ï–ö ---
            const saveSettingsToCloud = async () => {
                const tgUserId = window.Telegram?.WebApp?.initDataUnsafe?.user?.id || user.telegramId;

                if (!tgUserId) {
                    alert("–û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.");
                    // –î–ª—è —Ç–µ—Å—Ç–∞ –≤ –±—Ä–∞—É–∑–µ—Ä–µ –º–æ–∂–Ω–æ —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ñ–∏–∫—Ç–∏–≤–Ω—ã–π ID:
                    // const dummyId = "TEST_USER_ID";
                }

                setIsSavingSettings(true);

                const payload = {
                    action: 'SAVE_SETTINGS',
                    telegramId: tgUserId,
                    name: user.username ? `@${user.username}` : user.firstName,
                    time: user.notificationTime,
                    isOn: user.notifications
                };

                try {
                    await fetch(GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (window.Telegram?.WebApp?.showPopup) {
                        window.Telegram.WebApp.showPopup({ title: '–£—Å–ø–µ—Ö', message: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!' });
                    } else {
                        alert('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
                    }
                    setActiveModal(null);
                } catch (e) {
                    alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: " + e.message);
                } finally {
                    setIsSavingSettings(false);
                }
            };

            const renderCheckInModal = () => {
                const isGym = selectedSportForCheckIn && isGymWorkout(selectedSportForCheckIn);
                const currentUnit = selectedSportForCheckIn ? getUnitForSport(selectedSportForCheckIn) : '';
                
                return (
                    <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/80 backdrop-blur-sm animate-fade-in" onClick={() => setActiveModal(null)}>
                        <div className="w-full max-w-md bg-[#0f172a] rounded-t-3xl sm:rounded-3xl p-6 border-t sm:border border-white/10 relative" onClick={e => e.stopPropagation()}>
                            <div className="w-12 h-1.5 bg-slate-700 rounded-full mx-auto mb-6 sm:hidden"></div>
                            {checkInStage === 'select' && (
                                <div className="animate-slide-up">
                                    <h3 className="text-xl font-bold text-white mb-4">–í–´–ë–ï–†–ò –ê–ö–¢–ò–í–ù–û–°–¢–¨</h3>
                                    <div className="flex flex-wrap gap-2 mb-4">
                                        {[...user.disciplines, ...popularSports].filter((v, i, a) => a.indexOf(v) === i).map(s => (
                                            <button key={s} onClick={() => handleSportSelection(s)} className="px-4 py-3 bg-white/5 border border-white/10 rounded-xl text-sm font-bold text-slate-300 hover:bg-cyan-500/20 hover:text-cyan-400 hover:border-cyan-500/50 transition-all">{s}</button>
                                        ))}
                                    </div>
                                    {!isAddingInCheckIn ? (
                                        <button onClick={() => setIsAddingInCheckIn(true)} className="w-full p-4 border border-dashed border-slate-700 rounded-xl text-slate-500 flex items-center justify-center gap-2 hover:text-white transition-colors"><Plus size={18}/> –î—Ä—É–≥–∞—è</button>
                                    ) : (
                                        <div className="flex gap-2"><input value={checkInCustomInput} onChange={e => setCheckInCustomInput(e.target.value)} className="flex-1 bg-slate-900 border border-cyan-500 rounded-xl px-4 text-white outline-none" autoFocus placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ..." /><button onClick={() => addCustomSport(checkInCustomInput, true)} className="p-3 bg-cyan-600 rounded-xl text-white"><CheckCircle size={20} /></button></div>
                                    )}
                                </div>
                            )}
                            {checkInStage === 'value' && (
                                <div className="animate-fade-in text-center">
                                    <button onClick={() => setCheckInStage('select')} className="absolute top-6 left-6 text-slate-500 hover:text-white"><ArrowLeft size={24} /></button>
                                    <h3 className="text-xl font-bold text-cyan-400 mb-1 uppercase">{selectedSportForCheckIn}</h3>
                                    
                                    {isGym ? (
                                        <div className="space-y-4 mb-4">
                                            <p className="text-slate-500 text-sm mb-4">–ß—Ç–æ —Å–µ–≥–æ–¥–Ω—è –∫–∞—á–∞–ª?</p>
                                            <div className="grid grid-cols-2 gap-3">
                                                <NeonButton variant="secondary" onClick={() => handleCheckInComplete("–í—Å–µ —Ç–µ–ª–æ")}>–í—Å–µ —Ç–µ–ª–æ</NeonButton>
                                                <NeonButton variant="secondary" onClick={() => handleCheckInComplete("–í–µ—Ä—Ö")}>–í–µ—Ä—Ö</NeonButton>
                                                <NeonButton variant="secondary" onClick={() => handleCheckInComplete("–ù–∏–∑")}>–ù–∏–∑</NeonButton>
                                                <NeonButton variant="secondary" onClick={() => handleCheckInComplete("–ö–∞—á–∞–ª –≥–æ–ª–æ–≤–æ–π")}>–ö–∞—á–∞–ª –≥–æ–ª–æ–≤–æ–π</NeonButton>
                                            </div>
                                        </div>
                                    ) : (
                                        <>
                                            <p className="text-slate-500 text-sm mb-6">–°–∫–æ–ª—å–∫–æ {currentUnit === '–∫–º' ? '–ø—Ä–æ—à–µ–ª/–ø—Ä–æ–±–µ–∂–∞–ª' : '—Å–¥–µ–ª–∞–ª'}?</p>
                                            <div className="flex items-center justify-center gap-4 mb-8"><input type="number" value={checkInValue} onChange={e => setCheckInValue(e.target.value)} className="w-32 bg-transparent text-5xl font-black text-white text-center border-b-2 border-cyan-500 outline-none pb-2" autoFocus placeholder="0" /><span className="text-xl font-bold text-slate-500 mt-4">{currentUnit}.</span></div>
                                            <NeonButton onClick={() => handleCheckInComplete(checkInValue)}>–ó–ê–ü–ò–°–ê–¢–¨</NeonButton>
                                        </>
                                    )}
                                </div>
                            )}
                        </div>
                    </div>
                );
            };

            // --- SCREENS ---
            if (step === 'welcome') return (
                <div className="content-section items-center justify-center padding-onboarding">
                    <div className="relative w-48 h-48 flex items-center justify-center mb-8"><div className="absolute inset-0 bg-cyan-500 blur-[80px] opacity-40 rounded-full animate-pulse"></div><Hexagon size={140} className="text-cyan-400 stroke-[1.5] animate-float" /><Activity size={60} className="text-white absolute" /></div>
                    <h1 className="text-5xl font-black text-white mb-2 text-center tracking-tighter">FITNESS<br/><span className="text-cyan-400">–ö–í–ê–†–¢–ê–õ</span></h1>
                    <p className="text-slate-400 text-sm mb-12 tracking-widest uppercase">–¢–≤–æ–π –ø—É—Ç—å –∫ –≤–µ–ª–∏—á–∏—é</p>
                    <div className="mt-auto w-full max-w-xs"><NeonButton onClick={() => setStep('registration')}>–ù–ê–ß–ê–¢–¨</NeonButton></div>
                </div>
            );
            
            if (step === 'registration') return (
                <div className="content-section padding-onboarding">
                    <div className="mb-6"><h2 className="text-xl font-bold text-white">–†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø</h2></div>
                    <div className="space-y-4 flex-grow pt-4">
                        <input placeholder="–ò–º—è" value={regForm.firstName} onChange={e => setRegForm({...regForm, firstName: e.target.value})} className="w-full p-4 bg-white/5 rounded-xl text-white border border-white/10 outline-none focus:border-cyan-500 transition-colors placeholder:text-slate-500 font-bold" />
                        <input placeholder="–§–∞–º–∏–ª–∏—è (–º–æ–∂–Ω–æ –ø—Å–µ–≤–¥–æ–Ω–∏–º)" value={regForm.lastName} onChange={e => setRegForm({...regForm, lastName: e.target.value})} className="w-full p-4 bg-white/5 rounded-xl text-white border border-white/10 outline-none focus:border-cyan-500 transition-colors placeholder:text-slate-500 font-bold" />
                    </div>
                    <div className="mt-auto w-full">
                        <NeonButton onClick={() => { setUser(p => ({...p, ...regForm})); setStep('arsenal'); }} disabled={!regForm.firstName}>–î–ê–õ–ï–ï</NeonButton>
                    </div>
                </div>
            );

            if (step === 'arsenal') return (
                <div className="content-section padding-onboarding">
                    <div className="flex justify-between items-center mb-6"><h2 className="text-xl font-bold text-white">–ê–†–°–ï–ù–ê–õ</h2><span className="text-xs text-cyan-400 font-mono">{user.disciplines.length} –í–´–ë–†–ê–ù–û</span></div>
                    <p className="text-slate-400 text-sm mb-6 leading-relaxed">–í—ã–±–µ—Ä–∏ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥–µ—à—å –≤—ã–ø–æ–ª–Ω—è—Ç—å.</p>
                    <div className="flex flex-wrap gap-3 mb-6">{popularSports.map(s => (<button key={s} onClick={() => toggleDiscipline(s)} className={`px-5 py-3 rounded-xl text-sm font-bold border transition-all ${user.disciplines.includes(s) ? 'bg-cyan-600/20 text-cyan-400 border-cyan-500' : 'bg-white/5 text-slate-400 border-white/10'}`}>{s}</button>))}</div>
                    {!isAddingCustom ? (
                        <button onClick={() => setIsAddingCustom(true)} className="w-full p-4 border border-dashed border-slate-600 rounded-xl text-slate-400 flex items-center justify-center gap-2 hover:border-cyan-500 hover:text-cyan-400 transition-colors"><Plus size={18}/> –î–æ–±–∞–≤–∏—Ç—å —Å–≤–æ—é</button>
                    ) : (
                        <div className="flex gap-2 mb-4 animate-fade-in"><input value={customInput} onChange={e=>setCustomInput(e.target.value)} className="flex-1 bg-slate-900 border border-cyan-500 rounded-xl px-4 text-white outline-none" autoFocus placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ..." /><button onClick={()=>addCustomSport(customInput)} className="p-3 bg-cyan-600 rounded-xl text-white"><CheckCircle/></button></div>
                    )}
                    <div className="mt-auto flex gap-3 w-full">
                        <NeonButton variant="secondary" onClick={() => setStep('registration')}>–ù–ê–ó–ê–î</NeonButton>
                        <NeonButton onClick={() => setStep('frequency')} disabled={user.disciplines.length === 0 || isAddingCustom}>–î–ê–õ–ï–ï</NeonButton>
                    </div>
                </div>
            );

            if (step === 'frequency') return (
                <div className="content-section padding-onboarding">
                     <div className="mb-6"><h2 className="text-xl font-bold text-white">–†–ï–ñ–ò–ú</h2></div>
                     <p className="text-slate-400 text-sm mb-6">–ö–∞–∫ —á–∞—Å—Ç–æ –ø–ª–∞–Ω–∏—Ä—É–µ—à—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∞—Ç—å—Å—è?</p>
                     <div className="space-y-3 flex-grow">
                        {[
                            { id: '–ö–∞–∂–¥—ã–π –¥–µ–Ω—å', icon: <Flame size={18} className="text-orange-400"/>, title: '–ü—É—Ç—å –°–∞–º—É—Ä–∞—è', desc: '–î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞ —Å—Ç–∞–ª–∏. –ò–¥–µ–∞–ª—å–Ω–æ –¥–ª—è —É—Ç—Ä–µ–Ω–Ω–µ–π –∑–∞—Ä—è–¥–∫–∏, –æ—Ç–∂–∏–º–∞–Ω–∏–π, –ø—Ä–∏—Å–µ–¥–∞–Ω–∏–π. –¢—ã —Å—Ç—Ä–æ–∏—à—å –ø—Ä–∏–≤—ã—á–∫—É –∫–∞–∂–¥—ã–π –¥–µ–Ω—å.' },
                            { id: '5/2', icon: <Star size={18} className="text-pink-400"/>, title: '–†–µ–∂–∏–º –ü—Ä–æ—Ñ–∏', desc: '–°–µ—Ä—å–µ–∑–Ω—ã–π –ø–æ–¥—Ö–æ–¥. 5 –¥–Ω–µ–π —Ä–∞–±–æ—Ç—ã, 2 –¥–Ω—è –æ—Ç–¥—ã—Ö–∞. –ò–¥–µ–∞–ª—å–Ω–æ –ª–æ–∂–∏—Ç—Å—è –Ω–∞ —Ä–∞–±–æ—á—É—é –Ω–µ–¥–µ–ª—é. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å —Å –ø—Ä–∞–≤–æ–º –Ω–∞ –≤—ã—Ö–æ–¥–Ω—ã–µ.' },
                            { id: '3 —Ä–∞–∑–∞ –≤ –Ω–µ–¥–µ–ª—é', icon: <Activity size={18} className="text-cyan-400"/>, title: '–°–∏–ª–∞ –¢–∏—Ç–∞–Ω–∞', desc: '–ö–ª–∞—Å—Å–∏–∫–∞ –∂–∞–Ω—Ä–∞. –õ—É—á—à–∏–π –≤—ã–±–æ—Ä –¥–ª—è —Å–ø–æ—Ä—Ç–∑–∞–ª–∞. –î–µ–Ω—å –ø–∞—à–µ—à—å ‚Äî –¥–µ–Ω—å —Ä–∞—Å—Ç–µ—à—å. –ë–∞–ª–∞–Ω—Å —Å–∏–ª—ã –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è.' },
                            { id: '–ú–ò–ö–°', icon: <Layers size={18} className="text-purple-400"/>, title: '–°—Ç—Ä–∞—Ç–µ–≥', desc: '–ì–∏–±–∫–∏–π –ø–æ–¥—Ö–æ–¥. –ß—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–≥–æ—Ä–µ—Ç—å –≤ –∑–∞–ª–µ, –Ω–æ –∏ –Ω–µ –∑–∞—Ä–∂–∞–≤–µ—Ç—å. –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –ø–æ —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏—é.' },
                            { id: '–ù–∞ –ª–∞–π—Ç–µ', icon: <Sun size={18} className="text-emerald-400"/>, title: '–ò–Ω–∏—Ü–∏–∞—Ü–∏—è', desc: '–î–ª—è —Ç–µ—Ö, –∫—Ç–æ —Ç–æ–ª—å–∫–æ –Ω–∞—á–∏–Ω–∞–µ—Ç. –ì–ª–∞–≤–Ω–æ–µ ‚Äî –Ω–µ –±—Ä–æ—Å–∏—Ç—å. –ú—è–≥–∫–∏–π –≤—Ö–æ–¥ –≤ –º–∏—Ä –≤–µ–ª–∏—á–∏—è.' }
                        ].map((opt) => (
                            <div key={opt.id} className={`overflow-hidden rounded-2xl glass transition-all duration-300 border ${user.frequency === opt.id ? 'border-cyan-500/50' : 'border-transparent'}`}>
                                <div onClick={() => { setUser(p => ({...p, frequency: opt.id})); setExpandedMode(expandedMode === opt.id ? null : opt.id); }} className={`p-5 flex justify-between items-center cursor-pointer ${user.frequency === opt.id ? 'bg-cyan-600/10' : 'hover:bg-white/5'}`}>
                                    <div className="flex items-center gap-3">
                                        {opt.icon}
                                        <span className={`font-bold ${user.frequency === opt.id ? 'text-cyan-400' : 'text-white'}`}>{opt.id}</span>
                                    </div>
                                    <div className="flex items-center gap-2">
                                         {user.frequency === opt.id && <CheckCircle size={14} className="text-cyan-400"/>}
                                         <ChevronDown size={16} className={`text-slate-500 transition-transform duration-300 ${expandedMode === opt.id ? 'rotate-180' : ''}`}/>
                                    </div>
                                </div>
                                <div className={`accordion-content ${expandedMode === opt.id ? 'open' : ''}`}>
                                    <div className="p-4 bg-black/20 text-sm text-slate-300 border-t border-white/5">
                                        <div className="font-bold text-white mb-1">{opt.title}</div>
                                        {opt.desc}
                                    </div>
                                </div>
                            </div>
                        ))}
                     </div>
                     <div className="mt-auto flex gap-3 w-full">
                        <NeonButton variant="secondary" onClick={() => setStep('arsenal')}>–ù–ê–ó–ê–î</NeonButton>
                        <NeonButton onClick={() => setStep('goal')} disabled={!user.frequency}>–î–ê–õ–ï–ï</NeonButton>
                     </div>
                </div>
            );

            if (step === 'goal') return (
                <div className="content-section padding-onboarding">
                    <div className="mb-6"><h2 className="text-xl font-bold text-white">–í–´–ë–û–† –¶–ï–õ–ò</h2></div>
                    <div className="space-y-4 flex-grow">
                        {getAdjustedGoals().map((g, idx) => (
                            <GlassCard key={idx} onClick={() => { setUser(p => ({...p, goal: g.o})); }} className={`p-6 flex items-center justify-between group transition-colors cursor-pointer border ${user.goal === g.o ? 'border-cyan-500 bg-cyan-900/20' : 'border-white/10 hover:border-cyan-500/50'}`}>
                                <div><span className="text-4xl font-black text-white">{g.r} <span className="text-sm font-medium text-slate-400">–î–Ω–µ–π</span></span><div className="text-xs text-cyan-400 uppercase mt-1 font-bold tracking-widest">{g.l}</div></div>
                                <div className="w-14 h-14 rounded-full bg-white/5 flex items-center justify-center border border-white/10 group-hover:bg-cyan-500/20 transition-colors">{g.i}</div>
                            </GlassCard>
                        ))}
                    </div>
                    <div className="mt-auto w-full flex gap-3">
                         <NeonButton variant="secondary" onClick={() => setStep('frequency')}>–ù–ê–ó–ê–î</NeonButton>
                         <NeonButton onClick={() => setStep('celebration')} disabled={user.goal === 0}>–î–ê–õ–ï–ï</NeonButton>
                    </div>
                </div>
            );

            if (step === 'celebration') return (
                <div className="content-section items-center justify-center relative overflow-hidden padding-onboarding">
                    <div className="absolute inset-0 pointer-events-none">
                        {[...Array(20)].map((_, i) => (
                            <div key={i} className="confetti-piece" style={{ left: `${Math.random()*100}%`, animationDelay: `${Math.random()*2}s`, backgroundColor: ['#ff0000', '#00ff00', '#0000ff', '#ffff00'][Math.floor(Math.random()*4)] }}></div>
                        ))}
                    </div>
                    <div className="relative z-10 text-center">
                        <div className="mb-6 inline-block p-6 rounded-full bg-cyan-500/10 border border-cyan-400/30 animate-pulse-glow">
                             <PartyPopper size={64} className="text-cyan-400"/>
                        </div>
                        <h1 className="text-4xl font-black text-white mb-4">–¢–´ –í –ò–ì–†–ï,<br/>–õ–ï–ì–ï–ù–î–ê!</h1>
                        <p className="text-slate-300 text-lg mb-8 max-w-xs mx-auto leading-relaxed">
                            –û—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ: —Ç—ã —Ç–µ–ø–µ—Ä—å –Ω–µ –ø—Ä–æ—Å—Ç–æ —á–µ–ª–æ–≤–µ–∫, —Ç—ã ‚Äî –º–∞—à–∏–Ω–∞ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ —Å–±–æ—Ä–∫–∏. –ù–µ —Å–±–∞–≤–ª—è–π –æ–±–æ—Ä–æ—Ç—ã!
                        </p>
                        
                        <div onClick={() => setIsBeastModeConfirmed(!isBeastModeConfirmed)} className="flex items-center gap-3 p-4 rounded-xl border cursor-pointer transition-all duration-300 mb-8 max-w-xs mx-auto text-left bg-white/5 border-white/10 hover:border-cyan-500/50">
                            <div className={`w-6 h-6 rounded-md border flex items-center justify-center transition-colors ${isBeastModeConfirmed ? 'bg-cyan-500 border-cyan-500' : 'border-slate-500'}`}>
                                {isBeastModeConfirmed && <CheckCircle size={16} className="text-white"/>}
                            </div>
                            <span className="text-sm font-bold text-white uppercase">–Ø –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é –∞–∫—Ç–∏–≤–∞—Ü–∏—é —Ä–µ–∂–∏–º–∞ –∑–≤–µ—Ä—è</span>
                        </div>
                    </div>
                    <div className="mt-auto w-full">
                        <NeonButton onClick={() => setStep('dashboard')} variant="primary" disabled={!isBeastModeConfirmed}>–ü–û–ì–ù–ê–õ–ò üöÄ</NeonButton>
                    </div>
                </div>
            );

            // --- DASHBOARD ---
            const progressPercent = Math.min((user.streak / user.goal) * 100, 100);
            
            const displayedLeaderboard = showAllLeaderboard ? finalLeaderboard : finalLeaderboard.slice(0, 3);
            const userAchievements = generateAchievements(user.disciplines).map(ach => ({
                ...ach,
                unlocked: ach.condition(user, getStats(user.history))
            }));
            
            return (
                <div className="content-section space-y-8" ref={contentRef}>
                    
                    {/* Profile Header */}
                    <div className="mb-6 mt-4"> 
                        <div className="flex justify-between items-center mb-6">
                            <h1 className="text-sm font-bold text-white tracking-[0.2em] opacity-80">–ü–†–û–§–ò–õ–¨</h1>
                            <div className="flex gap-2 mt-4"> {/* Lowered icons */}
                                {user.isAdmin && <button onClick={openAdmin} className="w-10 h-10 flex items-center justify-center rounded-lg bg-amber-500/10 text-amber-500 border border-amber-500/30 hover:bg-amber-500/20 transition-colors"><Shield size={18} /></button>}
                                <div onClick={() => setActiveModal('shop')} className="bg-white/5 border border-white/10 rounded-lg px-3 py-1.5 flex items-center gap-2 cursor-pointer hover:bg-white/10 transition-colors"><Diamond size={16} className="text-cyan-400 fill-cyan-400" /><span className="font-bold text-white text-sm">{user.diamonds}</span></div>
                                <button onClick={() => setActiveModal('settings')} className="w-10 h-10 flex items-center justify-center rounded-lg bg-white/5 border border-white/10 hover:bg-white/10 text-slate-400 transition-colors"><Settings size={18} /></button>
                            </div>
                        </div>
                        
                        <div className="flex justify-between items-center mb-4">
                            <div className="flex items-center gap-3">
                                <Avatar name={user.firstName} photoUrl={user.photoUrl} size="w-12 h-12" />
                                <div><div className="font-bold text-white text-lg leading-tight">{user.firstName}</div><div className="text-[11px] uppercase mt-0.5 font-medium"><span className="text-slate-500">–°—Ç–∞—Ç—É—Å: </span><span className="text-emerald-400 text-neon">–í —Å—Ç—Ä–æ—é</span></div></div>
                            </div>
                            
                            {/* UPDATED: Display Mode on the right */}
                            <div className="text-right">
                                <div className="text-[10px] text-slate-500 font-bold uppercase tracking-widest mb-0.5">–†–µ–∂–∏–º</div>
                                <div className="text-xs font-bold text-slate-400">{user.frequency || "–ù–µ –≤—ã–±—Ä–∞–Ω"}</div>
                            </div>
                        </div>

                        <div className="w-full">
                            <div className="flex justify-between text-[10px] font-bold text-slate-400 mb-1 uppercase tracking-widest"><span>{user.streak} Days Streak</span><span>Goal: {user.goal}</span></div>
                            <div className="w-full bg-slate-800/50 h-1.5 rounded-full overflow-hidden relative"><div className="bg-gradient-to-r from-emerald-500 via-cyan-500 to-purple-500 h-full shadow-[0_0_10px_rgba(16,185,129,0.5)]" style={{ width: `${progressPercent}%` }}></div></div>
                        </div>
                    </div>
                    
                    {/* Check-in Block (Dynamic) */}
                    {/* UPDATE: Added onClick for navigation when in progress view */}
                    <div 
                        onClick={() => { if(dashboardView === 'progress') setDashboardView('leaderboard'); }}
                        className={`transition-all duration-500 ${dashboardView === 'progress' ? 'scale-95 opacity-80 mb-0 cursor-pointer' : 'mb-6'}`}
                    >
                        {user.todayActivity.length > 0 ? (
                            <GlassCard className="p-6 text-center bg-emerald-900/10 border-emerald-500/30 relative z-0">
                                <div className="inline-flex items-center justify-center w-12 h-12 rounded-full bg-emerald-500/10 mb-3 text-emerald-400 shadow-[0_0_15px_rgba(16,185,129,0.2)]"><CheckCircle size={24} /></div>
                                {dashboardView !== 'progress' && (
                                    <div className="animate-fade-in">
                                        <h3 className="text-lg font-bold text-white mb-4 tracking-wide">–î–ï–ù–¨ –ó–ê–°–ß–ò–¢–ê–ù</h3>
                                        <div className="flex flex-wrap justify-center gap-2 mb-6">{user.todayActivity.map((act, i) => (<span key={i} className="px-3 py-1 bg-emerald-500/5 border border-emerald-500/20 rounded-lg text-[10px] font-bold text-emerald-300 uppercase tracking-wider">{act}</span>))}</div>
                                        <button onClick={(e) => { e.stopPropagation(); setActiveModal('checkIn'); }} className="w-full py-4 bg-white/5 border border-white/10 rounded-xl text-white font-bold hover:bg-white/10 flex items-center justify-center gap-2 text-xs uppercase tracking-widest transition-colors backdrop-blur-md relative z-10"><Plus size={14}/> –î–æ–±–∞–≤–∏—Ç—å –µ—â–µ</button>
                                    </div>
                                )}
                            </GlassCard>
                        ) : (
                            <button onClick={(e) => { if(dashboardView === 'progress') { e.stopPropagation(); setDashboardView('leaderboard'); } else { setActiveModal('checkIn'); } }} className="w-full h-44 rounded-2xl glass-panel flex flex-col items-center justify-center gap-4 active:scale-98 transition-all group hover:border-emerald-500/30">
                                <div className="p-5 bg-emerald-500/10 rounded-full text-emerald-400 group-hover:scale-110 transition-transform animate-pulse-glow shadow-lg shadow-emerald-500/20"><Zap size={40} fill="currentColor" /></div>
                                <span className="text-2xl font-black text-white uppercase tracking-[0.2em] group-hover:text-emerald-300 transition-colors">–û–¢–ú–ï–¢–ò–¢–¨–°–Ø</span>
                            </button>
                        )}
                    </div>

                    {/* Switcher & Lists */}
                    <div className="space-y-4">
                        <div className="flex justify-between items-center border-b border-white/10 pb-2">
                            <h3 className="text-xs font-bold text-slate-400 uppercase tracking-[0.2em]">{dashboardView === 'leaderboard' ? '–£–ß–ê–°–¢–ù–ò–ö–ò' : '–ú–û–ô –ü–†–û–ì–†–ï–°–°'}</h3>
                            <div className="flex gap-2">
                                <button onClick={() => setDashboardView('leaderboard')} className={`p-2 rounded-lg transition-all ${dashboardView === 'leaderboard' ? 'text-cyan-400 bg-cyan-900/20' : 'text-slate-600 hover:text-slate-400'}`}><Users size={18}/></button>
                                <button onClick={() => setDashboardView('progress')} className={`p-2 rounded-lg transition-all ${dashboardView === 'progress' ? 'text-cyan-400 bg-cyan-900/20' : 'text-slate-600 hover:text-slate-400'}`}><BarChart3 size={18}/></button>
                            </div>
                        </div>

                        {dashboardView === 'leaderboard' ? (
                            <div className="space-y-3">
                                {displayedLeaderboard.map((u, idx) => (
                                    <GlassCard key={u.id} onClick={() => !u.isUser && setExpandedUserId(expandedUserId === u.id ? null : u.id)} className={`p-4 transition-all ${u.isUser ? 'border-cyan-500/50 bg-cyan-900/10' : 'hover:bg-white/5'}`}>
                                        <div className="flex items-center justify-between">
                                            <div className="flex items-center gap-4">
                                                <div className="relative"><Avatar name={u.name} photoUrl={u.photoUrl} isUser={u.isUser}/><div className="absolute -top-1 -right-1 bg-slate-900 rounded-full w-4 h-4 flex items-center justify-center text-[9px] font-bold border border-slate-700 text-white">{idx + 1}</div></div>
                                                <div>
                                                    <div className={`font-bold ${u.isUser ? 'text-cyan-400' : 'text-slate-200'}`}>{u.name}</div>
                                                    <div className="flex gap-1 mt-1">{u.badges?.slice(0, 4).map((bid) => { const b = badgesData.find(x=>x.id===bid); return b ? <div key={bid} className={`w-3 h-3 rounded-full flex items-center justify-center border ${b.bg} ${b.color}`}>{React.cloneElement(b.icon, {size:8})}</div> : null })}</div>
                                                </div>
                                            </div>
                                            <div className="flex items-center gap-3">
                                                <div className="text-right"><div className="font-bold text-white text-sm">{u.streak} <span className="text-[10px] text-orange-400">üî•</span></div></div>
                                                {!u.isUser && <button onClick={(e) => { e.stopPropagation(); sendMotivation(u.name); }} className="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center text-cyan-400 hover:bg-cyan-500 hover:text-white transition-colors"><Zap size={14}/></button>}
                                            </div>
                                        </div>
                                        {expandedUserId === u.id && !u.isUser && (<div className="mt-4 pt-4 border-t border-white/5 animate-expand overflow-hidden"><div className="grid grid-cols-2 gap-2 mb-3"><div className="bg-white/5 p-2 rounded text-center"><span className="text-[10px] uppercase text-slate-500 block mb-1">–ê–ª–º–∞–∑–∏–∫–∏</span><span className="font-bold text-white">{u.diamonds} üíé</span></div><div className="bg-white/5 p-2 rounded text-center"><span className="text-[10px] uppercase text-slate-500 block mb-1">–¶–µ–ª—å</span><span className="font-bold text-white">{u.goal} –¥–Ω.</span></div></div><div className="flex flex-wrap gap-2">{u.disciplines?.map(d=><span key={d} className="text-[10px] px-2 py-1 bg-white/5 rounded border border-white/10 text-slate-300 font-bold">{d}</span>)}</div></div>)}
                                    </GlassCard>
                                ))}
                                {finalLeaderboard.length > 3 && (
                                    <button onClick={() => handleShowAll(!showAllLeaderboard)} className="w-full py-3 text-xs font-bold text-slate-500 uppercase tracking-widest hover:text-white transition-colors">
                                        {showAllLeaderboard ? '–°–∫—Ä—ã—Ç—å' : '–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ—Ö'}
                                    </button>
                                )}
                            </div>
                        ) : (
                            <div className="animate-fade-in space-y-6">
                                <GlassCard className="p-4 flex items-center gap-4 bg-gradient-to-r from-emerald-900/20 to-cyan-900/20">
                                    <div className="w-16 h-16 rounded-full bg-white/5 flex items-center justify-center border border-white/10 shadow-[0_0_15px_rgba(16,185,129,0.2)]">
                                        {getUserRankIcon(user.goal)}
                                    </div>
                                    <div>
                                        <div className="text-[10px] text-slate-400 uppercase font-bold tracking-widest mb-1">–¢–≤–æ–π —Ä–∞–Ω–≥</div>
                                        <div className="text-2xl font-black text-white uppercase tracking-wide">{getUserRankTitle(user.goal)}</div>
                                    </div>
                                </GlassCard>

                                <div>
                                    <h3 className="text-slate-500 uppercase text-[10px] font-bold tracking-[0.2em] mb-3">–ê—á–∏–≤–∫–∏</h3>
                                    <div className="grid grid-cols-3 gap-2">
                                        {userAchievements.map(ach => (
                                            <div key={ach.id} onClick={() => setBadgeInfo(ach)} className={`aspect-square rounded-xl flex flex-col items-center justify-center text-center p-2 border transition-all cursor-pointer ${ach.unlocked ? 'bg-cyan-500/10 border-cyan-500/50 text-cyan-400 shadow-[0_0_10px_rgba(6,182,212,0.2)]' : 'bg-white/5 border-white/5 text-slate-600 grayscale'}`}>
                                                <div className="mb-1">{ach.icon}</div>
                                                <div className="text-[8px] font-bold uppercase leading-tight">{ach.title}</div>
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                <GlassCard className="p-4 grid grid-cols-2 gap-4"><div className="text-center"><Ruler className="mx-auto text-cyan-400 mb-1"/><div className="text-xl font-bold text-white">{getStats(user.history).k}</div><div className="text-[10px] text-slate-500 uppercase font-bold">–ö–ú –í—Å–µ–≥–æ</div></div><div className="text-center"><Dumbbell className="mx-auto text-purple-400 mb-1"/><div className="text-xl font-bold text-white">{getStats(user.history).r}</div><div className="text-[10px] text-slate-500 uppercase font-bold">–ü–æ–≤—Ç–æ—Ä–æ–≤</div></div></GlassCard>
                                
                                <div><h3 className="text-slate-500 uppercase text-[10px] font-bold tracking-[0.2em] mb-3">–ò—Å—Ç–æ—Ä–∏—è</h3><div className="space-y-2 max-h-60 overflow-y-auto pr-2">{user.history.map((h,i)=>(<div key={i} className="flex justify-between items-center p-3 bg-white/5 rounded-xl border border-white/5"><div className="flex flex-col"><span className="text-[10px] text-slate-500">{h.date}</span><span className="text-sm font-bold text-white">{h.sport}</span></div><span className="text-sm text-cyan-400 font-mono">{h.value} {h.unit}</span></div>))}</div></div>
                            </div>
                        )}
                    </div>
                    
                    {/* MODALS */}
                    {activeModal === 'settings' && (
                        <div className="modal-fullscreen animate-fade-in">
                             <div className="modal-content-safe">
                                <div className="flex justify-between items-center mb-6"><button onClick={()=>setActiveModal(null)} className="p-2 bg-white/10 rounded-full text-white"><ArrowLeft size={20}/></button><h2 className="text-xl font-bold text-white">–ù–ê–°–¢–†–û–ô–ö–ò</h2><div className="w-8"></div></div>
                                <div className="space-y-6">
                                    <div className="space-y-2">
                                        <h3 className="text-xs font-bold text-slate-500 uppercase px-2">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h3>
                                        <GlassCard className="p-4 space-y-4">
                                            <div className="flex justify-between items-center"><div className="flex items-center gap-3"><Bell size={20} className="text-cyan-400"/><span className="font-bold text-slate-200">–ü—É—à-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</span></div><ToggleSwitch checked={user.notifications} onChange={v=>setUser({...user, notifications:v})}/></div>
                                            {user.notifications && <div className="flex items-center gap-3 border-t border-white/10 pt-4"><Clock size={16} className="text-slate-400"/><input type="time" value={user.notificationTime} onChange={e=>setUser({...user, notificationTime:e.target.value})} className="bg-slate-900 text-white rounded p-1 text-sm outline-none"/><span className="text-xs text-slate-500">–í—Ä–µ–º—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è</span></div>}
                                        </GlassCard>
                                    </div>
                                    
                                    <div className="space-y-2">
                                        <h3 className="text-xs font-bold text-slate-500 uppercase px-2">–¢–≤–æ–π –ê—Ä—Å–µ–Ω–∞–ª</h3>
                                        <GlassCard className="p-4">
                                            <div className="flex flex-wrap gap-2 mb-4">{popularSports.map(s => (<button key={s} onClick={()=>toggleDiscipline(s)} className={`px-4 py-2 rounded-lg text-xs font-bold border ${user.disciplines.includes(s) ? 'bg-cyan-600/50 text-white border-cyan-500 shadow-[0_0_10px_rgba(6,182,212,0.3)]' : 'bg-white/5 text-slate-400 border-white/10'}`}>{s}</button>))}</div>
                                            {!isAddingCustom ? <button onClick={()=>setIsAddingCustom(true)} className="w-full p-3 border border-dashed border-slate-700 rounded-xl text-slate-500 text-xs font-bold uppercase hover:text-cyan-400 flex items-center justify-center gap-2"><Plus size={16}/> –î–æ–±–∞–≤–∏—Ç—å —Å–≤–æ–µ</button> : <div className="flex gap-2"><input value={customInput} onChange={e=>setCustomInput(e.target.value)} className="flex-1 bg-slate-900 border border-cyan-500 rounded-xl px-4 text-white outline-none" autoFocus placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" /><button onClick={()=>addCustomSport(customInput)} className="p-3 bg-cyan-600 rounded-xl text-white"><CheckCircle size={20}/></button></div>}
                                        </GlassCard>
                                    </div>

                                    <div className="space-y-2">
                                        <h3 className="text-xs font-bold text-slate-500 uppercase px-2">–ê–∫–∫–∞—É–Ω—Ç</h3>
                                        <button onClick={handleDeleteAccount} className="w-full py-4 text-xs font-bold text-rose-500 border border-rose-500/30 bg-rose-500/10 rounded-xl uppercase flex items-center justify-center gap-2"><Trash2 size={16} /> –°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –∏ –≤—ã–π—Ç–∏</button>
                                    </div>

                                    <NeonButton id="save-settings-btn" onClick={saveSettingsToCloud} disabled={isSavingSettings} className="mt-8">
                                        {isSavingSettings ? "–°–û–•–†–ê–ù–ï–ù–ò–ï..." : "–°–û–•–†–ê–ù–ò–¢–¨"}
                                    </NeonButton>
                                </div>
                            </div>
                        </div>
                    )}

                    {activeModal === 'admin' && (
                        <div className="modal-fullscreen animate-fade-in">
                            <div className="modal-content-safe">
                                <div className="flex justify-between items-center mb-6"><button onClick={()=>setActiveModal(null)} className="p-2 bg-white/10 rounded-full text-white"><ArrowLeft size={20}/></button><h2 className="text-xl font-bold text-white">ADMIN</h2><div className="w-8"></div></div>
                                <div className="space-y-6">
                                    <GlassCard className="p-4">
                                        <div className="text-xs text-slate-500 uppercase mb-2">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ú–∞—Ä–∞—Ñ–æ–Ω–∞</div>
                                        <div className="text-[10px] text-slate-600 mb-2 font-mono">Sheet: 14G...QtJbU | B2</div>
                                        <div className="flex flex-col gap-2"><div className="text-sm text-slate-400">–¢–µ–∫—É—â–∞—è: <span className="text-white font-mono">{marathonStartDate.toLocaleDateString()}</span></div><div className="flex gap-2 items-center"><input type="date" value={adminDateInput} onChange={e=>setAdminDateInput(e.target.value)} className="bg-slate-900 border border-slate-700 rounded p-2 text-white text-sm flex-1"/><button onClick={handleAdminUpdateDate} disabled={isSyncing} className="p-2 bg-amber-500 rounded text-black font-bold">{isSyncing ? '...' : <Save size={18}/>}</button></div></div>
                                    </GlassCard>
                                    
                                    {!editUser ? (
                                        <div className="space-y-2">
                                            <h3 className="text-slate-400 text-xs font-bold uppercase">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h3>
                                            {!isAddingUser ? <NeonButton variant="secondary" onClick={()=>setIsAddingUser(true)} className="mb-4"><UserPlus size={18}/> –î–æ–±–∞–≤–∏—Ç—å</NeonButton> : (<GlassCard className="p-4 mb-4 animate-fade-in"><input type="text" value={newUserNick} onChange={e=>setNewUserNick(e.target.value)} className="w-full bg-slate-900 border border-slate-700 rounded p-2 text-white mb-2" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"/><div className="flex gap-2"><NeonButton onClick={()=>setIsAddingUser(false)} variant="disabled">–û—Ç–º.</NeonButton><NeonButton onClick={()=>{if(newUserNick){setLeaderboard(l=>[...l, {id:Date.now(), name:newUserNick, diamonds:3, streak:0, goal:30, status:'active', disciplines: []}]); setIsAddingUser(false); setNewUserNick('')}}}>OK</NeonButton></div></GlassCard>)}
                                            {leaderboard.map(u=><div key={u.id} className="flex justify-between items-center p-3 bg-white/5 rounded-xl border border-white/10"><span className="text-white font-bold">{u.name}</span><div className="flex gap-2"><button onClick={()=>setEditUser({...u})} className="p-2 bg-cyan-500/20 text-cyan-400 rounded-lg"><Edit3 size={16}/></button><button onClick={()=>{if(confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?'))setLeaderboard(l=>l.filter(x=>x.id!==u.id))}} className="p-2 bg-rose-500/20 text-rose-400 rounded-lg"><Trash2 size={16}/></button></div></div>)}
                                        </div>
                                    ) : (
                                        <GlassCard className="p-4 space-y-3 animate-fade-in">
                                            <h3 className="text-white font-bold mb-2">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å: {editUser.name}</h3>
                                            <div className="grid grid-cols-2 gap-2">
                                                <div><label className="text-[10px] text-slate-500 uppercase">–ê–ª–º–∞–∑–∏–∫–∏</label><input type="number" value={editUser.diamonds} onChange={e=>setEditUser({...editUser, diamonds: +e.target.value})} className="w-full bg-slate-900 p-2 text-white rounded"/></div>
                                                <div><label className="text-[10px] text-slate-500 uppercase">–°—Ç—Ä–∏–∫</label><input type="number" value={editUser.streak} onChange={e=>setEditUser({...editUser, streak: +e.target.value})} className="w-full bg-slate-900 p-2 text-white rounded"/></div>
                                                <div><label className="text-[10px] text-slate-500 uppercase">–¶–µ–ª—å</label><input type="number" value={editUser.goal} onChange={e=>setEditUser({...editUser, goal: +e.target.value})} className="w-full bg-slate-900 p-2 text-white rounded"/></div>
                                            </div>
                                            <div className="pt-2 border-t border-white/10">
                                                <label className="text-[10px] text-slate-500 uppercase mb-2 block">–í–∞—Ä–∏–∞–Ω—Ç—ã (–ê—Ä—Å–µ–Ω–∞–ª)</label>
                                                <div className="flex flex-wrap gap-2 mb-2">{editUser.disciplines && editUser.disciplines.map(d => (<span key={d} className="px-2 py-1 bg-white/5 rounded border border-white/10 text-xs flex items-center gap-1">{d} <X size={12} className="cursor-pointer text-rose-400" onClick={() => setEditUser({...editUser, disciplines: editUser.disciplines.filter(x => x !== d)})}/></span>))}</div>
                                                <div className="flex gap-2"><input value={adminEditSportInput} onChange={e=>setAdminEditSportInput(e.target.value)} className="flex-1 bg-slate-900 border border-slate-700 rounded p-2 text-xs text-white" placeholder="–î–æ–±–∞–≤–∏—Ç—å..."/><button onClick={()=>{ if(adminEditSportInput){ setEditUser({...editUser, disciplines: [...(editUser.disciplines||[]), adminEditSportInput]}); setAdminEditSportInput(""); } }} className="p-2 bg-cyan-600 rounded text-white"><Plus size={14}/></button></div>
                                            </div>
                                            <div className="flex gap-2 pt-2"><NeonButton variant="disabled" onClick={()=>setEditUser(null)}>–ù–∞–∑–∞–¥</NeonButton><NeonButton onClick={()=>{setLeaderboard(l=>l.map(x=>x.id===editUser.id?editUser:x)); setEditUser(null);}}>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</NeonButton></div>
                                        </GlassCard>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}

                    {activeModal === 'shop' && (
                        <div className="modal-fullscreen animate-slide-up">
                            <div className="modal-content-safe relative overflow-hidden flex flex-col">
                                <div className="absolute top-20 left-10 opacity-10 animate-float"><Ghost size={60} className="text-rose-500"/></div>
                                <div className="absolute bottom-20 right-10 opacity-10 animate-float" style={{animationDelay: '2s'}}><Skull size={80} className="text-rose-500"/></div>

                                <div className="flex justify-between items-center mb-6 z-10"><button onClick={()=>setActiveModal(null)} className="p-2 bg-white/10 rounded-full text-white"><ArrowLeft size={20}/></button><h2 className="text-xl font-bold text-rose-500 uppercase">–ú–∞–≥–∞–∑–∏–Ω –ò—Å–∫—É–ø–ª–µ–Ω–∏—è</h2><div className="w-8"></div></div>
                                <div className="flex items-start justify-center flex-grow z-10 pt-4">
                                    <RedemptionShopContent onClose={()=>setActiveModal(null)}/>
                                </div>
                            </div>
                        </div>
                    )}

                    {activeModal === 'checkIn' && renderCheckInModal()}

                    {badgeInfo && (
                        <div className="fixed inset-0 z-[80] bg-black/80 backdrop-blur-md flex items-center justify-center p-6 animate-fade-in" onClick={()=>setBadgeInfo(null)}>
                            <div className="bg-[#0f172a] border border-white/10 rounded-3xl p-8 text-center max-w-sm w-full relative overflow-hidden" onClick={e=>e.stopPropagation()}>
                                <div className="absolute top-[-20%] left-[-20%] w-[140%] h-[140%] bg-gradient-to-b from-cyan-500/10 to-transparent pointer-events-none"></div>
                                <div className={`w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6 border-2 transition-all ${badgeInfo.unlocked ? 'bg-cyan-500/20 border-cyan-400 text-cyan-400 shadow-[0_0_20px_rgba(34,211,238,0.4)]' : 'bg-slate-800 border-slate-700 text-slate-500'}`}>
                                    {React.cloneElement(badgeInfo.icon, {size: 40})}
                                </div>
                                <h3 className="text-2xl font-black text-white mb-2 uppercase">{badgeInfo.title}</h3>
                                <p className="text-slate-400 mb-6 leading-relaxed">{badgeInfo.desc}</p>
                                <div className={`inline-block px-4 py-1 rounded-full text-xs font-bold uppercase tracking-wider mb-6 ${badgeInfo.unlocked ? 'bg-emerald-500/20 text-emerald-400' : 'bg-slate-700/50 text-slate-500'}`}>
                                    {badgeInfo.unlocked ? '–ü–û–õ–£–ß–ï–ù–û' : '–ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù–û'}
                                </div>
                                <NeonButton variant="secondary" onClick={()=>setBadgeInfo(null)}>–ü–æ–Ω—è—Ç–Ω–æ</NeonButton>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const RedemptionShopContent = ({ onClose }) => {
            const [spinState, setSpinState] = useState('idle');
            const [task, setTask] = useState("");
            const tasks = ["–°–µ–ª—Ñ–∏ —Å –∫–æ—Ç–æ–º", "–ü–ª–∞–Ω–∫–∞ 1 –º–∏–Ω –Ω–∞ –≤–∏–¥–µ–æ", "30 –ë–µ—Ä–ø–∏ –Ω–∞ –∫–∞–º–µ—Ä—É", "–ó–∞–ø–∏—Å–∞—Ç—å –≤–æ–π—Å –±—ã–≤—à–µ–π", "–°–ø–µ—Ç—å –≥–∏–º–Ω –≤ —Å—Ç–æ—Ä–∏—Å", "50 –ø—Ä–∏—Å–µ–¥–∞–Ω–∏–π –≤ –º–∞–≥–∞–∑–∏–Ω–µ", "–û—Ç–∂–∞—Ç—å—Å—è –Ω–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ", "–ù–∞–ø–∏—Å–∞—Ç—å '–Ø —Å–ª–∞–±–∞–∫' –≤ —Å—Ç–∞—Ç—É—Å –Ω–∞ —á–∞—Å", "–°—ä–µ—Å—Ç—å –ª–∏–º–æ–Ω –±–µ–∑ —ç–º–æ—Ü–∏–π", "–ü—Ä–æ—Å—Ç–æ—è—Ç—å –≤ —Å—Ç—É–ª—å—á–∏–∫–µ 2 –º–∏–Ω"];
            const spin = () => {
                setSpinState('spinning');
                let counter = 0;
                const interval = setInterval(() => { setTask(tasks[counter % tasks.length]); counter++; }, 100);
                setTimeout(() => { clearInterval(interval); setTask(tasks[Math.floor(Math.random() * tasks.length)]); setSpinState('result'); }, 2000);
            };
            return (
                <GlassCard className="p-8 text-center border-rose-500/30 bg-rose-900/10 w-full shadow-[0_0_50px_rgba(244,63,94,0.2)]">
                    <Skull className="mx-auto text-rose-500 mb-4" size={50}/>
                    <h3 className="text-2xl font-black text-white uppercase mb-2">–ö–£–ü–ò–¢–¨ –ñ–ò–ó–ù–¨</h3>
                    <p className="text-rose-400 text-sm mb-6">–¶–µ–Ω–∞: –¢–≤–æ—è –≥–æ—Ä–¥–æ—Å—Ç—å</p>
                    {spinState === 'idle' && <NeonButton variant="danger" onClick={spin}>–ö–†–£–¢–ò–¢–¨ –†–£–õ–ï–¢–ö–£</NeonButton>}
                    {spinState === 'spinning' && <div className="text-xl font-bold text-white animate-pulse h-20 flex items-center justify-center">{task}</div>}
                    {spinState === 'result' && (<div className="animate-fade-in"><div className="text-lg font-bold text-white mb-6 border p-4 rounded-xl border-dashed border-rose-500/50 bg-rose-500/10">{task}</div><NeonButton onClick={() => setSpinState('upload')} variant="danger"><Camera size={18}/> –ó–ê–ì–†–£–ó–ò–¢–¨ –§–û–¢–û</NeonButton></div>)}
                    {spinState === 'upload' && (<div className="animate-fade-in"><div className="w-full h-32 bg-slate-800 rounded-xl flex items-center justify-center mb-4 border border-dashed border-slate-600"><span className="text-slate-500 text-xs">–§–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ</span></div><NeonButton onClick={() => { alert("–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É! –ê–ª–º–∞–∑–∏–∫ –±—É–¥–µ—Ç –Ω–∞—á–∏—Å–ª–µ–Ω –ø–æ—Å–ª–µ –æ–¥–æ–±—Ä–µ–Ω–∏—è."); onClose(); }} variant="gold">–û–¢–ü–†–ê–í–ò–¢–¨</NeonButton></div>)}
                </GlassCard>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
