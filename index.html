<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fitness Aurora</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        aurora: {
                            bg: '#020617',     // Deep space blue
                            card: 'rgba(30, 41, 59, 0.4)', // Glass
                            border: 'rgba(148, 163, 184, 0.15)',
                            primary: '#22d3ee', // Cyan
                            secondary: '#a855f7', // Purple
                            accent: '#34d399',  // Emerald
                            text: '#f1f5f9',
                            muted: '#94a3b8'
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        display: ['Space Grotesk', 'sans-serif'],
                    },
                    spacing: {
                        'safe-top': '20px',
                    },
                    animation: {
                        'aurora-flow': 'aurora 15s ease infinite alternate',
                        'float': 'float 6s ease-in-out infinite',
                        'shine': 'shine 1.5s infinite',
                        'fade-in': 'fadeIn 0.5s ease-out forwards',
                        'slide-up': 'slideUp 0.5s ease-out forwards',
                    },
                    keyframes: {
                        aurora: {
                            '0%': { backgroundPosition: '0% 50%' },
                            '50%': { backgroundPosition: '100% 50%' },
                            '100%': { backgroundPosition: '0% 50%' }
                        },
                        float: { 
                            '0%, 100%': { transform: 'translateY(0)' }, 
                            '50%': { transform: 'translateY(-10px)' } 
                        },
                        shine: { '0%': { transform: 'translateX(-100%)' }, '100%': { transform: 'translateX(100%)' } },
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
                    }
                }
            }
        }
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">

    <script src="https://unpkg.com/@babel/standalone@7.26.9/babel.min.js"></script>

    <style>
        body { 
            background-color: #020617; 
            color: #f1f5f9;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
        }
        
        /* Animated Background */
        .aurora-bg {
            background: linear-gradient(-45deg, #020617, #1e1b4b, #111827, #0f172a);
            background-size: 400% 400%;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: -1;
            animation: aurora 15s ease infinite alternate;
        }

        .aurora-glow {
            position: fixed;
            width: 80vw;
            height: 80vw;
            background: radial-gradient(circle, rgba(34,211,238,0.1) 0%, rgba(0,0,0,0) 70%);
            border-radius: 50%;
            pointer-events: none;
            z-index: -1;
            top: -20%;
            left: -20%;
        }
        
        .aurora-glow-2 {
            position: fixed;
            width: 90vw;
            height: 90vw;
            background: radial-gradient(circle, rgba(168,85,247,0.1) 0%, rgba(0,0,0,0) 70%);
            border-radius: 50%;
            pointer-events: none;
            z-index: -1;
            bottom: -20%;
            right: -20%;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .glass-panel {
            background: rgba(30, 41, 59, 0.3);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }
        
        /* Error Box Style */
        #error-box {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(220, 38, 38, 0.9);
            color: white;
            padding: 20px;
            border-radius: 12px;
            z-index: 9999;
            max-width: 90%;
            text-align: center;
            font-family: sans-serif;
        }
    </style>
</head>
<body>
    <div class="aurora-bg"></div>
    <div class="aurora-glow"></div>
    <div class="aurora-glow-2"></div>
    
    <div id="root"></div>

    <div id="error-box">
        <h3 style="font-weight:bold; margin-bottom:10px;">–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞</h3>
        <p id="error-text">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</p>
        <p style="font-size: 12px; margin-top: 10px; opacity: 0.8;">–ï—Å–ª–∏ –≤—ã –æ—Ç–∫—Ä—ã–ª–∏ —Ñ–∞–π–ª –ª–æ–∫–∞–ª—å–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä (Live Server) –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –Ω–∞ —Ö–æ—Å—Ç–∏–Ω–≥.</p>
    </div>

    <script>
        window.onerror = function(msg, url, line, col, error) {
            const box = document.getElementById('error-box');
            const text = document.getElementById('error-text');
            box.style.display = 'block';
            text.innerText = `${msg}\nLine: ${line}`;
            console.error("Global Error:", error);
            return false;
        };
    </script>

    <script type="text/babel" data-type="module">
        // Direct Imports for Stability
        import React, { useState, useEffect } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        import { 
            Trophy, Diamond, Zap, Camera, CheckCircle, Activity, User, Settings, Plus, X, 
            Hexagon, Flame, Send, Bell, AlertTriangle, Skull, Dumbbell, Timer, Ruler, 
            BarChart3, Users, Calendar, Award, ChevronRight, ChevronUp, ChevronDown, Siren, FileWarning, UploadCloud, 
            RefreshCw, Shield, Download, Edit3, Save, Trash2, LogOut, Sun, Moon
        } from 'https://esm.sh/lucide-react@0.263.1';

        // --- CONSTANTS ---
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbydULT-3CWngM-jmKIuVH5f0LvcwDiSqMgEBCbR2FroObYhwKZqG_DeVc4pDa8-WL5A/exec'; // –í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É Web App
        const ADMIN_USERNAME = 'solomin_d';
        const DEFAULT_START_DATE = new Date('2025-03-18'); 

        // --- UI COMPONENTS ---

        const GlassCard = ({ children, className = "", onClick }) => (
            <div onClick={onClick} className={`relative glass-panel rounded-2xl overflow-hidden ${onClick ? 'cursor-pointer active:scale-95 transition-transform' : ''} ${className}`}>
                <div className="absolute top-0 left-0 w-full h-[1px] bg-gradient-to-r from-transparent via-white/20 to-transparent"></div>
                {children}
            </div>
        );

        const NeonButton = ({ children, onClick, variant = 'primary', disabled = false, className = "" }) => {
            const baseStyle = "w-full py-4 font-bold tracking-wider uppercase transition-all active:scale-95 flex items-center justify-center gap-2 relative overflow-hidden group rounded-xl";
            
            const variants = {
                primary: "bg-cyan-600/80 text-white shadow-[0_0_20px_rgba(8,145,178,0.4)] hover:bg-cyan-500 hover:shadow-[0_0_30px_rgba(34,211,238,0.6)] border border-cyan-400/30 backdrop-blur-sm",
                danger: "bg-rose-600/80 text-white shadow-[0_0_20px_rgba(225,29,72,0.4)] hover:bg-rose-500 border border-rose-400/30 backdrop-blur-sm",
                success: "bg-emerald-600/80 text-white shadow-[0_0_20px_rgba(5,150,105,0.4)] hover:bg-emerald-500 border border-emerald-400/30 backdrop-blur-sm",
                gold: "bg-amber-500/80 text-white shadow-[0_0_20px_rgba(245,158,11,0.4)] hover:bg-amber-400 border border-amber-300/30 backdrop-blur-sm",
                secondary: "bg-white/5 text-aurora-text border border-white/10 hover:bg-white/10 backdrop-blur-sm",
                disabled: "bg-slate-800/50 text-slate-500 border border-slate-700 cursor-not-allowed shadow-none backdrop-blur-sm"
            };
            
            return (
                <button onClick={onClick} disabled={disabled} className={`${baseStyle} ${disabled ? variants.disabled : variants[variant]} ${className}`}>
                    <div className="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent -translate-x-full group-hover:animate-shine"></div>
                    {children}
                </button>
            );
        };

        const ToggleSwitch = ({ checked, onChange }) => (
            <button onClick={() => onChange(!checked)} className={`w-12 h-6 rounded-full p-1 transition-colors duration-300 relative ${checked ? 'bg-cyan-500' : 'bg-slate-700/50 border border-slate-600'}`}>
                <div className={`w-4 h-4 rounded-full bg-white shadow-sm transition-transform duration-300 ${checked ? 'translate-x-6' : 'translate-x-0'}`} />
            </button>
        );

        const Avatar = ({ name, className = "", size = "w-10 h-10" }) => {
            const initials = name ? name.slice(0, 2).toUpperCase() : "FQ";
            const gradients = [
                "from-cyan-500 to-blue-600",
                "from-purple-500 to-indigo-600",
                "from-emerald-400 to-teal-600",
                "from-fuchsia-500 to-pink-600",
            ];
            const colorIndex = name ? name.length % gradients.length : 0;
            
            return (
                <div className={`${size} rounded-full bg-gradient-to-br ${gradients[colorIndex]} flex items-center justify-center text-white font-bold shadow-lg border border-white/20 ${className}`}>
                    {initials}
                </div>
            );
        };

        // --- HELPERS ---
        const getSportType = (sport) => {
            const s = sport.toLowerCase();
            if (['–±–µ–≥', '—Ö–æ–¥—å–±–∞', '–ø–ª–∞–≤–∞–Ω–∏–µ', '–≤–µ–ª–æ', '–ª—ã–∂–∏'].some(x => s.includes(x))) return 'cardio';
            if (['–∑–∞–ª', '–∫–∞—á–∞–ª–∫–∞', 'gym'].some(x => s.includes(x))) return 'gym';
            if (['–≤–æ—Ä–∫–∞—É—Ç', '–æ—Ç–∂–∏–º–∞–Ω–∏—è', '–ø—Ä–∏—Å–µ–¥–∞–Ω–∏—è', '–ø—Ä–µ—Å—Å', '–ø–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è'].some(x => s.includes(x))) return 'reps';
            return 'other';
        };

        const getStatsSummary = (history = []) => {
            let totalKm = 0, totalReps = 0, gymSessions = { '–í–µ—Ä—Ö': 0, '–ù–∏–∑': 0, '–í—Å—ë —Ç–µ–ª–æ': 0, '–ì–æ–ª–æ–≤–∞': 0 };
            history.forEach(entry => {
                if (entry.type === 'cardio' && entry.value) totalKm += parseFloat(entry.value);
                if (entry.type === 'reps' && entry.value) totalReps += parseInt(entry.value);
                if (entry.type === 'gym' && entry.value && gymSessions[entry.value] !== undefined) gymSessions[entry.value]++;
            });
            const totalGym = Object.values(gymSessions).reduce((a, b) => a + b, 0);
            return { totalKm, totalReps, gymSessions, totalGym };
        };

        const getUserTitle = (goal) => {
            if (goal >= 100) return '–ö–∏–±–æ—Ä–≥';
            if (goal >= 60) return '–ê—Ç–ª–µ—Ç';
            return '–ù–æ–≤–∏—á–æ–∫';
        };

        // --- SCREENS ---

        const WelcomeScreen = ({ onStart }) => (
            <div className="flex flex-col h-screen p-6 animate-fade-in relative z-10 pt-safe-top">
                <div className="flex-grow flex flex-col items-center justify-center text-center space-y-8">
                    <div className="relative w-40 h-40 flex items-center justify-center">
                        <div className="absolute inset-0 bg-cyan-500 blur-[60px] opacity-30 rounded-full animate-pulse"></div>
                        <div className="absolute inset-0 bg-purple-500 blur-[60px] opacity-20 rounded-full translate-x-4 animate-pulse" style={{animationDelay: '1s'}}></div>
                        <Hexagon size={130} className="text-cyan-400 stroke-[1.5] animate-float drop-shadow-[0_0_15px_rgba(34,211,238,0.5)]" />
                        <Activity size={50} className="text-white absolute drop-shadow-lg" />
                    </div>
                    <div>
                        <h1 className="text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-cyan-200 via-white to-purple-200 uppercase tracking-tighter leading-tight mb-2 font-display drop-shadow-sm">Fitness<br/>Aurora</h1>
                        <p className="text-cyan-200/80 font-medium tracking-[0.2em] uppercase text-xs bg-white/5 inline-block px-4 py-1.5 rounded-full border border-white/10 backdrop-blur-md mt-4">–°–µ–≤–µ—Ä–Ω—ã–π –∫–≤–∞—Ä—Ç–∞–ª</p>
                    </div>
                </div>
                <div className="mt-auto w-full pb-8">
                    <NeonButton onClick={onStart}>–ù–∞—á–∞—Ç—å –ü—É—Ç—å</NeonButton>
                    <p className="text-center text-slate-500 text-[10px] mt-4 uppercase tracking-widest font-bold">Version Aurora 1.1</p>
                </div>
            </div>
        );

        const RegistrationScreen = ({ regForm, setRegForm, onNext }) => (
            <div className="min-h-screen flex flex-col p-6 animate-slide-up pt-safe-top relative z-10">
                <h2 className="text-3xl font-display font-bold text-white mb-6 tracking-wide">–ò–î–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø</h2>
                <div className="space-y-6 flex-grow">
                    <GlassCard className="p-1">
                        <input 
                            type="text" 
                            value={regForm.firstName} 
                            onChange={e => setRegForm(prev => ({...prev, firstName: e.target.value}))} 
                            className="w-full p-4 bg-transparent text-white font-bold outline-none placeholder:text-slate-500" 
                            placeholder="–ò–º—è –∞–≥–µ–Ω—Ç–∞" 
                        />
                    </GlassCard>
                    <GlassCard className="p-1">
                        <input 
                            type="text" 
                            value={regForm.lastName} 
                            onChange={e => setRegForm(prev => ({...prev, lastName: e.target.value}))} 
                            className="w-full p-4 bg-transparent text-white font-bold outline-none placeholder:text-slate-500" 
                            placeholder="–ü–æ–∑—ã–≤–Ω–æ–π (–§–∞–º–∏–ª–∏—è)" 
                        />
                    </GlassCard>
                </div>
                <div className="pb-8"><NeonButton onClick={onNext} disabled={!regForm.firstName}>–î–∞–ª–µ–µ</NeonButton></div>
            </div>
        );

        const ArsenalScreen = ({ disciplines, popularSports, onToggle, onCustomAdd, onNext }) => {
            const [customInput, setCustomInput] = useState("");
            const [isAdding, setIsAdding] = useState(false);

            const handleAdd = () => {
                if(customInput.trim()) {
                    onCustomAdd(customInput.trim());
                    setCustomInput("");
                    setIsAdding(false);
                }
            };

            return (
                <div className="p-6 flex flex-col h-screen animate-slide-up relative z-10 pt-safe-top">
                    <h2 className="text-3xl font-display font-bold text-white mb-2 tracking-wide">–í–´–ë–û–† –û–†–£–ñ–ò–Ø</h2>
                    <p className="text-slate-400 text-sm mb-8 leading-relaxed">–°–æ–±–µ—Ä–∏ —Å–≤–æ–π —Å–µ—Ç.<br/>–ú–∞–∫—Å–∏–º—É–º 5 –¥–∏—Å—Ü–∏–ø–ª–∏–Ω.</p>
                    <div className="flex flex-wrap gap-3 mb-4 max-h-[60vh] overflow-y-auto content-start pb-20 no-scrollbar">
                        {popularSports.map(sport => (
                            <button key={sport} onClick={() => onToggle(sport)} className={`px-5 py-3 rounded-xl text-sm font-bold tracking-wide transition-all duration-300 border backdrop-blur-md ${disciplines.includes(sport) ? 'bg-cyan-600/80 text-white border-cyan-400 shadow-[0_0_15px_rgba(34,211,238,0.3)]' : 'bg-white/5 text-slate-300 border-white/10 hover:border-cyan-500/50 hover:text-cyan-300'}`}>{sport}</button>
                        ))}
                        {!isAdding ? (
                            <button onClick={() => setIsAdding(true)} className="px-5 py-3 rounded-xl text-sm border border-dashed border-slate-600 text-slate-500 hover:border-cyan-500 hover:text-cyan-400 bg-transparent flex items-center gap-2 transition-colors"><Plus size={16} /> –°–≤–æ—è</button>
                        ) : (
                            <div className="flex items-center gap-2 animate-fade-in w-full sm:w-auto mt-2 sm:mt-0">
                                <input type="text" value={customInput} onChange={(e) => setCustomInput(e.target.value)} placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ..." className="px-4 py-2.5 rounded-xl bg-slate-800/80 border border-cyan-500/50 outline-none text-white text-sm w-32 focus:ring-2 focus:ring-cyan-500/30" autoFocus onKeyDown={(e) => e.key === 'Enter' && handleAdd()} />
                                <button onClick={handleAdd} className="p-3 bg-cyan-600 text-white rounded-xl shadow-lg hover:bg-cyan-700"><CheckCircle size={16}/></button>
                            </div>
                        )}
                    </div>
                    <div className="mt-auto pb-8">
                        <div className="flex justify-between items-center mb-4 text-xs font-bold uppercase tracking-widest"><span className="text-slate-500">–°–ª–æ—Ç–æ–≤ –∑–∞–Ω—è—Ç–æ</span><span className={disciplines.length > 0 ? "text-cyan-400" : "text-slate-600"}>{disciplines.length} / 5</span></div>
                        <NeonButton onClick={onNext} disabled={disciplines.length === 0}>–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</NeonButton>
                    </div>
                </div>
            );
        };

        const GoalScreen = ({ onSelect, startDate }) => {
            const calculateGoalOptions = () => {
                const now = new Date();
                const start = startDate || DEFAULT_START_DATE;
                const diffTime = start - now;
                const daysUntilStart = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                const passed = daysUntilStart > 0 ? 0 : Math.abs(daysUntilStart);
                
                return [
                    { label: '–ù–æ–≤–∏—á–æ–∫', days: 30 - passed, original: 30 },
                    { label: '–ê—Ç–ª–µ—Ç', days: 60 - passed, original: 60 },
                    { label: '–ö–∏–±–æ—Ä–≥', days: 100 - passed, original: 100 }
                ].filter(g => g.days > 0);
            };

            const goals = calculateGoalOptions();
            
            return (
                <div className="p-6 flex flex-col h-screen animate-slide-up relative z-10 pt-safe-top">
                    <h2 className="text-3xl font-display font-bold text-white mb-10 text-center tracking-wide">–£–†–û–í–ï–ù–¨ –°–õ–û–ñ–ù–û–°–¢–ò</h2>
                    <div className="flex flex-col gap-6 flex-grow justify-center pb-8">
                        {goals.map((g, idx) => (
                            <GlassCard key={idx} onClick={() => onSelect(g.days)} className="p-6 flex items-center justify-between group border-l-4 border-l-transparent hover:border-l-cyan-400 transition-all bg-white/5 hover:bg-white/10">
                                <div className="flex flex-col">
                                    <span className="text-4xl font-display font-black text-white group-hover:text-cyan-300 transition-colors drop-shadow-md">{g.days} <span className="text-lg font-sans font-normal text-slate-400">–î–Ω–µ–π</span></span>
                                    <span className="text-[10px] text-slate-500 font-bold uppercase tracking-[0.2em] mt-2 group-hover:text-cyan-200 transition-colors">{g.label}</span>
                                </div>
                                <div className="w-14 h-14 rounded-full bg-slate-800/50 flex items-center justify-center group-hover:bg-cyan-500/20 group-hover:text-cyan-300 transition-colors border border-white/10 text-slate-500">
                                    {idx === 0 ? <Activity size={24} /> : idx === 1 ? <Zap size={24} /> : <Trophy size={24} />}
                                </div>
                            </GlassCard>
                        ))}
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---

        function App() {
            // State
            const [step, setStep] = useState('loading');
            const [user, setUser] = useState({
                firstName: '', lastName: '', username: '', telegramId: null,
                disciplines: [], goal: 0, diamonds: 3, streak: 0,
                todayActivity: [], history: [], status: 'active', notifications: true, isAdmin: false
            });
            const [marathonStartDate, setMarathonStartDate] = useState(null);

            // Flow State
            const [regForm, setRegForm] = useState({ firstName: '', lastName: '' });
            const [popularSports, setPopularSports] = useState(['–ë–µ–≥', '–ó–∞–ª', '–û—Ç–∂–∏–º–∞–Ω–∏—è', '–ü–ª–∞–≤–∞–Ω–∏–µ', '–í–æ—Ä–∫–∞—É—Ç', '–í–µ–ª–æ', '–ü—Ä–∏—Å–µ–¥–∞–Ω–∏—è', '–•–æ–¥—å–±–∞']);
            
            // Dashboard UI
            const [checkInModalOpen, setCheckInModalOpen] = useState(false);
            const [checkInStage, setCheckInStage] = useState('select');
            const [selectedSportForCheckIn, setSelectedSportForCheckIn] = useState(null);
            const [checkInValue, setCheckInValue] = useState("");
            const [editingProfile, setEditingProfile] = useState(false);
            const [adminPanelOpen, setAdminPanelOpen] = useState(false);
            const [selectedUser, setSelectedUser] = useState(null);
            const [dashboardView, setDashboardView] = useState('leaderboard');
            const [showAllBadges, setShowAllBadges] = useState(false);
            const [showConfetti, setShowConfetti] = useState(false);
            const [isAddingCustom, setIsAddingCustom] = useState(false);
            const [customInput, setCustomInput] = useState("");
            
            // Mock Leaderboard
            const [leaderboard, setLeaderboard] = useState([
                { id: 1, name: 'Alex', diamonds: 3, streak: 12, goal: 100, status: 'active', disciplines: ['–ë–µ–≥', '–í–æ—Ä–∫–∞—É—Ç'], history: [], badges: ['streak', 'runner'] },
                { id: 2, name: 'Elena', diamonds: 5, streak: 45, goal: 60, status: 'active', disciplines: ['–ó–∞–ª', '–ü–ª–∞–≤–∞–Ω–∏–µ'], history: [], badges: ['gym', 'reps', 'early'] },
                { id: 3, name: 'Max', diamonds: 0, streak: 8, goal: 30, status: 'frozen', disciplines: ['–ë–æ–∫—Å'], history: [], badges: [] },
                { id: 4, name: 'Igor', diamonds: 2, streak: 89, goal: 100, status: 'active', disciplines: ['–í–µ–ª–æ', '–û—Ç–∂–∏–º–∞–Ω–∏—è'], history: [], badges: ['runner', 'reps', 'social', 'streak'] },
            ]);

            // --- INIT ---
            useEffect(() => {
                // Telegram setup
                const tg = window.Telegram?.WebApp;
                if (tg) {
                    tg.ready(); 
                    tg.expand();
                    tg.setHeaderColor('#020617'); 
                    tg.setBackgroundColor('#020617');
                }

                // Check Local Storage
                const savedUser = localStorage.getItem('fitness_aurora_user');
                
                if (savedUser) {
                    const parsed = JSON.parse(savedUser);
                    const tgUser = tg?.initDataUnsafe?.user;
                    const isAdmin = (tgUser?.username === ADMIN_USERNAME) || parsed.isAdmin;
                    setUser({ ...parsed, isAdmin });
                    setStep('dashboard');
                } else {
                    const tgUser = tg?.initDataUnsafe?.user;
                    if (tgUser) {
                        setRegForm({ firstName: tgUser.first_name || '', lastName: tgUser.last_name || '' });
                        setUser(prev => ({ ...prev, telegramId: tgUser.id, username: tgUser.username, isAdmin: tgUser.username === ADMIN_USERNAME }));
                    }
                    setStep('welcome');
                }
                
                // Set default date
                setMarathonStartDate(DEFAULT_START_DATE);

            }, []);

            useEffect(() => { if (user.firstName) localStorage.setItem('fitness_aurora_user', JSON.stringify(user)); }, [user]);

            // --- ACTION HANDLERS ---
            const handleRegNext = () => { if (regForm.firstName) { setUser(p => ({ ...p, firstName: regForm.firstName, lastName: regForm.lastName })); setStep('arsenal'); } };
            const handleArsenalToggle = (sport) => { setUser(prev => { const exists = prev.disciplines.includes(sport); if (exists) return { ...prev, disciplines: prev.disciplines.filter(d => d !== sport) }; if (prev.disciplines.length >= 5) return prev; return { ...prev, disciplines: [...prev.disciplines, sport] }; }); };
            const handleArsenalCustom = (sport) => { setPopularSports(prev => [...prev, sport]); handleArsenalToggle(sport); };
            const handleGoalSelect = (goal) => { const newUser = { ...user, goal }; setUser(newUser); setStep('dashboard'); };
            
            const toggleDiscipline = (sport) => {
                 setUser(prev => {
                    if (prev.disciplines.includes(sport)) {
                        return { ...prev, disciplines: prev.disciplines.filter(s => s !== sport) };
                    } else {
                        if (prev.disciplines.length < 5) return { ...prev, disciplines: [...prev.disciplines, sport] };
                        return prev;
                    }
                });
            };
            
            const handleAddCustom = () => {
                if (customInput.trim()) {
                    setPopularSports(prev => [...prev, customInput.trim()]);
                    toggleDiscipline(customInput.trim());
                    setCustomInput("");
                    setIsAddingCustom(false);
                }
            };

            const initCheckIn = (sport) => { setSelectedSportForCheckIn(sport); const type = getSportType(sport); if (type === 'other') { completeCheckIn(sport, null, null); } else { setCheckInStage('details'); setCheckInValue(""); } };
            
            const completeCheckIn = (sport, value, unit) => {
                const type = getSportType(sport);
                setUser(prev => {
                    const isFirstCheckIn = prev.todayActivity.length === 0;
                    const newItem = { date: new Date().toISOString(), sport, type, value, unit };
                    return { 
                        ...prev, 
                        streak: isFirstCheckIn ? prev.streak + 1 : prev.streak, 
                        diamonds: isFirstCheckIn ? prev.diamonds : prev.diamonds, // –í –±—É–¥—É—â–µ–º –º–æ–∂–Ω–æ –¥–∞–≤–∞—Ç—å –∞–ª–º–∞–∑—ã
                        todayActivity: [...prev.todayActivity, sport], 
                        history: [newItem, ...prev.history] 
                    };
                });
                setShowConfetti(true); setTimeout(() => setShowConfetti(false), 3000);
                setCheckInModalOpen(false); setCheckInStage('select');
            };

            // Badge Config
            const badgeConfig = {
                'streak': { icon: <Flame size={10} />, color: 'text-orange-400', bg: 'bg-orange-500/20' },
                'runner': { icon: <Ruler size={10} />, color: 'text-cyan-400', bg: 'bg-cyan-500/20' },
                'gym': { icon: <Dumbbell size={10} />, color: 'text-purple-400', bg: 'bg-purple-500/20' },
                'reps': { icon: <Activity size={10} />, color: 'text-emerald-400', bg: 'bg-emerald-500/20' },
                'early': { icon: <Sun size={10} />, color: 'text-amber-400', bg: 'bg-amber-500/20' },
                'night': { icon: <Moon size={10} />, color: 'text-indigo-400', bg: 'bg-indigo-500/20' },
                'weekend': { icon: <Calendar size={10} />, color: 'text-rose-400', bg: 'bg-rose-500/20' },
                'social': { icon: <Send size={10} />, color: 'text-blue-400', bg: 'bg-blue-500/20' },
                'redemption': { icon: <Skull size={10} />, color: 'text-slate-400', bg: 'bg-slate-500/20' },
            };

            const badges = [
                { id: 'streak', icon: <Flame size={16} />, label: '–ù–∞ –æ–≥–Ω–µ', condition: user.streak >= 3 },
                { id: 'runner', icon: <Ruler size={16} />, label: '–ë–µ–≥—É–Ω', condition: getStatsSummary(user.history).totalKm >= 10 },
                { id: 'gym', icon: <Dumbbell size={16} />, label: '–¢–µ—Ä–º–∏–Ω–∞—Ç–æ—Ä', condition: getStatsSummary(user.history).totalGym >= 5 },
                { id: 'reps', icon: <Activity size={16} />, label: '–ú–∞—à–∏–Ω–∞', condition: getStatsSummary(user.history).totalReps >= 500 },
            ].map(b => ({...b, ...badgeConfig[b.id]}));
            
            const visibleBadges = showAllBadges ? badges : badges.slice(0, 3);
            
            // Logic for CheckIn status
            const isCheckedIn = user.todayActivity.length > 0;

            // --- SUB-COMPONENTS ---
            const RedemptionShop = () => {
                const [processing, setProcessing] = useState(false);
                const [task, setTask] = useState("–ò—â—É –Ω–∞–∫–∞–∑–∞–Ω–∏–µ...");
                const [isSpinning, setIsSpinning] = useState(false);
                const [hasSpun, setHasSpun] = useState(false);
                const [fileUploaded, setFileUploaded] = useState(false);
                
                const tasks = ["–°–¥–µ–ª–∞–π —Å–µ–ª—Ñ–∏ —Å –Ω–∞–¥–ø–∏—Å—å—é '–Ø –õ–ï–ù–ò–í–ê–Ø –ü–ê–ù–î–ê'", "–ü–ª–∞–Ω–∫–∞ —Å –∫–æ—Ç–æ–º –Ω–∞ —Å–ø–∏–Ω–µ", "–õ–∏—Ü–æ –ø–æ—Å–ª–µ 20 –±—ë—Ä–ø–∏"];
                const handleSpin = () => { 
                    setIsSpinning(true); setHasSpun(false); setFileUploaded(false); 
                    let interval = setInterval(() => { setTask(tasks[Math.floor(Math.random() * tasks.length)]); }, 80); 
                    setTimeout(() => { clearInterval(interval); setIsSpinning(false); setHasSpun(true); setTask(tasks[Math.floor(Math.random() * tasks.length)]); }, 2000); 
                };
                
                const handleBuyLife = () => { 
                    setProcessing(true); 
                    setTimeout(() => { 
                        setProcessing(false); setUser(prev => ({ ...prev, diamonds: prev.diamonds + 1, status: 'active' })); setStep('dashboard'); 
                    }, 2000); 
                };

                if (processing) return <div className="h-full flex flex-col items-center justify-center p-6 text-center space-y-8 relative z-10"><div className="w-16 h-16 border-4 border-cyan-500/30 border-t-cyan-500 rounded-full animate-spin"></div><h3 className="text-xl font-display font-bold text-white uppercase tracking-widest">–í–æ—Å–∫—Ä–µ—à–µ–Ω–∏–µ...</h3></div>;
                
                return (
                    <div className="h-full flex flex-col relative z-10 overflow-y-auto">
                        <div className="sticky top-0 z-20 bg-slate-900/90 backdrop-blur-md px-4 py-4 flex items-center gap-3 border-b border-white/10 pt-safe-top"><button onClick={() => setStep('dashboard')} className="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center text-white active:scale-95 transition-transform">‚Üê</button><span className="font-display font-bold text-white uppercase tracking-wider">–ú–∞–≥–∞–∑–∏–Ω –∏—Å–∫—É–ø–ª–µ–Ω–∏—è</span></div>
                        <div className="p-6 pb-20">
                            <div className="relative rounded-2xl overflow-hidden mb-8 border border-rose-500/30 shadow-[0_0_30px_rgba(244,63,94,0.2)] bg-rose-900/20"><div className="p-8 text-center relative z-10"><div className="inline-flex items-center justify-center w-16 h-16 bg-rose-500/20 rounded-full mb-4 border border-rose-500/50 shadow-sm animate-pulse"><Skull className="text-rose-400" size={32} /></div><h2 className="text-2xl font-display font-black text-white uppercase leading-none mb-2 tracking-widest">–í–ï–†–ù–£–¢–¨ <span className="text-rose-500">–ê–õ–ú–ê–ó</span></h2></div></div>
                            <GlassCard className="p-1 border-rose-500/30 mb-6"><div className="border border-dashed border-rose-500/30 rounded-lg p-5"><div className="flex items-center justify-between mb-4"><div className="flex items-center gap-2"><Siren size={14} className="text-rose-500 animate-pulse" /><span className="text-[10px] font-bold text-rose-400 uppercase tracking-[0.2em]">–¢–í–û–ï –ó–ê–î–ê–ù–ò–ï</span></div></div><h3 className={`font-sans font-bold text-lg text-white leading-snug mb-6 min-h-[4rem] ${isSpinning ? 'opacity-50 blur-[1px]' : ''}`}>{(!hasSpun && !isSpinning) ? "–ò—Å–ø—ã—Ç–∞–π —É–¥–∞—á—É..." : `"${task}"`}</h3>{!hasSpun && !isSpinning ? (<NeonButton variant="danger" onClick={handleSpin} className="py-2 text-xs shadow-none">–ö—Ä—É—Ç–∏—Ç—å –†—É–ª–µ—Ç–∫—É üé≤</NeonButton>) : (<div className="flex gap-2 animate-fade-in"><span className="px-3 py-2 bg-white/5 border border-white/10 rounded-lg text-[10px] font-bold text-slate-300 uppercase tracking-wider flex-1 text-center">–ù–∞–≥—Ä–∞–¥–∞: +1 üíé</span></div>)}</div></GlassCard>
                            {hasSpun && (<div className="animate-slide-up"><button onClick={() => setFileUploaded(true)} disabled={isSpinning} className={`w-full border border-dashed rounded-xl p-8 mb-6 transition-all group relative overflow-hidden active:scale-[0.99] ${fileUploaded ? 'bg-emerald-900/20 border-emerald-500/50' : 'bg-transparent border-slate-600 hover:border-rose-400 hover:bg-rose-900/10'}`}><div className="flex flex-col items-center gap-3 relative z-10"><div className={`w-14 h-14 rounded-full flex items-center justify-center transition-colors ${fileUploaded ? 'bg-emerald-500/20 text-emerald-400' : 'bg-slate-800 text-slate-400 group-hover:text-rose-500'}`}>{fileUploaded ? <CheckCircle size={24}/> : <Camera size={24} />}</div><div className="text-center"><span className={`block text-xs font-bold uppercase tracking-wider transition-colors ${fileUploaded ? 'text-emerald-400' : 'text-slate-500 group-hover:text-rose-400'}`}>{fileUploaded ? '–§–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ' : '–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ'}</span></div></div></button><NeonButton variant={fileUploaded ? "danger" : "disabled"} onClick={handleBuyLife} disabled={!fileUploaded}><div className="flex items-center gap-2"><span>{fileUploaded ? "–û–¢–ü–†–ê–í–ò–¢–¨" : "–°–ù–ê–ß–ê–õ–ê –§–û–¢–û"}</span>{fileUploaded && <Send size={14} />}</div></NeonButton></div>)}
                        </div>
                    </div>
                );
            };

            // --- RENDER ---
            if (step === 'loading') return null;
            if (step === 'welcome') return <WelcomeScreen onStart={() => setStep('registration')} />;
            if (step === 'registration') return <RegistrationScreen regForm={regForm} setRegForm={setRegForm} onNext={handleRegNext} />;
            if (step === 'arsenal') return <ArsenalScreen disciplines={user.disciplines} popularSports={popularSports} onToggle={handleArsenalToggle} onCustomAdd={handleArsenalCustom} onNext={() => setStep('goal')} />;
            if (step === 'goal') return <GoalScreen onSelect={handleGoalSelect} startDate={marathonStartDate} />;
            
            // --- DASHBOARD RENDER ---
            const progressPercent = Math.min((user.streak / (user.goal || 1)) * 100, 100);
            const userStats = getStatsSummary(user.history);

            return (
                <div className="pb-24 relative min-h-screen z-10">
                    {/* Header */}
                    <div className="sticky top-0 bg-[#020617]/80 backdrop-blur-xl z-20 px-6 py-4 border-b border-white/5 pt-safe-top shadow-lg">
                        <div className="flex justify-between items-start mb-4">
                            <div className="flex items-center gap-3 cursor-pointer group" onClick={() => user.isAdmin && setAdminPanelOpen(true)}>
                                <div className="relative"><Avatar name={user.firstName} />{user.isAdmin && <div className="absolute -bottom-1 -right-1 bg-amber-500 text-white rounded-full p-0.5 border-2 border-[#020617]"><Shield size={10} /></div>}</div>
                                <div><div className="font-display font-bold text-white text-lg leading-tight group-hover:text-cyan-400 transition-colors">{user.firstName}</div><div className="text-[10px] text-slate-400 font-bold uppercase tracking-wider mt-0.5">–°—Ç–∞—Ç—É—Å: <span className="text-emerald-400">{user.status === 'active' ? '–í —Å—Ç—Ä–æ—é' : '–ó–∞–º–æ—Ä–æ–∂–µ–Ω'}</span></div></div>
                            </div>
                            <div className="flex gap-2">
                                <div onClick={() => setStep('redemption')} className="bg-white/5 border border-white/10 rounded-lg px-3 py-1.5 flex items-center gap-2 cursor-pointer hover:bg-white/10 transition-colors shadow-sm"><Diamond size={16} className="text-cyan-400 fill-cyan-400" /><span className="font-display font-bold text-white text-lg">{user.diamonds}</span></div>
                                <button onClick={() => setEditingProfile(true)} className="w-10 h-10 flex items-center justify-center rounded-lg bg-white/5 border border-white/10 hover:bg-white/10 text-slate-400 transition-colors"><Settings size={18} /></button>
                            </div>
                        </div>
                        <div className="flex justify-between text-[10px] font-bold text-slate-500 mb-2 font-display uppercase tracking-widest"><span>{user.streak} Days Streak</span><span>Goal: {user.goal}</span></div>
                        <div className="w-full bg-slate-800 h-1.5 rounded-full overflow-hidden relative"><div className="bg-gradient-to-r from-cyan-500 to-purple-500 h-full shadow-[0_0_10px_rgba(34,211,238,0.5)]" style={{ width: `${progressPercent}%` }}></div></div>
                    </div>

                    {/* Main Action */}
                    <div className="p-6">
                        {isCheckedIn ? (
                            <GlassCard className="p-8 text-center bg-emerald-900/10 border-emerald-500/20">
                                <div className="inline-flex items-center justify-center w-16 h-16 rounded-full bg-emerald-500/10 mb-4 text-emerald-400 border border-emerald-500/20 shadow-[0_0_20px_rgba(52,211,153,0.2)]"><CheckCircle size={32} /></div>
                                <h3 className="text-xl font-display font-bold text-white mb-2 tracking-wide">–î–ï–ù–¨ –ó–ê–°–ß–ò–¢–ê–ù</h3>
                                <div className="flex flex-wrap justify-center gap-2 mt-2 mb-6">{user.todayActivity.map(act => <span key={act} className="px-3 py-1 bg-emerald-500/10 border border-emerald-500/20 rounded-lg text-[10px] font-bold text-emerald-400 uppercase tracking-wider shadow-sm">{act}</span>)}</div>
                                <NeonButton variant="secondary" onClick={() => setCheckInModalOpen(true)} className="py-3 text-xs"><Plus size={14} /> –î–æ–±–∞–≤–∏—Ç—å –µ—â–µ</NeonButton>
                            </GlassCard>
                        ) : (
                            <button onClick={() => setCheckInModalOpen(true)} disabled={user.diamonds <= 0} className="w-full aspect-[2/1] rounded-2xl glass-panel shadow-lg relative group overflow-hidden active:scale-[0.98] transition-all hover:border-cyan-400/50">
                                <div className="absolute inset-0 bg-gradient-to-br from-cyan-500/10 to-purple-500/10 opacity-50"></div>
                                <div className="relative z-10 flex flex-col items-center justify-center h-full gap-4">
                                    {user.diamonds > 0 ? (
                                        <><div className="w-16 h-16 rounded-full bg-cyan-500/10 text-cyan-400 flex items-center justify-center border border-cyan-500/30 group-hover:scale-110 transition-transform duration-500 shadow-[0_0_20px_rgba(34,211,238,0.2)]"><Zap size={32} className="fill-cyan-400" /></div><div className="text-center"><span className="block text-2xl font-display font-black text-white uppercase tracking-[0.2em] group-hover:text-cyan-300 transition-colors text-shadow">–û–¢–ú–ï–¢–ò–¢–¨</span><span className="text-slate-400 text-[10px] uppercase tracking-widest font-bold mt-1">–ó–∞–ø–∏—à–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å</span></div></>
                                    ) : (
                                        <><div className="w-16 h-16 rounded-full bg-red-500/10 text-red-500 flex items-center justify-center border border-red-500/30"><X size={32} /></div><div className="text-center px-6"><span className="block text-xl font-display font-black text-red-500 uppercase tracking-widest mb-1">–ó–ê–ú–û–†–û–ñ–ï–ù</span><p className="text-[10px] text-slate-500 font-bold uppercase">–ù—É–∂–µ–Ω –≤—ã–∫—É–ø.</p></div></>
                                    )}
                                </div>
                            </button>
                        )}
                    </div>

                    {/* Lists Toggle */}
                    <div className="px-6">
                        <div className="flex justify-between items-center mb-4 pl-1">
                            <h3 className="text-slate-500 uppercase text-[10px] font-bold tracking-[0.2em]">{dashboardView === 'leaderboard' ? '–†–ï–ô–¢–ò–ù–ì –ê–ì–ï–ù–¢–û–í' : '–õ–ò–ß–ù–û–ï –î–ï–õ–û'}</h3>
                            <div className="bg-slate-800/50 p-1 rounded-lg flex gap-1 border border-white/5">
                                <button onClick={() => setDashboardView('leaderboard')} className={`p-1.5 rounded-md transition-all ${dashboardView === 'leaderboard' ? 'bg-slate-700 text-white shadow-sm' : 'text-slate-500 hover:text-slate-300'}`}><Users size={14} /></button>
                                <button onClick={() => setDashboardView('progress')} className={`p-1.5 rounded-md transition-all ${dashboardView === 'progress' ? 'bg-slate-700 text-white shadow-sm' : 'text-slate-500 hover:text-slate-300'}`}><BarChart3 size={14} /></button>
                            </div>
                        </div>

                        {dashboardView === 'leaderboard' ? (
                            <div className="space-y-3">
                                {leaderboard.map((u, idx) => (
                                    <GlassCard key={u.id} onClick={() => setSelectedUser(u)} className={`p-4 flex items-center justify-between transition-colors ${u.status === 'frozen' ? 'opacity-50 grayscale' : 'hover:bg-white/5'}`}>
                                        <div className="flex items-center gap-4">
                                            <div className="relative">
                                                <Avatar name={u.name} size="w-10 h-10" />
                                                <div className="absolute -top-1 -right-1 bg-slate-900 rounded-full w-4 h-4 flex items-center justify-center text-[9px] font-bold border border-slate-700 text-white">{idx + 1}</div>
                                            </div>
                                            <div>
                                                <div className="flex items-center gap-2">
                                                    <div className={`font-bold text-slate-200 tracking-wide ${u.status === 'frozen' ? 'line-through text-slate-500' : ''}`}>{u.name}</div>
                                                    <div className="flex gap-1">{u.badges?.slice(0, 4).map(b => badgeConfig[b] && (<div key={b} className={`w-3 h-3 rounded-full flex items-center justify-center border ${badgeConfig[b].bg.replace('bg-', 'bg-').replace('/10', '/30')} ${badgeConfig[b].color}`}>{React.cloneElement(badgeConfig[b].icon, { size: 8 })}</div>))}</div>
                                                </div>
                                                <div className="flex gap-1 mt-1">{Array.from({ length: 3 }).map((_, i) => (<div key={i} className={`w-1.5 h-1.5 rotate-45 ${i < u.diamonds ? 'bg-cyan-500 shadow-[0_0_5px_rgba(34,211,238,0.8)]' : 'bg-slate-800'}`}></div>))}</div>
                                            </div>
                                        </div>
                                    </GlassCard>
                                ))}
                            </div>
                        ) : (
                            <div className="animate-fade-in space-y-6">
                                <GlassCard className="p-6">
                                    <div className="flex items-center justify-between mb-6">
                                        <div className="flex items-center gap-3"><Avatar name={user.firstName} size="w-12 h-12" /><div><div className="text-[9px] text-slate-500 font-bold uppercase tracking-widest">–†–∞–Ω–≥</div><div className="font-display font-black text-lg text-white tracking-wide">{getUserTitle(user.goal)}</div></div></div>
                                        <div className="text-right"><div className="text-[9px] text-slate-500 font-bold uppercase tracking-widest">–¶–µ–ª—å</div><div className="font-display font-black text-xl text-cyan-400">{user.goal} <span className="text-sm text-slate-500 font-sans font-normal">–î–Ω–µ–π</span></div></div>
                                    </div>
                                    <div className="grid grid-cols-2 gap-3">
                                        <div className="bg-slate-800/50 p-3 rounded-xl border border-white/5 text-center"><Ruler size={16} className="mx-auto text-cyan-500 mb-1" /><div className="font-display font-bold text-lg text-slate-200">{userStats.totalKm}</div><div className="text-[9px] text-slate-500 uppercase font-bold">–ö–ú –í—Å–µ–≥–æ</div></div>
                                        <div className="bg-slate-800/50 p-3 rounded-xl border border-white/5 text-center"><Dumbbell size={16} className="mx-auto text-purple-500 mb-1" /><div className="font-display font-bold text-lg text-slate-200">{userStats.totalReps}</div><div className="text-[9px] text-slate-500 uppercase font-bold">–ü–æ–≤—Ç–æ—Ä–µ–Ω–∏–π</div></div>
                                    </div>
                                </GlassCard>
                                <div>
                                    <div className="flex justify-between items-center mb-3 pl-1 pr-1"><h3 className="text-slate-500 uppercase text-[10px] font-bold tracking-[0.2em]">–ù–∞–≥—Ä–∞–¥—ã</h3><button onClick={() => setShowAllBadges(!showAllBadges)} className="text-[10px] font-bold text-cyan-500 hover:text-cyan-400 flex items-center gap-1 uppercase transition-colors">{showAllBadges ? '–°–∫—Ä—ã—Ç—å' : '–†–∞—Å–∫—Ä—ã—Ç—å'}{showAllBadges ? <ChevronUp size={10}/> : <ChevronDown size={10}/>}</button></div>
                                    <div className="grid gap-2 grid-cols-3">{visibleBadges.map(b => (<div key={b.id} className={`flex flex-col items-center p-3 rounded-xl border text-center transition-all ${b.condition ? 'bg-white/5 border-white/10 shadow-sm' : 'bg-slate-900/50 border-white/5 opacity-40 grayscale'}`}><div className={`w-8 h-8 rounded-full flex items-center justify-center mb-2 border bg-opacity-20 ${b.bg} ${b.color}`}>{b.icon}</div><div className="font-bold text-slate-400 text-[9px] uppercase leading-tight mb-1">{b.label}</div></div>))}</div>
                                </div>
                            </div>
                        )}
                    </div>

                    {checkInModalOpen && (
                        <div className="fixed inset-0 z-50 bg-black/60 backdrop-blur-md flex items-end sm:items-center justify-center animate-fade-in p-4"><div className="w-full max-w-md bg-[#0f172a] border border-white/10 rounded-t-3xl p-8 pb-10 sm:rounded-3xl shadow-2xl">
                            {checkInStage === 'select' ? (
                                <>
                                    <div className="flex justify-between items-center mb-8"><h3 className="text-xl font-display font-bold text-white tracking-wider">–ß–¢–û –°–î–ï–õ–ê–ù–û?</h3><button onClick={() => setCheckInModalOpen(false)} className="p-2 bg-slate-800 rounded-full hover:bg-slate-700 text-white"><X size={20} /></button></div>
                                    <div className="grid grid-cols-1 gap-3">
                                        {user.disciplines.map(sport => (<button key={sport} onClick={() => initCheckIn(sport)} className="py-4 rounded-xl font-bold transition-all border bg-slate-800/50 text-slate-300 border-white/5 hover:bg-cyan-500/10 hover:border-cyan-500/30 hover:text-cyan-400 flex justify-between px-6 shadow-sm"><span>{sport}</span>{user.todayActivity.includes(sport) && <span className="text-emerald-400">‚úì</span>}</button>))}
                                        <div className="mt-6 text-center"><button onClick={() => { setCheckInModalOpen(false); setEditingProfile(true); }} className="text-xs font-bold text-slate-500 uppercase tracking-widest hover:text-cyan-400 transition-colors">–î–æ–±–∞–≤–∏—Ç—å –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—É</button></div>
                                    </div>
                                </>
                            ) : (
                                <div className="animate-slide-up">
                                    <div className="flex justify-between items-center mb-8"><button onClick={() => setCheckInStage('select')} className="text-slate-500 text-xs font-bold uppercase tracking-widest hover:text-white transition-colors">‚Üê –ù–∞–∑–∞–¥</button><h3 className="text-xl font-display font-bold text-white tracking-wider">{selectedSportForCheckIn}</h3><div className="w-8"></div></div>
                                    {getSportType(selectedSportForCheckIn) === 'gym' && <div className="grid grid-cols-2 gap-3">{['–í—Å—ë —Ç–µ–ª–æ', '–í–µ—Ä—Ö', '–ù–∏–∑', '–ì–æ–ª–æ–≤–∞'].map(s => <button key={s} onClick={() => completeCheckIn(selectedSportForCheckIn, s, null)} className="py-6 rounded-xl bg-slate-800/50 border border-white/5 hover:bg-cyan-500/10 hover:border-cyan-500/30 hover:text-cyan-400 text-slate-300 font-bold transition-all shadow-sm">{s === '–ì–æ–ª–æ–≤–∞' ? 'ü§™ –ì–æ–ª–æ–≤–æ–π' : s}</button>)}</div>}
                                    {getSportType(selectedSportForCheckIn) === 'reps' && <div className="grid grid-cols-2 gap-3">{[30, 60, 100, 200].map(r => <button key={r} onClick={() => completeCheckIn(selectedSportForCheckIn, r, '–ø–æ–≤—Ç')} className="py-6 rounded-xl bg-slate-800/50 border border-white/5 hover:bg-cyan-500/10 hover:border-cyan-500/30 hover:text-cyan-400 font-display font-black text-2xl text-slate-300 transition-all shadow-sm">{r}</button>)}</div>}
                                    {getSportType(selectedSportForCheckIn) === 'cardio' && <div className="space-y-8 flex flex-col items-center"><div className="flex items-end gap-2"><input type="number" autoFocus placeholder="0" className="text-center text-7xl font-display font-black text-white w-40 bg-transparent outline-none border-b-2 border-slate-700 focus:border-cyan-500 transition-colors pb-2" onChange={(e) => setCheckInValue(e.target.value)} /><span className="text-xl font-bold text-slate-500 pb-4">–ö–ú</span></div><NeonButton onClick={() => completeCheckIn(selectedSportForCheckIn, checkInValue, '–∫–º')} disabled={!checkInValue} variant={checkInValue ? 'primary' : 'disabled'}>–ó–∞–ø–∏—Å–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç</NeonButton></div>}
                                </div>
                            )}
                        </div></div>
                    )}

                    {editingProfile && (
                        <div className="fixed inset-0 z-50 bg-[#020617] p-6 animate-fade-in overflow-y-auto pt-safe-top">
                            <div className="flex justify-between items-center mb-8"><h2 className="text-2xl font-display font-bold text-white tracking-wider">–ù–ê–°–¢–†–û–ô–ö–ò</h2><button onClick={() => setEditingProfile(false)} className="p-2 bg-white/5 rounded-full shadow-sm border border-white/10 text-white"><X size={20} /></button></div>
                            <div className="space-y-8">
                                <GlassCard className="p-4 flex justify-between items-center"><div className="flex items-center gap-3"><div className="w-10 h-10 rounded-full bg-cyan-500/10 flex items-center justify-center text-cyan-400"><Bell size={20} /></div><div><div className="font-bold text-slate-200">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div><div className="text-xs text-slate-500">–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–µ</div></div></div><ToggleSwitch checked={user.notifications} onChange={(val) => setUser({...user, notifications: val})} /></GlassCard>
                                <div><label className="text-slate-500 text-xs font-bold uppercase tracking-widest mb-4 block px-1">–¢–≤–æ–∏ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã</label><div className="flex flex-wrap gap-2">{popularSports.map(s => <button key={s} onClick={() => toggleDiscipline(s)} className={`px-4 py-2 rounded-lg text-xs font-bold border transition-all ${user.disciplines.includes(s) ? 'bg-cyan-600/50 text-white border-cyan-500/50 shadow-sm' : 'bg-white/5 border-white/10 text-slate-400 hover:border-cyan-500/30 hover:text-cyan-400'}`}>{s}</button>)}{!isAddingCustom ? <button onClick={() => setIsAddingCustom(true)} className="px-4 py-2 rounded-lg text-xs font-bold border border-dashed border-slate-700 text-slate-500 hover:border-cyan-500 hover:text-cyan-400 bg-transparent flex items-center gap-2 transition-colors"><Plus size={14} /> –°–≤–æ—è</button> : <div className="flex items-center gap-2 mt-2 sm:mt-0"><input type="text" value={customInput} onChange={(e) => setCustomInput(e.target.value)} className="px-3 py-2 rounded-lg bg-slate-800 border border-cyan-500 outline-none text-white text-xs w-32 focus:ring-1 focus:ring-cyan-500" autoFocus onKeyDown={(e) => e.key === 'Enter' && handleAddCustom()} /><button onClick={handleAddCustom} className="p-2 bg-cyan-600 text-white rounded-lg shadow-sm hover:bg-cyan-700"><CheckCircle size={14}/></button></div>}</div></div>
                                <div className="pb-10"><label className="text-slate-500 text-xs font-bold uppercase tracking-widest mb-4 block px-1">–¶–µ–ª—å</label><div className="flex gap-2 bg-slate-900 p-1.5 rounded-xl border border-white/5">{[30, 60, 100].map(d => <button key={d} onClick={() => setUser({...user, goal: d})} className={`flex-1 py-2.5 rounded-lg text-sm font-bold transition-all ${user.goal === d ? 'bg-cyan-600 text-white shadow-lg' : 'text-slate-500 hover:bg-white/5'}`}>{d}</button>)}</div></div>
                            </div>
                            <div className="sticky bottom-6"><NeonButton onClick={() => setEditingProfile(false)}>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</NeonButton></div>
                        </div>
                    )}

                    {step === 'redemption' && <RedemptionShop />}
                    
                    {showConfetti && (
                       <div className="fixed inset-0 pointer-events-none flex items-center justify-center z-50 overflow-hidden"><div className="text-6xl animate-bounce">üíé</div><div className="absolute top-20 left-10 text-4xl animate-pulse text-cyan-500">‚ú®</div><div className="absolute bottom-40 right-10 text-5xl animate-spin text-purple-500">üí†</div></div>
                    )}
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
